<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <title>NovaOS UltraPlus PL — Office + VM + Discover (Single‑File)</title>
  <style>
    :root{
      --taskbar-h: 56px;
      --radius: 14px;
      --radius-sm: 10px;
      --shadow: 0 18px 45px rgba(0,0,0,.35);
      --shadow-soft: 0 12px 28px rgba(0,0,0,.25);
      --border: rgba(255,255,255,.14);
      --border-strong: rgba(255,255,255,.22);
      --glass: rgba(22, 22, 26, .72);
      --glass-2: rgba(22, 22, 26, .58);
      --fg: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted-2: rgba(255,255,255,.55);
      --bg: #0b0c10;
      --panel: rgba(20, 20, 24, .82);
      --panel-2: rgba(28, 28, 34, .80);
      --input: rgba(255,255,255,.08);
      --input-2: rgba(255,255,255,.12);
      --danger: #ff5b5b;
      --ok: #49d17c;
      --warn: #ffca3a;
      --accent: #4a8cff;
      --accent-2: rgba(74,140,255,.20);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    [data-theme="light"]{
      --border: rgba(0,0,0,.10);
      --border-strong: rgba(0,0,0,.16);
      --glass: rgba(255,255,255,.75);
      --glass-2: rgba(255,255,255,.62);
      --fg: rgba(16,16,18,.92);
      --muted: rgba(16,16,18,.68);
      --muted-2: rgba(16,16,18,.55);
      --bg: #f3f5fb;
      --panel: rgba(255,255,255,.82);
      --panel-2: rgba(255,255,255,.86);
      --input: rgba(0,0,0,.06);
      --input-2: rgba(0,0,0,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.18);
      --shadow-soft: 0 12px 28px rgba(0,0,0,.14);
      --accent-2: rgba(74,140,255,.14);
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--ui);
      background: var(--bg);
      color: var(--fg);
      overflow:hidden;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
      touch-action: manipulation;
    }
    .sr-only{
      position:absolute; width:1px; height:1px; padding:0; margin:-1px;
      overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
    }

    /* Boot */
    #boot{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1200px 800px at 30% 25%, rgba(74,140,255,.30), transparent 60%),
                  radial-gradient(900px 700px at 70% 70%, rgba(73,209,124,.20), transparent 60%),
                  linear-gradient(180deg, #07070a, #0b0c10);
      color:rgba(255,255,255,.92);
      z-index:99999;
    }
    [data-theme="light"] #boot{
      background: radial-gradient(1200px 800px at 30% 25%, rgba(74,140,255,.20), transparent 60%),
                  radial-gradient(900px 700px at 70% 70%, rgba(73,209,124,.14), transparent 60%),
                  linear-gradient(180deg, #f5f7ff, #eef2fb);
      color:rgba(16,16,18,.92);
    }
    .bootCard{
      width:min(620px, 92vw);
      padding:24px;
      border-radius: 18px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      text-align:center;
    }
    [data-theme="light"] .bootCard{
      background: rgba(255,255,255,.62);
      border:1px solid rgba(0,0,0,.10);
    }
    .logoRow{display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:10px;}
    .logoMark{
      width:44px; height:44px; border-radius: 14px;
      background: linear-gradient(135deg, var(--accent), rgba(73,209,124,.75));
      box-shadow: 0 10px 30px rgba(74,140,255,.22);
    }
    .bootTitle{font-weight: 720; letter-spacing:.2px; font-size: 20px;}
    .bootSub{opacity:.78; font-size: 14px; margin-top:6px; line-height:1.35;}
    .progress{
      height:12px; border-radius: 999px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
      margin:18px 0 8px;
    }
    [data-theme="light"] .progress{
      background: rgba(0,0,0,.06);
      border:1px solid rgba(0,0,0,.10);
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), rgba(73,209,124,.95));
      border-radius: 999px;
      transition: width .26s ease;
    }
    .bootHint{opacity:.72; font-size: 12px;}

    /* Layout */
    #os{
      position:fixed; inset:0;
      display:grid;
      grid-template-rows: 1fr var(--taskbar-h);
    }
    #desktop{
      position:relative;
      overflow:hidden;
    }
    #wallpaper{
      position:absolute; inset:0;
      background: radial-gradient(1200px 900px at 20% 30%, rgba(74,140,255,.26), transparent 65%),
                  radial-gradient(1100px 900px at 80% 70%, rgba(255,80,180,.16), transparent 65%),
                  radial-gradient(900px 700px at 60% 20%, rgba(73,209,124,.14), transparent 60%),
                  linear-gradient(180deg, #07070a, #0b0c10);
      filter: saturate(1.05) contrast(1.02);
      transform: scale(1.02);
    }
    [data-theme="light"] #wallpaper{
      background: radial-gradient(1200px 900px at 20% 30%, rgba(74,140,255,.16), transparent 65%),
                  radial-gradient(1100px 900px at 80% 70%, rgba(255,80,180,.10), transparent 65%),
                  radial-gradient(900px 700px at 60% 20%, rgba(73,209,124,.10), transparent 60%),
                  linear-gradient(180deg, #f4f7ff, #eef2fb);
    }
    #workspace{
      position:absolute; inset:0;
    }
    #desktopIcons{
      position:absolute;
      left:12px; top:12px;
      display:flex; flex-direction:column;
      gap:10px;
      z-index:2;
    }
    .deskIcon{
      width:92px;
      padding:10px 8px 8px;
      border-radius: 14px;
      cursor:default;
      text-align:center;
      background: transparent;
      border: 1px solid transparent;
      color: var(--fg);
      user-select:none;
      -webkit-user-select:none;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
    }
    .deskIcon:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.10);
    }
    [data-theme="light"] .deskIcon:hover{
      background: rgba(0,0,0,.05);
      border-color: rgba(0,0,0,.08);
    }
    .deskIcon:active{ transform: scale(.985); }
    .deskIcon .ico{
      width:36px; height:36px;
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 12px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-soft);
    }
    [data-theme="light"] .deskIcon .ico{
      background: rgba(255,255,255,.68);
      border:1px solid rgba(0,0,0,.10);
    }
    .deskIcon .label{
      margin-top:8px;
      font-size: 12px;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      opacity:.92;
      text-shadow: 0 1px 12px rgba(0,0,0,.40);
    }
    [data-theme="light"] .deskIcon .label{
      text-shadow: 0 1px 12px rgba(255,255,255,.75);
    }

    /* Taskbar */
    #taskbar{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      gap:10px;
      background: var(--glass);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      z-index: 9000;
    }
    .taskLeft,.taskCenter,.taskRight{
      display:flex; align-items:center; gap:8px;
      min-width: 0;
    }
    .taskCenter{flex:1; justify-content:center; min-width: 0;}
    .taskRight{justify-content:flex-end;}

    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--fg);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      line-height: 1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      cursor:default;
      user-select:none;
      -webkit-user-select:none;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      min-height: 38px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); border-color: var(--border-strong); }
    [data-theme="light"] .btn:hover{ background: rgba(0,0,0,.06); }
    .btn:active{ transform: scale(.985); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(74,140,255,.88), rgba(74,140,255,.55));
      border-color: rgba(74,140,255,.55);
      box-shadow: 0 10px 28px rgba(74,140,255,.18);
    }
    .btn.primary:hover{
      background: linear-gradient(135deg, rgba(74,140,255,.98), rgba(74,140,255,.62));
      border-color: rgba(74,140,255,.72);
    }
    .btn.danger{
      background: rgba(255,91,91,.16);
      border-color: rgba(255,91,91,.35);
    }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
    }
    .btn.ghost:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.10);
    }
    [data-theme="light"] .btn.ghost:hover{
      background: rgba(0,0,0,.05);
      border-color: rgba(0,0,0,.08);
    }

    .pill{
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      opacity: .95;
      max-width: 40vw;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .taskIcons{
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:nowrap;
      overflow:auto;
      scrollbar-width: none;
      max-width:min(680px, 62vw);
    }
    .taskIcons::-webkit-scrollbar{display:none;}
    .taskApp{
      width:44px; height:44px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:default;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      position:relative;
      flex: 0 0 auto;
    }
    .taskApp:hover{ background: rgba(255,255,255,.10); border-color: var(--border-strong); }
    [data-theme="light"] .taskApp:hover{ background: rgba(0,0,0,.06); }
    .taskApp:active{ transform: scale(.985); }
    .taskApp.active{
      border-color: rgba(74,140,255,.55);
      box-shadow: 0 10px 26px rgba(74,140,255,.14);
    }
    .taskApp .dot{
      position:absolute;
      bottom:4px; left:50%;
      transform: translateX(-50%);
      width:18px; height:3px;
      border-radius:999px;
      background: rgba(255,255,255,.62);
      opacity: .85;
    }
    [data-theme="light"] .taskApp .dot{ background: rgba(16,16,18,.52); }

    /* Start menu */
    #startMenu{
      position:absolute;
      left:10px;
      bottom: calc(var(--taskbar-h) + 10px);
      width: min(420px, calc(100vw - 20px));
      height: min(560px, calc(100vh - var(--taskbar-h) - 28px));
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      z-index: 9500;
    }
    #startMenu.hidden{ display:none; }
    .startTop{
      padding:12px 12px 8px;
      border-bottom: 1px solid var(--border);
      display:flex; align-items:center; gap:10px;
    }
    .searchBox{
      flex:1;
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: var(--input);
      border: 1px solid var(--border);
    }
    .searchBox input{
      width:100%;
      border:none;
      outline:none;
      font-size: 14px;
      background: transparent;
      color: var(--fg);
    }
    .searchBox input::placeholder{ color: var(--muted-2); }
    .startBody{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
      overflow:auto;
    }
    .sectionTitle{
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      opacity:.70;
      margin: 2px 0 10px;
    }
    .appGrid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .appTile{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px 10px 9px;
      cursor:default;
      display:flex;
      flex-direction:column;
      gap:8px;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      min-height: 78px;
    }
    .appTile:hover{ background: rgba(255,255,255,.10); border-color: var(--border-strong); }
    [data-theme="light"] .appTile:hover{ background: rgba(0,0,0,.06); }
    .appTile:active{ transform: scale(.985); }
    .appTile .ico{
      width:38px; height:38px;
      border-radius: 14px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(0,0,0,.15);
    }
    [data-theme="light"] .appTile .ico{ background: rgba(255,255,255,.70); }
    .appTile .name{
      font-size: 13px;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .miniList{
      display:flex; flex-direction:column; gap:8px;
    }
    .miniItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:default;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      transition: background .15s ease, border-color .15s ease;
    }
    .miniItem:hover{ background: rgba(255,255,255,.09); border-color: var(--border-strong); }
    [data-theme="light"] .miniItem:hover{ background: rgba(0,0,0,.06); }
    .miniItem .left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .miniItem .title{
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 240px;
    }
    .miniItem .sub{
      font-size: 12px;
      opacity: .70;
      margin-top: 2px;
    }
    .startBottom{
      padding:10px 12px;
      border-top:1px solid var(--border);
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }

    /* Window system */
    .window{
      position:absolute;
      width: 720px;
      height: 460px;
      min-width: 360px;
      min-height: 240px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      z-index: 100;
    }
    .window.maximized{
      left:10px !important;
      top:10px !important;
      width: calc(100% - 20px) !important;
      height: calc(100% - 20px) !important;
      border-radius: 22px;
    }
    .titlebar{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      cursor:grab;
    }
    .titlebar:active{ cursor:grabbing; }
    .titlebar .appIco{
      width:26px; height:26px;
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    [data-theme="light"] .titlebar .appIco{ background: rgba(255,255,255,.75); }
    .titlebar .title{
      font-size: 13px;
      font-weight: 650;
      letter-spacing: .1px;
      flex: 1;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .winControls{ display:flex; gap:8px; }
    .winBtn{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:default;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
    }
    .winBtn:hover{ background: rgba(255,255,255,.10); border-color: var(--border-strong); }
    [data-theme="light"] .winBtn:hover{ background: rgba(0,0,0,.06); }
    .winBtn:active{ transform: scale(.985); }
    .winBtn.close:hover{
      background: rgba(255,91,91,.18);
      border-color: rgba(255,91,91,.35);
    }
    .winBody{
      position:relative;
      flex:1;
      overflow:auto;
    }
    .resizer{
      position:absolute;
      width:18px; height:18px;
      right: 6px; bottom: 6px;
      border-radius: 6px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--border);
      cursor:nwse-resize;
    }
    .window.maximized .resizer{ display:none; }
    .window.minimized{ display:none; }

    /* App common UI */
    .appPad{ padding: 14px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .col{ display:flex; flex-direction:column; gap:10px; }
    .wrap{ flex-wrap:wrap; }
    .grow{ flex:1; min-width:0; }
    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding: 12px;
    }
    .cardTitle{
      font-weight: 720;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .muted{ color: var(--muted); }
    .muted2{ color: var(--muted-2); }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: 2px 7px;
      border-radius: 9px;
      opacity: .92;
    }
    .hr{
      height:1px; background: var(--border);
      margin: 12px 0;
    }
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    .input, select, textarea{
      font-family: var(--ui);
      font-size: 13px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--border);
      background: var(--input);
      color: var(--fg);
      outline:none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    .input:focus, select:focus, textarea:focus{
      border-color: rgba(74,140,255,.65);
      box-shadow: 0 0 0 4px var(--accent-2);
    }
    .hint{ font-size: 12px; color: var(--muted); line-height:1.35; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 5px 9px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
    }
    .badge.ok{ border-color: rgba(73,209,124,.45); background: rgba(73,209,124,.12); }
    .badge.warn{ border-color: rgba(255,202,58,.45); background: rgba(255,202,58,.12); }
    .badge.bad{ border-color: rgba(255,91,91,.45); background: rgba(255,91,91,.12); }

    /* Toasts */
    #toastArea{
      position:absolute;
      right: 12px;
      bottom: calc(var(--taskbar-h) + 12px);
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index: 9999;
      pointer-events:none;
    }
    .toast{
      width:min(360px, calc(100vw - 24px));
      border-radius: 16px;
      border:1px solid var(--border);
      background: var(--glass);
      box-shadow: var(--shadow-soft);
      padding: 10px 12px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      pointer-events:auto;
    }
    .toast .tTitle{ font-weight: 720; font-size: 13px; margin-bottom: 4px; }
    .toast .tMsg{ font-size: 13px; opacity:.85; line-height:1.35; }
    .toast .tRow{ display:flex; gap:8px; justify-content:space-between; align-items:center; }
    .toast .tClose{ border:1px solid var(--border); background: rgba(255,255,255,.06); border-radius: 12px; padding: 7px 10px; font-size: 12px; cursor:default; }

    /* Modal */
    #modalArea{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      z-index: 999999;
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    #modalArea.active{ display:flex; }
    .modal{
      width:min(680px, 92vw);
      max-height: min(80vh, 740px);
      overflow:auto;
      background: var(--panel);
      border:1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
    }
    .modalHead{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalTitle{ font-weight: 740; font-size: 14px; }
    .modalBody{ padding: 14px; }
    .modalFoot{
      padding: 12px 14px;
      border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:10px; align-items:center;
    }

    /* File manager */
    .fm{
      height:100%;
      display:grid;
      grid-template-columns: 230px 1fr;
    }
    .fmNav{
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding: 12px;
      overflow:auto;
    }
    .fmMain{
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .fmBar{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex; gap:8px; align-items:center;
      flex-wrap:wrap;
    }
    .crumb{
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      cursor:default;
    }
    .fmList{
      padding: 10px 12px;
      overflow:auto;
      flex:1;
    }
    .fileRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid transparent;
      cursor:default;
    }
    .fileRow:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.08);
    }
    [data-theme="light"] .fileRow:hover{
      background: rgba(0,0,0,.05);
      border-color: rgba(0,0,0,.08);
    }
    .fileRow .left{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .fileRow .fname{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 44vw;
    }
    .fileRow .meta{
      font-size: 12px;
      opacity: .70;
      white-space:nowrap;
    }

    /* Terminal */
    .term{
      height:100%;
      display:flex;
      flex-direction:column;
      background: rgba(0,0,0,.20);
    }
    [data-theme="light"] .term{
      background: rgba(255,255,255,.66);
    }
    .termOut{
      flex:1;
      padding: 12px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 13px;
      line-height:1.35;
      user-select:text;
      -webkit-user-select:text;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .termIn{
      border-top:1px solid var(--border);
      padding: 10px 12px;
      display:flex; gap:10px; align-items:center;
      font-family: var(--mono);
    }
    .prompt{
      opacity:.85;
    }
    .termIn input{
      flex:1;
      background: transparent;
      border:none;
      outline:none;
      color: var(--fg);
      font-family: var(--mono);
      font-size: 13px;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
    }

    /* Writer */
    .writerBar{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background: rgba(255,255,255,.03);
    }
    .writerEditor{
      padding: 14px;
      min-height: 100%;
      outline:none;
      user-select:text;
      -webkit-user-select:text;
    }
    .writerPaper{
      max-width: 980px;
      margin: 0 auto;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      padding: 18px 18px 20px;
    }
    [data-theme="light"] .writerPaper{
      background: rgba(255,255,255,.85);
    }
    .writerPaper h1,.writerPaper h2,.writerPaper h3{ margin: .6em 0 .35em; }
    .writerPaper p{ margin: .55em 0; }

    /* Sheets */
    .sheetBar{
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background: rgba(255,255,255,.03);
    }
    .sheetWrap{
      padding: 12px;
      overflow:auto;
    }
    table.sheet{
      border-collapse: separate;
      border-spacing: 0;
      font-size: 12px;
      min-width: 820px;
      background: rgba(255,255,255,.03);
      border:1px solid var(--border);
      border-radius: 14px;
      overflow:hidden;
    }
    table.sheet th, table.sheet td{
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 6px 8px;
      min-width: 96px;
      max-width: 180px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    table.sheet th{
      position:sticky;
      top:0;
      z-index:2;
      background: rgba(255,255,255,.06);
      font-weight: 700;
      text-align:left;
    }
    table.sheet th.first{
      left:0;
      z-index:3;
      position:sticky;
    }
    table.sheet td.rowHead{
      position:sticky;
      left:0;
      z-index:1;
      background: rgba(255,255,255,.04);
      font-weight: 650;
    }
    table.sheet td.cell{
      cursor: text;
      user-select:text;
      -webkit-user-select:text;
    }
    table.sheet td.cell:focus{
      outline:none;
      box-shadow: inset 0 0 0 2px rgba(74,140,255,.75);
      background: rgba(74,140,255,.10);
    }
    .cellFormula{
      font-family: var(--mono);
      opacity:.92;
    }

    /* Slides */
    .slides{
      height:100%;
      display:grid;
      grid-template-columns: 240px 1fr;
    }
    .slidesNav{
      border-right: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      padding: 12px;
      overflow:auto;
    }
    .slideThumb{
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      padding:10px;
      margin-bottom: 10px;
      cursor:default;
    }
    .slideThumb.active{
      border-color: rgba(74,140,255,.65);
      box-shadow: 0 10px 22px rgba(74,140,255,.12);
    }
    .slideThumb .t{ font-weight: 720; font-size: 13px; margin-bottom: 4px; }
    .slideThumb .b{ font-size: 12px; opacity:.72; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }
    .slidesMain{
      display:flex; flex-direction:column;
      overflow:hidden;
    }
    .slidesBar{
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      background: rgba(255,255,255,.03);
    }
    .slideCanvasWrap{
      padding: 14px;
      overflow:auto;
      flex:1;
    }
    .slideCanvas{
      width: min(980px, 100%);
      aspect-ratio: 16/9;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      box-shadow: var(--shadow-soft);
      padding: 18px;
      margin: 0 auto;
    }
    [data-theme="light"] .slideCanvas{
      background: rgba(255,255,255,.88);
    }
    .slideCanvas h2{ margin:0 0 12px; }
    .slideCanvas ul{ margin:0; padding-left: 18px; }
    .presentOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.92);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 1000000;
    }
    .presentOverlay.active{ display:flex; }
    .presentSlide{
      width: min(1200px, 96vw);
      aspect-ratio: 16/9;
      border-radius: 22px;
      background: #ffffff;
      color:#111;
      padding: 34px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .presentSlide h1{
      margin:0 0 14px;
      font-size: 44px;
      letter-spacing: -0.02em;
    }
    .presentSlide li{ font-size: 28px; margin: 10px 0; }
    .presentHint{
      position:fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,.78);
      font-size: 12px;
      display:none;
    }
    .presentOverlay.active + .presentHint{ display:block; }

    /* Small screens: auto-maximize windows */
    @media (max-width: 720px){
      :root{ --taskbar-h: 62px; }
      #desktopIcons{ flex-direction:row; flex-wrap:wrap; width: calc(100% - 24px); }
      .deskIcon{ width: 96px; }
      .appGrid{ grid-template-columns: repeat(2, 1fr); }
      .fm{ grid-template-columns: 1fr; }
      .fmNav{ display:none; }
      .slides{ grid-template-columns: 1fr; }
      .slidesNav{ display:none; }
    }
  
    /* --- Enhancements: desktops + snapping + overlays --- */
    .hideSm{ display:inline; }
    @media (max-width: 640px){
      .hideSm{ display:none; }
    }
    .window.hiddenDesk{ display:none !important; }

    .snapPreview{
      position:fixed;
      z-index: 999998;
      border-radius: 18px;
      border: 2px dashed rgba(255,255,255,.35);
      background: rgba(255,255,255,.08);
      pointer-events:none;
      box-shadow: 0 0 0 1px rgba(0,0,0,.25) inset;
    }
    .snapPreview.hidden{ display:none; }

    .altTabOverlay{
      position:fixed; inset:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top: 64px;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 999997;
      pointer-events:none;
    }
    .altTabOverlay.hidden{ display:none; }
    .altTabStrip{
      display:flex;
      gap:10px;
      background: rgba(20,20,20,.72);
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px;
      border-radius: 18px;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
    }
    .altItem{
      width: 120px;
      min-height: 74px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-start;
      justify-content:center;
      padding: 10px;
    }
    .altItem.active{
      border-color: rgba(74,140,255,.65);
      box-shadow: 0 0 0 2px rgba(74,140,255,.18) inset;
    }
    .altItem .top{ display:flex; gap:8px; align-items:center; }
    .altItem .name{ font-size: 12px; font-weight: 700; max-width: 90px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .altItem .sub{ font-size: 11px; opacity: .75; max-width: 110px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .spotlightOverlay{
      position:fixed; inset:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding-top: 84px;
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 999999;
    }
    .spotlightOverlay.hidden{ display:none; }
    .spotlight{
      width: min(720px, 92vw);
      background: rgba(20,20,20,.86);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 22px;
      padding: 14px;
      box-shadow: 0 30px 90px rgba(0,0,0,.65);
    }

    .ctxMenu{
      position:fixed;
      min-width: 220px;
      background: rgba(24,24,24,.96);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 8px;
      z-index: 999999;
      box-shadow: 0 24px 70px rgba(0,0,0,.55);
    }
    .ctxMenu.hidden{ display:none; }
    .ctxItem{
      width:100%;
      text-align:left;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      background: transparent;
      color: var(--fg);
      cursor:pointer;
      font-size: 13px;
    }
    .ctxItem:hover{
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.12);
    }
    .ctxSep{ height:1px; background: rgba(255,255,255,.10); margin: 6px 2px; }

    /* Resize handles (8-way) */
    .rHandle{
      position:absolute;
      z-index: 10;
      background: transparent;
    }
    .rHandle.n, .rHandle.s{ left:12px; right:12px; height:10px; cursor: ns-resize; }
    .rHandle.n{ top:-4px; }
    .rHandle.s{ bottom:-4px; }
    .rHandle.e, .rHandle.w{ top:12px; bottom:12px; width:10px; cursor: ew-resize; }
    .rHandle.e{ right:-4px; }
    .rHandle.w{ left:-4px; }
    .rHandle.nw, .rHandle.ne, .rHandle.sw, .rHandle.se{
      width:16px; height:16px;
    }
    .rHandle.nw{ left:-6px; top:-6px; cursor: nwse-resize; }
    .rHandle.se{ right:-6px; bottom:-6px; cursor: nwse-resize; }
    .rHandle.ne{ right:-6px; top:-6px; cursor: nesw-resize; }
    .rHandle.sw{ left:-6px; bottom:-6px; cursor: nesw-resize; }

</style>
</head>
<body>
  <div id="boot" aria-live="polite">
    <div class="bootCard">
      <div class="logoRow">
        <div class="logoMark" aria-hidden="true"></div>
        <div class="bootTitle" id="bootTitle">WebOS Desktop</div>
      </div>
      <div class="bootSub" id="bootSub">A single‑file, Zorin/Windows‑like web desktop with Office, Discover, Terminal, and VM Hub.</div>
      <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="bar" id="bootBar"></div>
      </div>
      <div class="bootHint" id="bootHint">Loading local storage + file system…</div>
    </div>
  </div>

  <div id="os" hidden>
    <div id="desktop">
      <div id="wallpaper"></div>
      <div id="desktopIcons" aria-label="Desktop icons"></div>
      <div id="workspace" aria-label="Workspace"></div>
      <div id="toastArea" aria-live="polite"></div>
    </div>

    <div id="taskbar" role="navigation" aria-label="Taskbar">
      <div class="taskLeft">
        <button class="btn primary" id="startBtn" title="Start">
          <span id="startBtnIco" aria-hidden="true"></span>
          <span id="startBtnText">Start</span>
        </button>
        <button class="btn ghost" id="showDesktopBtn" title="Show desktop">
          <span id="showDeskIco" aria-hidden="true"></span>
        </button>
        <button class="btn ghost" id="desktopBtn" title="Desktops">
          <span id="deskIco" aria-hidden="true"></span>
          <span id="deskText" class="hideSm">Desk</span>
        </button>
      </div>

      <div class="taskCenter">
        <div class="taskIcons" id="taskIcons" aria-label="Pinned and running apps"></div>
      </div>

      <div class="taskRight">
        <div class="pill" id="netPill" title="This is a browser-based desktop UI (not a real OS kernel)">
          Web desktop
        </div>
        <button class="btn" id="clockBtn" title="Clock">
          <span id="clockText">--:--</span>
        </button>
      </div>
    </div>

    <div id="startMenu" class="hidden" role="dialog" aria-label="Start menu">
      <div class="startTop">
        <div class="searchBox">
          <span id="searchIco" aria-hidden="true"></span>
          <input id="startSearch" type="text" placeholder="Search apps…" autocomplete="off" />
        </div>
        <button class="btn" id="powerBtn" title="Power / reset">⟲</button>
      </div>
      <div class="startBody" id="startBody">
        <!-- filled by JS -->
      </div>
      <div class="startBottom">
        <div class="row" style="gap:10px; min-width:0;">
          <span class="badge" id="userBadge"><span id="userIco" aria-hidden="true"></span><span id="userName">user</span></span>
          <span class="badge" id="langBadge" title="Language"><span id="langIco" aria-hidden="true"></span><span id="langText">EN</span></span>
        </div>
        <div class="row">
          <button class="btn" id="settingsQuickBtn"><span id="settingsIco2" aria-hidden="true"></span><span id="settingsQuickText">Settings</span></button>
        </div>
      </div>
    </div>

    <div id="modalArea" aria-hidden="true"></div>
    <div id="snapPreview" class="snapPreview hidden" aria-hidden="true"></div>
    <div id="altTabOverlay" class="altTabOverlay hidden" aria-hidden="true"></div>
    <div id="spotlightOverlay" class="spotlightOverlay hidden" aria-hidden="true">
      <div class="spotlight">
        <div class="searchBox" style="width:100%;">
          <span id="spotIco" aria-hidden="true"></span>
          <input id="spotInput" type="text" placeholder="Search…" autocomplete="off" />
        </div>
        <div id="spotResults" class="miniList" style="margin-top:10px;"></div>
        <div class="hint" style="margin-top:10px;" id="spotHint">Enter = open • Esc = close</div>
      </div>
    </div>
    <div id="ctxMenu" class="ctxMenu hidden" aria-hidden="true"></div>

  </div>

  <div class="presentOverlay" id="presentOverlay" aria-hidden="true"></div>
  <div class="presentHint" id="presentHint">Esc = exit • ←/→ = prev/next</div>

  <script>
  (() => {
    "use strict";

    /* ---------- Utilities ---------- */
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const isSmall = () => window.matchMedia("(max-width: 720px)").matches;

    const safeText = (s) => String(s ?? "").replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));

    /* ---------- Icons (inline SVG) ---------- */
    const Icons = {
      start: svg(`<path d="M4 4h8v8H4z"/><path d="M14 4h6v8h-6z"/><path d="M4 14h6v6H4z"/><path d="M12 14h8v6h-8z"/>`),
      desk: svg(`<path d="M4 6h16v10H4z"/><path d="M8 18h8v2H8z"/>`),
      user: svg(`<path d="M12 12a4 4 0 1 0-0.001-8A4 4 0 0 0 12 12z"/><path d="M4 20c1.7-4.4 14.3-4.4 16 0"/>`),
      lang: svg(`<path d="M4 5h10v2H4z"/><path d="M4 9h7v2H4z"/><path d="M4 13h10v2H4z"/><path d="M18 5c-1 4-2 6-5 9"/><path d="M14 7h6"/><path d="M15 15l4 6"/><path d="M11 14l4-3"/>`),
      settings: svg(`<path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/><path d="M4 12h2"/><path d="M18 12h2"/><path d="M12 4v2"/><path d="M12 18v2"/><path d="M6.2 6.2l1.4 1.4"/><path d="M16.4 16.4l1.4 1.4"/><path d="M17.8 6.2l-1.4 1.4"/><path d="M7.6 16.4l-1.4 1.4"/>`),
      folder: svg(`<path d="M3 6h7l2 2h9v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>`),
      terminal: svg(`<path d="M4 6h16v12H4z"/><path d="M7 10l3 2-3 2"/><path d="M11 14h6"/>`),
      store: svg(`<path d="M6 6h12l-1 14H7z"/><path d="M9 6V4a3 3 0 0 1 6 0v2"/><path d="M8 10h0.01"/><path d="M16 10h0.01"/>`),
      doc: svg(`<path d="M6 3h9l3 3v15H6z"/><path d="M9 10h6"/><path d="M9 14h6"/><path d="M9 18h6"/>`),
      sheet: svg(`<path d="M6 3h12v18H6z"/><path d="M6 8h12"/><path d="M6 13h12"/><path d="M10 8v13"/><path d="M14 8v13"/>`),
      slides: svg(`<path d="M4 5h16v10H4z"/><path d="M8 19h8"/><path d="M12 15v4"/>`),
      vm: svg(`<path d="M4 6h16v10H4z"/><path d="M8 20h8"/><path d="M7 16h10"/>`),
      help: svg(`<path d="M12 18h0.01"/><path d="M9 9a3 3 0 1 1 3 3c0 2-1 2-1 3"/>`),
      close: svg(`<path d="M6 6l12 12"/><path d="M18 6L6 18"/>`),
      min: svg(`<path d="M6 12h12"/>`),
      max: svg(`<path d="M6 7h12v12H6z"/>`),
      chevron: svg(`<path d="M9 6l6 6-6 6"/>`),
      upload: svg(`<path d="M12 3v10"/><path d="M8 7l4-4 4 4"/><path d="M4 14v6h16v-6"/>`),
      download: svg(`<path d="M12 21V11"/><path d="M8 17l4 4 4-4"/><path d="M4 4v6h16V4"/>`),
      plus: svg(`<path d="M12 5v14"/><path d="M5 12h14"/>`),
      trash: svg(`<path d="M6 7h12"/><path d="M10 7V5h4v2"/><path d="M8 7l1 14h6l1-14"/>`),
      edit: svg(`<path d="M4 20h4l10-10-4-4L4 16z"/><path d="M13 7l4 4"/>`),
      play: svg(`<path d="M8 5v14l12-7z"/>`),
      save: svg(`<path d="M5 4h12l2 2v14H5z"/><path d="M7 4v6h10V4"/><path d="M8 20h8"/>`),
      open: svg(`<path d="M4 6h7l2 2h7v10H4z"/>`),
      search: svg(`<path d="M10 18a8 8 0 1 1 5.3-14.1A8 8 0 0 1 10 18z"/><path d="M21 21l-4.35-4.35"/>`),
      apps: svg(`<rect x="3" y="3" width="7" height="7" rx="1.4"/><rect x="14" y="3" width="7" height="7" rx="1.4"/><rect x="3" y="14" width="7" height="7" rx="1.4"/><rect x="14" y="14" width="7" height="7" rx="1.4"/>`),
      camera: svg(`<path d="M4 7h4l2-2h4l2 2h4v13H4V7z"/><circle cx="12" cy="13" r="3.2"/>`),
      info: svg(`<path d="M12 9h0.01"/><path d="M11 12h1v6h1"/>`),
      copy: svg(`<rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`),
      refresh: svg(`<path d="M21 12a9 9 0 1 1-2.64-6.36"/><path d="M21 3v6h-6"/>`),
      package: svg(`<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.3 7l8.7 5 8.7-5"/><path d="M12 22V12"/>`),
      box: svg(`<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><path d="M3.3 7l8.7 5 8.7-5"/><path d="M12 22V12"/>`),
      gamepad: svg(`<path d="M6 12h12a4 4 0 0 1 4 4v2a3 3 0 0 1-3 3h-1l-2-3H8l-2 3H5a3 3 0 0 1-3-3v-2a4 4 0 0 1 4-4z"/><path d="M8 14h4"/><path d="M10 12v4"/><path d="M16 14h0.01"/><path d="M18 16h0.01"/>`),
      plug: svg(`<path d="M9 2v6"/><path d="M15 2v6"/><path d="M5 8h14"/><path d="M7 8v4a5 5 0 0 0 10 0V8"/><path d="M12 17v5"/>`),

    };
    function svg(paths){
      return `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">${paths}</svg>`;
    }

    /* ---------- i18n ---------- */
    const I18N = {
      en: {
        start: "Start",
        search_apps: "Search apps…",
        settings: "Settings",
        show_desktop: "Show desktop",
        desk: "Desk",
        desktops: "Desktops",
        minimize: "Minimize",
        maximize: "Maximize",
        web_desktop: "Web desktop",
        installed_apps: "Installed",
        recent: "Recent",
        tips: "Tips",
        discover: "Discover",
        install: "Install",
        uninstall: "Uninstall",
        open: "Open",
        save: "Save",
        save_as: "Save As",
        export: "Export",
        import: "Import",
        new: "New",
        close: "Close",
        cancel: "Cancel",
        ok: "OK",
        file_manager: "Files",
        terminal: "Terminal",
        writer: "Writer",
        sheets: "Sheets",
        slides: "Slides",
        vm_hub: "VM Hub",
        vm_hub_desc: "Manage VM / remote-desktop shortcuts (noVNC / Guacamole / etc).",
        archdesk: "Arch Desktop",
        archdesk_desc: "Connect to a real Linux desktop via noVNC / webtop.",
        archdesk_url: "Arch Desktop URL",
        archdesk_hint: "Tip: run a local webtop/container/VM and paste its URL here (e.g. http://localhost:3000/).",
        open_in_window: "Open in window",
        open_in_tab: "Open in new tab",
        tips: "Tips",
        archdesk_tip1: "Some sites block iframes. If the window is blank, use “Open in new tab”.",
        archdesk_tip2: "For full apps (LibreOffice, Flatpak), use the Arch Desktop / VM.",
        officepro: "Office Pro",
        officepro_desc: "Office dashboard (Writer/Sheets/Slides + LibreOffice via VM).",
        officepro_hint: "Office Lite works offline. For full LibreOffice, use Arch Desktop.",
        office_full: "Full Office (LibreOffice)",
        office_full_hint: "Launch LibreOffice inside an Arch desktop/container/VM and control it here.",
        open_libreoffice: "Open LibreOffice",
        arch_commands: "Arch commands",
        office_pl_hint: "Packages above add Polish UI + spell + thesaurus for LibreOffice (on Arch).",
        exeapps: "EXE + Flatpak",
        exeapps_desc: "Guide: run .exe & Flatpak via VM / Wine / remote desktop.",
        exeapps_hint: "A single HTML file cannot natively run Windows .exe or host Flatpak. Use a VM or a Linux desktop/container.",
        exe_run_options: "Options",
        opt_windows_vm: "Windows VM",
        opt_windows_vm_desc: "Run .exe in a real Windows VM (noVNC / RDP / Guacamole).",
        opt_wine: "Wine / Proton",
        opt_wine_desc: "Run many .exe inside Linux with Wine/Proton (best via Arch Desktop).",
        opt_flatpak: "Flatpak",
        opt_flatpak_desc: "Install apps from Flathub in your Linux environment and launch them there.",
        flatpak_store: "Flatpak Store",
        flatpak_store_desc: "Browse and install Flatpak apps from Flathub via your Linux host/VM.",
        flathub: "Flathub",
        flatpak_apps: "Flatpak apps",
        flatpak_search: "Search Flatpaks…",
        curated_list: "Curated list",
        online_search: "Online search",
        sync_installed: "Sync installed",
        agent: "Host Agent",
        agent_url: "Agent URL",
        agent_token: "Token (optional)",
        test_connection: "Test connection",
        agent_ok: "Agent connected.",
        agent_fail: "Agent not reachable.",
        send_to_host: "Send to host",
        copy: "Copy",
        copied: "Copied",
        run: "Run",
        install_cmd: "Install command",
        command_output: "Command output",
        distrobox: "Distrobox",
        distrobox_desc: "Manage Distrobox containers on your Linux host.",
        container_name: "Container name",
        image: "Image",
        create: "Create",
        list: "List",
        enter: "Enter",
        remove: "Remove",
        use: "Use",
        gaming_hub: "Gaming Hub",
        gaming_hub_desc: "Install Steam and gaming tools (Flatpak) and launch them in your Linux environment.",
        install_steam: "Install Steam",
        launch_steam: "Launch Steam",
        gaming_tools: "Gaming tools",
        recommended_stack: "Recommended stack",
        open_flatpak_store: "Open Flatpak Store",
        open_settings: "Open settings",
        no_agent_hint: "No agent configured — copy commands into your Arch Desktop/VM terminal.",
        virtual_desktops: "Virtual Desktops",
        desktop_count: "Number of desktops",
        snap_windows: "Snap windows",
        on: "On",
        off: "Off",
        remote_desktop: "Remote Desktop",
        screenshot: "Screenshot",
        screenshot_ok: "Screenshot downloaded.",
        screenshot_fail: "Screenshot is not available in this browser/device.",
        task_switcher: "Task switcher",
        task_switcher_hint: "Shortcut: Ctrl+` cycles windows (browser-safe).",
        no_results: "No results.",
        no_windows: "No windows to switch.",
        help: "Help",
        reset: "Reset",
        reload_now: "Reload this desktop now?",
        desk_shortcuts_hint: "Ctrl+Alt+←/→ switch desktops • Drag to edges to snap windows • Ctrl+K opens Search",
        desktop: "Desktop",
        downloads: "Downloads",
        documents: "Documents",
        pictures: "Pictures",
        home: "Home",
        create_folder: "New folder",
        create_file: "New text file",
        upload: "Upload",
        download: "Download",
        rename: "Rename",
        delete: "Delete",
        path: "Path",
        name: "Name",
        type: "Type",
        size: "Size",
        modified: "Modified",
        theme: "Theme",
        dark: "Dark",
        light: "Light",
        accent: "Accent",
        wallpaper: "Wallpaper",
        language: "Language",
        backup_restore: "Backup & Restore",
        export_backup: "Export backup",
        import_backup: "Import backup",
        about_limits: "About limits (important)",
        limits_msg: "This is a browser-based desktop UI. Browsers cannot directly run native .EXE or Flatpak packages, nor boot real Arch Linux VMs, inside a single HTML file. VM Hub can open remote VMs (noVNC/Guacamole/etc) and the Terminal simulates common commands. To run real Windows apps: use Wine/Proton (Linux) or a VM.",
        vm_add: "Add VM shortcut",
        vm_name: "VM name",
        vm_url: "VM URL",
        vm_mode: "Open mode",
        vm_iframe: "In window (iframe)",
        vm_tab: "New tab",
        vm_launch: "Launch",
        vm_remove: "Remove",
        discover_desc: "Install/uninstall built‑in web apps. Also keep shortcuts for Flatpak/Wine/VMs.",
        office_desc: "A lightweight offline office suite stored locally in your browser.",
        writer_desc: "Rich text editor (offline). Save as .html or .txt.",
        sheets_desc: "Mini spreadsheet with CSV import/export and basic formulas.",
        slides_desc: "Simple slides editor + presentation mode.",
        files_desc: "Local file manager backed by IndexedDB.",
        terminal_desc: "Simulated shell with file commands and “pacman/flatpak” helpers.",
        vm_desc: "Launch remote VMs (URLs) inside a window or new tab.",
        help_desc: "How to use this desktop and connect real VMs/apps.",
        toast_ready: "Ready",
        toast_saved: "Saved",
        toast_installed: "Installed",
        toast_removed: "Removed",
        toast_error: "Error",
        yes: "Yes",
        no: "No",
        present: "Present",
        next: "Next",
        prev: "Prev",
      },
      pl: {
        start: "Start",
        search_apps: "Szukaj aplikacji…",
        settings: "Ustawienia",
        show_desktop: "Pulpit",
        desk: "Pulpit",
        desktops: "Pulpity",
        minimize: "Minimalizuj",
        maximize: "Maksymalizuj",
        web_desktop: "Web desktop",
        installed_apps: "Zainstalowane",
        recent: "Ostatnie",
        tips: "Wskazówki",
        discover: "Discover",
        install: "Zainstaluj",
        uninstall: "Odinstaluj",
        open: "Otwórz",
        save: "Zapisz",
        save_as: "Zapisz jako",
        export: "Eksport",
        import: "Import",
        new: "Nowy",
        close: "Zamknij",
        cancel: "Anuluj",
        ok: "OK",
        file_manager: "Pliki",
        terminal: "Terminal",
        writer: "Writer",
        sheets: "Sheets",
        slides: "Slides",
        vm_hub: "VM Hub",
        vm_hub_desc: "Zarządzaj skrótami do VM / zdalnych pulpitów (noVNC / Guacamole / itp.).",
        archdesk: "Pulpit Arch",
        archdesk_desc: "Połącz z prawdziwym pulpitem Linuksa przez noVNC / webtop.",
        archdesk_url: "Adres URL pulpitu Arch",
        archdesk_hint: "Wskazówka: uruchom lokalny webtop/kontener/VM i wklej tutaj URL (np. http://localhost:3000/).",
        open_in_window: "Otwórz w oknie",
        open_in_tab: "Otwórz w nowej karcie",
        tips: "Wskazówki",
        archdesk_tip1: "Niektóre strony blokują iframe. Jeśli okno jest puste, użyj „Otwórz w nowej karcie”.",
        archdesk_tip2: "Dla pełnych aplikacji (LibreOffice, Flatpak) użyj pulpitu Arch / VM.",
        officepro: "Pakiet biurowy",
        officepro_desc: "Panel biurowy (Writer/Sheets/Slides + LibreOffice przez VM).",
        officepro_hint: "Office Lite działa offline. Dla pełnego LibreOffice użyj pulpitu Arch.",
        office_full: "Pełny Office (LibreOffice)",
        office_full_hint: "Uruchom LibreOffice w Arch/kontenerze/VM i steruj nim tutaj.",
        open_libreoffice: "Otwórz LibreOffice",
        arch_commands: "Polecenia Arch",
        office_pl_hint: "Powyższe pakiety dodają polski interfejs + słownik + tezaurus do LibreOffice (na Arch).",
        exeapps: "EXE + Flatpak",
        exeapps_desc: "Poradnik: .exe i Flatpak przez VM / Wine / zdalny pulpit.",
        exeapps_hint: "Pojedynczy plik HTML nie uruchomi natywnie Windows .exe ani Flatpak. Użyj VM lub pulpitu Linuksa/kontenera.",
        exe_run_options: "Opcje",
        opt_windows_vm: "Windows VM",
        opt_windows_vm_desc: "Uruchom .exe w prawdziwej maszynie Windows (noVNC / RDP / Guacamole).",
        opt_wine: "Wine / Proton",
        opt_wine_desc: "Wiele .exe działa w Linuksie przez Wine/Proton (najlepiej przez pulpit Arch).",
        opt_flatpak: "Flatpak",
        opt_flatpak_desc: "Instaluj aplikacje z Flathub w swoim środowisku Linuksa i uruchamiaj je tam.",
        flatpak_store: "Sklep Flatpak",
        flatpak_store_desc: "Przeglądaj i instaluj aplikacje Flatpak z Flathub przez host/VM Linuksa.",
        flathub: "Flathub",
        flatpak_apps: "Aplikacje Flatpak",
        flatpak_search: "Szukaj Flatpak…",
        curated_list: "Polecane",
        online_search: "Wyszukiwanie online",
        sync_installed: "Synchronizuj zainstalowane",
        agent: "Agent hosta",
        agent_url: "URL agenta",
        agent_token: "Token (opcjonalnie)",
        test_connection: "Test połączenia",
        agent_ok: "Agent połączony.",
        agent_fail: "Nie można połączyć z agentem.",
        send_to_host: "Wyślij do hosta",
        copy: "Kopiuj",
        copied: "Skopiowano",
        run: "Uruchom",
        install_cmd: "Polecenie instalacji",
        command_output: "Wyjście polecenia",
        distrobox: "Distrobox",
        distrobox_desc: "Zarządzaj kontenerami Distrobox na hoście Linuksa.",
        container_name: "Nazwa kontenera",
        image: "Obraz",
        create: "Utwórz",
        list: "Lista",
        enter: "Wejdź",
        remove: "Usuń",
        use: "Użyj",
        gaming_hub: "Centrum gier",
        gaming_hub_desc: "Zainstaluj Steam i narzędzia do gier (Flatpak) i uruchamiaj je w swoim środowisku Linuksa.",
        install_steam: "Zainstaluj Steam",
        launch_steam: "Uruchom Steam",
        gaming_tools: "Narzędzia do gier",
        recommended_stack: "Polecany zestaw",
        open_flatpak_store: "Otwórz sklep Flatpak",
        open_settings: "Otwórz ustawienia",
        no_agent_hint: "Brak agenta — skopiuj polecenia do terminala w Arch Desktop/VM.",
        virtual_desktops: "Wirtualne pulpity",
        desktop_count: "Liczba pulpitów",
        snap_windows: "Przyciąganie okien",
        on: "Włączone",
        off: "Wyłączone",
        remote_desktop: "Zdalny pulpit",
        screenshot: "Zrzut ekranu",
        screenshot_ok: "Zrzut ekranu pobrany.",
        screenshot_fail: "Zrzut ekranu nie jest dostępny w tej przeglądarce/urządzeniu.",
        task_switcher: "Przełącznik okien",
        task_switcher_hint: "Skrót: Ctrl+` przełącza okna (bezpieczne dla przeglądarki).",
        no_results: "Brak wyników.",
        no_windows: "Brak okien do przełączenia.",
        help: "Pomoc",
        reset: "Reset",
        reload_now: "Reload this desktop now?",
        desk_shortcuts_hint: "Ctrl+Alt+←/→ switch desktops • Drag to edges to snap windows • Ctrl+K opens Search",
        desktop: "Pulpit",
        downloads: "Pobrane",
        documents: "Dokumenty",
        pictures: "Obrazy",
        home: "Home",
        create_folder: "Nowy folder",
        create_file: "Nowy plik tekstowy",
        upload: "Wyślij",
        download: "Pobierz",
        rename: "Zmień nazwę",
        delete: "Usuń",
        path: "Ścieżka",
        name: "Nazwa",
        type: "Typ",
        size: "Rozmiar",
        modified: "Zmieniono",
        theme: "Motyw",
        dark: "Ciemny",
        light: "Jasny",
        accent: "Akcent",
        wallpaper: "Tapeta",
        language: "Język",
        backup_restore: "Kopia i przywracanie",
        export_backup: "Eksportuj kopię",
        import_backup: "Importuj kopię",
        about_limits: "O ograniczeniach (ważne)",
        limits_msg: "To jest pulpit w przeglądarce. Przeglądarki nie uruchomią natywnie .EXE ani Flatpaków oraz nie zabootują prawdziwych VM Arch Linux w pojedynczym pliku HTML. VM Hub może otwierać zdalne VM (noVNC/Guacamole itd.), a Terminal symuluje polecenia. Do prawdziwych aplikacji Windows: Wine/Proton (Linux) albo VM.",
        vm_add: "Dodaj skrót VM",
        vm_name: "Nazwa VM",
        vm_url: "URL VM",
        vm_mode: "Tryb otwarcia",
        vm_iframe: "W oknie (iframe)",
        vm_tab: "Nowa karta",
        vm_launch: "Uruchom",
        vm_remove: "Usuń",
        discover_desc: "Instaluj/odinstaluj wbudowane aplikacje web. Dodawaj też skróty do Flatpak/Wine/VM.",
        office_desc: "Lekki pakiet biurowy offline zapisany lokalnie w przeglądarce.",
        writer_desc: "Edytor tekstu (offline). Zapis jako .html lub .txt.",
        sheets_desc: "Mini arkusz z CSV i prostymi formułami.",
        slides_desc: "Proste slajdy + tryb prezentacji.",
        files_desc: "Menedżer plików oparty o IndexedDB.",
        terminal_desc: "Symulowana powłoka z poleceniami plików i pomocnikami “pacman/flatpak”.",
        vm_desc: "Uruchamiaj zdalne VM (URL) w oknie lub w nowej karcie.",
        help_desc: "Jak używać pulpitu i podłączyć prawdziwe VM/aplikacje.",
        toast_ready: "Gotowe",
        toast_saved: "Zapisano",
        toast_installed: "Zainstalowano",
        toast_removed: "Usunięto",
        toast_error: "Błąd",
        yes: "Tak",
        no: "Nie",
        present: "Prezentuj",
        next: "Dalej",
        prev: "Wstecz",
      }
    };

    function detectLang(){
      const nav = (navigator.language || "en").toLowerCase();
      if (nav.startsWith("pl")) return "pl";
      return "en";
    }

    /* ---------- Persistent state ---------- */
    const STORAGE_KEY = "novaos_ultraplus_pl_state_v2";
    const DEFAULT_STATE = {
      version: 2,
      user: { name: "Marcelo" },
      settings: {
        theme: "dark",
        accent: "#4a8cff",
        wallpaper: "zorin",
        language: detectLang(),
        archDesktopUrl: "http://localhost:3000/",
        desktopCount: 4,
        snapEnabled: true,
        agentUrl: "",
        agentToken: ""
      },
      installedApps: ["discover","fileman","terminal","writer","sheets","slides","vmhub","archdesk","officepro","exeapps","flatpakstore","distrobox","gaminghub","settings","help"],
      desktopShortcuts: ["discover","writer","sheets","fileman","terminal","officepro","archdesk","flatpakstore","gaminghub"],
      pinnedApps: ["discover","fileman","writer","terminal","officepro","archdesk","vmhub","flatpakstore"],
      recentFiles: [],
      flatpakInstalled: [],
      vmShortcuts: [
        {id:"tmpl_arch", name:"Arch Desktop (noVNC) — XFCE Webtop", url:"http://localhost:3000/", mode:"tab"},
        {id:"tmpl_office", name:"LibreOffice (via Arch Desktop)", url:"http://localhost:3000/", mode:"tab"},
        {id:"tmpl_windows", name:"Windows VM (noVNC) — set your URL", url:"https://example.com/novnc/", mode:"tab"}
      ]
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);
        return deepMerge(structuredClone(DEFAULT_STATE), parsed);
      }catch(e){
        console.warn("State load failed", e);
        return structuredClone(DEFAULT_STATE);
      }
    }
    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(State));
      }catch(e){
        console.warn("State save failed", e);
        toast(t("toast_error"), "Storage quota reached. Consider exporting a backup.", "bad");
      }
    }
    function deepMerge(base, patch){
      if (typeof base !== "object" || base === null) return patch;
      if (typeof patch !== "object" || patch === null) return base;
      for (const k of Object.keys(patch)){
        if (Array.isArray(patch[k])){
          base[k] = patch[k].slice();
        } else if (typeof patch[k] === "object" && patch[k] !== null){
          base[k] = deepMerge(base[k] ?? {}, patch[k]);
        } else {
          base[k] = patch[k];
        }
      }
      return base;
    }

    const State = loadState();
    function migrateState(){
      const v = Number(State.version || 1);
      if(v < 2){
        // Fix legacy typo and add new fields
        if(Array.isArray(State.installedApps)){
          State.installedApps = State.installedApps.map(id => id === "...es" ? "sheets" : id);
        }
        if(Array.isArray(State.desktopShortcuts)){
          State.desktopShortcuts = State.desktopShortcuts.map(id => id === "...es" ? "sheets" : id);
        }
        if(State.settings){
          if(State.settings.agentUrl == null) State.settings.agentUrl = "";
          if(State.settings.agentToken == null) State.settings.agentToken = "";
          if(State.settings.archDesktopUrl == null) State.settings.archDesktopUrl = State.settings.archDesktopUrl || "http://localhost:3000/";
          if(State.settings.desktopCount == null) State.settings.desktopCount = 4;
          if(State.settings.snapEnabled == null) State.settings.snapEnabled = true;
        }
        if(State.flatpakInstalled == null) State.flatpakInstalled = [];
        State.version = 2;
        saveState();
      }
    }
    migrateState();


    function t(key){
      const lang = State.settings.language || "en";
      return (I18N[lang] && I18N[lang][key]) || I18N.en[key] || key;
    }

    /* ---------- IndexedDB file system ---------- */
    const DB_NAME = "novaos_ultraplus_pl_fs";
    const DB_VER = 1;
    let DB = null;

    async function openDB(){
      if (DB) return DB;
      DB = await new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = () => {
          const db = req.result;
          const store = db.createObjectStore("nodes", { keyPath: "path" });
          store.createIndex("parent", "parent", { unique: false });
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
      return DB;
    }

    const FS = {
      norm(path){
        path = String(path || "/").replace(/\\/g,"/").replace(/\/+/g,"/");
        if(!path.startsWith("/")) path = "/" + path;
        if(path.length > 1 && path.endsWith("/")) path = path.slice(0,-1);
        return path;
      },
      parent(path){
        path = FS.norm(path);
        if(path === "/") return null;
        const i = path.lastIndexOf("/");
        return i === 0 ? "/" : path.slice(0,i);
      },
      name(path){
        path = FS.norm(path);
        if(path === "/") return "/";
        return path.slice(path.lastIndexOf("/")+1);
      },
      async get(path){
        path = FS.norm(path);
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("nodes", "readonly");
          const store = tx.objectStore("nodes");
          const req = store.get(path);
          req.onsuccess = () => resolve(req.result || null);
          req.onerror = () => reject(req.error);
        });
      },
      async put(node){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("nodes", "readwrite");
          const store = tx.objectStore("nodes");
          store.put(node);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      },
      async del(path){
        path = FS.norm(path);
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("nodes", "readwrite");
          const store = tx.objectStore("nodes");
          store.delete(path);
          tx.oncomplete = () => resolve();
          tx.onerror = () => reject(tx.error);
        });
      },
      async list(dir){
        dir = FS.norm(dir);
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("nodes", "readonly");
          const store = tx.objectStore("nodes");
          const idx = store.index("parent");
          const req = idx.getAll(dir);
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      },
      async ensureDir(path){
        path = FS.norm(path);
        const existing = await FS.get(path);
        if(existing) return;
        const parent = FS.parent(path);
        if(parent && parent !== path) await FS.ensureDir(parent);
        await FS.put({
          path,
          parent,
          type: "dir",
          name: FS.name(path),
          mtime: Date.now()
        });
      },
      async writeFile(path, blob, mime="application/octet-stream"){
        path = FS.norm(path);
        const parent = FS.parent(path);
        await FS.ensureDir(parent || "/");
        await FS.put({
          path,
          parent,
          type: "file",
          name: FS.name(path),
          mime,
          size: blob.size,
          data: blob,
          mtime: Date.now()
        });
      },
      async readFile(path){
        const node = await FS.get(path);
        if(!node || node.type !== "file") throw new Error("Not a file");
        return node;
      },
      async move(src, dst){
        src = FS.norm(src); dst = FS.norm(dst);
        const node = await FS.get(src);
        if(!node) throw new Error("Not found");
        if(node.type === "dir"){
          // basic: move dir node only (does not recursively move children)
          node.path = dst;
          node.parent = FS.parent(dst);
          node.name = FS.name(dst);
          node.mtime = Date.now();
          await FS.put(node);
          await FS.del(src);
          return;
        }
        node.path = dst;
        node.parent = FS.parent(dst);
        node.name = FS.name(dst);
        node.mtime = Date.now();
        await FS.put(node);
        await FS.del(src);
      },
      async all(){
        const db = await openDB();
        return new Promise((resolve, reject) => {
          const tx = db.transaction("nodes", "readonly");
          const store = tx.objectStore("nodes");
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }
    };

    async function seedFSIfEmpty(){
      await FS.ensureDir("/");
      const rootList = await FS.list("/");
      if(rootList.length > 0) return;

      await FS.ensureDir("/home");
      await FS.ensureDir("/home/user");
      await FS.ensureDir("/home/user/Documents");
      await FS.ensureDir("/home/user/Downloads");
      await FS.ensureDir("/home/user/Pictures");

      await FS.writeFile("/home/user/Documents/Welcome.txt",
        new Blob([`Welcome to WebOS Desktop!

This is a single-file HTML "web desktop" that runs in your browser.

✅ Works on Windows/macOS/Linux and mobile browsers.
✅ Includes a lightweight Office suite: Writer, Sheets, Slides.
✅ File Manager backed by IndexedDB.
✅ Discover app store for built-in apps.
✅ VM Hub for remote VM links (noVNC / Guacamole / etc).
✅ Terminal with simulated commands.

Limitations:
- Browsers cannot natively execute .EXE or Flatpak packages.
- A real Arch Linux VM needs a remote VM or a backend.

Open Help for details.

`], {type:"text/plain"}), "text/plain");

      await FS.writeFile("/home/user/Documents/ReadMe.html",
        new Blob([`<!doctype html><meta charset="utf-8"><title>ReadMe</title>
<h1>ReadMe</h1>
<p>This is stored in your browser using IndexedDB.</p>
<ul>
  <li><b>Writer</b> saves rich text as HTML.</li>
  <li><b>Sheets</b> saves as CSV or JSON.</li>
  <li><b>Slides</b> saves as JSON.</li>
</ul>
<p>Tip: Use <code>Settings → Backup &amp; Restore</code> to export everything.</p>
`], {type:"text/html"}), "text/html");
    }

    /* ---------- Boot + apply theme ---------- */
    function applyTheme(){
      document.documentElement.dataset.theme = State.settings.theme;
      document.documentElement.style.setProperty("--accent", State.settings.accent || "#4a8cff");
      document.documentElement.style.setProperty("--accent-2", (State.settings.accent || "#4a8cff") + "33");
      applyWallpaper(State.settings.wallpaper || "zorin");
      $("#langText").textContent = (State.settings.language || "en").toUpperCase();
      $("#userName").textContent = State.user?.name || "user";
    }

    function applyWallpaper(id){
      const wp = $("#wallpaper");
      const presets = {
        zorin: `radial-gradient(1200px 900px at 20% 30%, rgba(74,140,255,.26), transparent 65%),
                radial-gradient(1100px 900px at 80% 70%, rgba(255,80,180,.16), transparent 65%),
                radial-gradient(900px 700px at 60% 20%, rgba(73,209,124,.14), transparent 60%),
                linear-gradient(180deg, #07070a, #0b0c10)`,
        arch: `radial-gradient(1000px 800px at 30% 25%, rgba(0,174,239,.22), transparent 62%),
               radial-gradient(900px 700px at 70% 70%, rgba(255,255,255,.10), transparent 60%),
               linear-gradient(180deg, #061018, #070c12)`,
        sunrise: `radial-gradient(1100px 900px at 20% 30%, rgba(255,180,90,.26), transparent 60%),
                  radial-gradient(900px 700px at 70% 60%, rgba(255,80,180,.18), transparent 60%),
                  linear-gradient(180deg, #0b0c10, #1a1022)`,
        lightblue: `radial-gradient(1200px 900px at 25% 30%, rgba(74,140,255,.20), transparent 65%),
                    radial-gradient(1000px 800px at 80% 70%, rgba(73,209,124,.12), transparent 65%),
                    linear-gradient(180deg, #f4f7ff, #eef2fb)`,
      };
      const css = presets[id] || presets.zorin;
      wp.style.background = css;
    }

    /* ---------- Toasts ---------- */
    function toast(title, msg="", kind=""){
      const wrap = $("#toastArea");
      const el = document.createElement("div");
      el.className = "toast";
      const badge = kind ? `<span class="badge ${kind}">${safeText(kind.toUpperCase())}</span>` : "";
      el.innerHTML = `
        <div class="tRow">
          <div class="tTitle">${safeText(title)} ${badge}</div>
          <button class="tClose">${t("close")}</button>
        </div>
        ${msg ? `<div class="tMsg">${safeText(msg)}</div>` : "" }
      `;
      const btn = el.querySelector(".tClose");
      btn.addEventListener("click", () => el.remove());
      wrap.appendChild(el);
      setTimeout(() => { if(el.isConnected) el.remove(); }, 5200);
    }

    /* ---------- Modal helpers ---------- */
    function showModal({title, bodyHTML, actions=[]}){
      const area = $("#modalArea");
      area.classList.add("active");
      area.setAttribute("aria-hidden","false");
      area.innerHTML = `
        <div class="modal" role="dialog" aria-label="${safeText(title)}">
          <div class="modalHead">
            <div class="modalTitle">${safeText(title)}</div>
            <button class="btn" id="modalX">${t("close")}</button>
          </div>
          <div class="modalBody">${bodyHTML}</div>
          <div class="modalFoot" id="modalFoot"></div>
        </div>
      `;
      $("#modalX").addEventListener("click", () => hideModal());
      const foot = $("#modalFoot");
      for (const a of actions){
        const b = document.createElement("button");
        b.className = "btn " + (a.kind || "");
        b.textContent = a.label;
        b.addEventListener("click", async () => {
          try{ await a.onClick?.(); } finally { if(a.close !== false) hideModal(); }
        });
        foot.appendChild(b);
      }
      area.addEventListener("click", (e) => {
        if(e.target === area) hideModal();
      }, {once:true});
    }
    function hideModal(){
      const area = $("#modalArea");
      area.classList.remove("active");
      area.setAttribute("aria-hidden","true");
      area.innerHTML = "";
    }

    async function promptText(title, label, placeholder="", value=""){
      return new Promise((resolve) => {
        showModal({
          title,
          bodyHTML: `
            <div class="field">
              <div class="muted">${safeText(label)}</div>
              <input class="input" id="promptInput" placeholder="${safeText(placeholder)}" value="${safeText(value)}" />
              <div class="hint">${safeText("")}</div>
            </div>
          `,
          actions: [
            {label: t("cancel"), kind:"", onClick: () => resolve(null)},
            {label: t("ok"), kind:"primary", onClick: () => resolve($("#promptInput").value.trim())}
          ]
        });
        setTimeout(() => $("#promptInput")?.focus(), 50);
      });
    }

    async function confirmYesNo(title, msg){
      return new Promise((resolve) => {
        showModal({
          title,
          bodyHTML: `<div class="hint">${safeText(msg)}</div>`,
          actions: [
            {label: t("no"), onClick: () => resolve(false)},
            {label: t("yes"), kind:"primary", onClick: () => resolve(true)}
          ]
        });
      });
    }


    /* ---------- Host Bridge (optional) ---------- */
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        toast(t("copied"), "", "ok");
        return true;
      }catch(e){
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "-9999px";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          document.execCommand("copy");
          ta.remove();
          toast(t("copied"), "", "ok");
          return true;
        }catch(e2){
          console.warn("Copy failed", e2);
          toast("Copy failed", String(e2), "bad");
          return false;
        }
      }
    }

    function agentBase(){
      const base = (State.settings.agentUrl || "").trim();
      return base ? base.replace(/\/+$/,"") : "";
    }

    async function agentPing(){
      const base = agentBase();
      if(!base) return {ok:false, error:"no-agent-url"};
      try{
        const headers = {};
        const token = (State.settings.agentToken || "").trim();
        if(token) headers["Authorization"] = `Bearer ${token}`;
        const res = await fetch(base + "/ping", {method:"GET", headers});
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json().catch(()=>({ok:true}));
        if(data && typeof data === "object") return {ok: data.ok ?? true, ...data};
        return {ok:true};
      }catch(e){
        return {ok:false, error:String(e)};
      }
    }

    async function agentRun(cmd){
      const base = agentBase();
      if(!base) throw new Error("Agent URL not set");
      const token = (State.settings.agentToken || "").trim();
      const headers = {"Content-Type":"application/json"};
      if(token) headers["Authorization"] = `Bearer ${token}`;
      const res = await fetch(base + "/run", {
        method:"POST",
        headers,
        body: JSON.stringify({cmd})
      });
      const txt = await res.text();
      let data;
      try{ data = JSON.parse(txt); }catch(e){ data = {stdout: txt}; }
      if(!res.ok){
        const msg = data?.error || data?.stderr || txt || ("HTTP " + res.status);
        throw new Error(msg);
      }
      return data;
    }

    async function runHostOrShow(cmd, title="Command"){
      const base = agentBase();
      // no agent: show copy-paste dialog
      if(!base){
        showModal({
          title,
          bodyHTML: `
            <div class="hint">${safeText(t("no_agent_hint"))}</div>
            <div class="hr"></div>
            <div class="hint">${safeText(t("install_cmd"))}</div>
            <div style="display:flex; gap:8px; align-items:flex-start; margin-top:8px;">
              <textarea class="input" style="flex:1; min-height:92px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">${safeText(cmd)}</textarea>
              <button class="btn" id="copyCmdBtn">${Icons.copy} ${t("copy")}</button>
            </div>
            <div class="hint" style="margin-top:8px;">
              ${safeText(t("open_settings"))}: Settings → ${safeText(t("agent"))}
            </div>
          `,
          actions: [{label: t("close"), onClick: () => {}}]
        });
        setTimeout(()=>$("#copyCmdBtn")?.addEventListener("click", ()=>copyToClipboard(cmd)), 50);
        return {ok:false, manual:true};
      }

      // try to run via agent
      try{
        const out = await agentRun(cmd);
        const text = String(out.stdout || out.output || "") + (out.stderr ? ("\n" + out.stderr) : "");
        showModal({
          title,
          bodyHTML: `
            <div class="hint">${safeText(base)}</div>
            <div class="hr"></div>
            <pre style="white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,.2); border:1px solid var(--border); border-radius:10px; padding:10px; max-height: 320px; overflow:auto;">${safeText(text || "(no output)")}</pre>
            <div class="row" style="justify-content:flex-end; margin-top:10px;">
              <button class="btn" id="copyCmdBtn2">${Icons.copy} ${t("copy")}</button>
            </div>
          `,
          actions: [{label: t("close"), onClick: () => {}}]
        });
        setTimeout(()=>$("#copyCmdBtn2")?.addEventListener("click", ()=>copyToClipboard(cmd)), 50);
        return {ok:true, out};
      }catch(e){
        showModal({
          title,
          bodyHTML: `
            <div class="hint"><span class="badge bad">!</span> ${safeText(t("agent_fail"))}</div>
            <div class="hint" style="margin-top:6px;">${safeText(String(e))}</div>
            <div class="hr"></div>
            <div class="hint">${safeText(t("install_cmd"))}</div>
            <div style="display:flex; gap:8px; align-items:flex-start; margin-top:8px;">
              <textarea class="input" style="flex:1; min-height:92px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">${safeText(cmd)}</textarea>
              <button class="btn" id="copyCmdBtn3">${Icons.copy} ${t("copy")}</button>
            </div>
          `,
          actions: [
            {label: t("open_settings"), kind:"primary", onClick: () => openApp("settings")},
            {label: t("close"), onClick: () => {}},
          ]
        });
        setTimeout(()=>$("#copyCmdBtn3")?.addEventListener("click", ()=>copyToClipboard(cmd)), 50);
        return {ok:false, error:String(e)};
      }
    }


    /* ---------- Flatpak helpers ---------- */
    const FLATPAK_CURATED = [
      {id:"com.valvesoftware.Steam", name:"Steam", summary:"Valve Steam client (Flatpak).", tags:"gaming steam"},
      {id:"com.heroicgameslauncher.hgl", name:"Heroic Games Launcher", summary:"Epic / GOG / Amazon Games launcher.", tags:"gaming"},
      {id:"net.lutris.Lutris", name:"Lutris", summary:"Game manager for Wine/Steam/etc.", tags:"gaming"},
      {id:"com.usebottles.bottles", name:"Bottles", summary:"Run Windows apps/games via Wine in bottles.", tags:"gaming wine"},
      {id:"net.davidotek.pupgui2", name:"ProtonUp-Qt", summary:"Manage Proton-GE and compatibility tools.", tags:"gaming proton"},
      {id:"org.libreoffice.LibreOffice", name:"LibreOffice", summary:"Full office suite (Flatpak).", tags:"office"},
      {id:"org.mozilla.firefox", name:"Firefox", summary:"Web browser.", tags:"browser"},
      {id:"com.discordapp.Discord", name:"Discord", summary:"Voice and chat.", tags:"chat"},
      {id:"org.videolan.VLC", name:"VLC", summary:"Media player.", tags:"media"},
      {id:"org.gimp.GIMP", name:"GIMP", summary:"Image editor.", tags:"graphics"},
      {id:"com.visualstudio.code", name:"Visual Studio Code", summary:"Code editor.", tags:"dev"},
      {id:"org.kde.kdenlive", name:"Kdenlive", summary:"Video editor.", tags:"media"}
    ];

    function flatpakIconUrl(appId){
      try{
        return `https://dl.flathub.org/repo/appstream/x86_64/icons/128x128/${encodeURIComponent(appId)}.png`;
      }catch(e){
        return "";
      }
    }
    function flatpakInstallCommand(appId){
      return `flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo && flatpak install -y flathub ${appId}`;
    }
    function flatpakUninstallCommand(appId){
      return `flatpak uninstall -y ${appId}`;
    }
    function flatpakRunCommand(appId){
      return `flatpak run ${appId}`;
    }

    async function flatpakListInstalled(){
      // If an agent is configured, try real flatpak list from the host.
      if(agentBase()){
        try{
          const out = await agentRun("flatpak list --app --columns=application");
          const txt = String(out.stdout || out.output || "");
          const apps = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
          State.flatpakInstalled = apps;
          saveState();
          return apps;
        }catch(e){
          console.warn("flatpak list failed", e);
        }
      }
      // Offline/manual cache
      return Array.isArray(State.flatpakInstalled) ? State.flatpakInstalled : [];
    }

    async function flatpakSearchOnline(query){
      const q = (query || "").trim();
      if(!q) return [];
      try{
        const res = await fetch("https://flathub.org/api/v2/search", {
          method:"POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({query: q, filters: []})
        });
        const data = await res.json().catch(()=>null);
        let hits = [];
        if(Array.isArray(data)) hits = data;
        else if(data && typeof data === "object"){
          hits = data.hits || data.results || data.apps || data.data || [];
        }
        const norm = (hits || []).map(r => ({
          id: r.app_id || r.appId || r.id || r.flatpakAppId || r.application || "",
          name: r.name || r.app_name || r.title || (r.app_id || r.id || ""),
          summary: r.summary || r.description || r.short_description || r.subtitle || ""
        })).filter(x => x.id);

        const seen = new Set();
        return norm.filter(x => seen.has(x.id) ? false : (seen.add(x.id), true)).slice(0, 30);
      }catch(e){
        console.warn("Flathub search failed", e);
        toast("Flathub search failed", String(e), "bad");
        return [];
      }
    }

    /* ---------- Window manager ---------- */
    const WM = (() => {
      const windows = new Map();
      let z = 200;
      let cascade = 0;
      let activeId = null;
      const mru = []; // most-recently-focused first

      const taskIcons = $("#taskIcons");
      const wsEl = $("#workspace");
      const snapPreview = $("#snapPreview");

      const DESK_MIN = 1;
      const DESK_MAX = 6;

      function clampInt(v, lo, hi){
        const n = Number.isFinite(+v) ? Math.floor(+v) : lo;
        return Math.max(lo, Math.min(hi, n));
      }

      function normalizeDesktops(){
        State.settings.desktopCount = clampInt(State.settings.desktopCount ?? 4, DESK_MIN, DESK_MAX);
        State.settings.currentDesktop = clampInt(State.settings.currentDesktop ?? 0, 0, State.settings.desktopCount - 1);
        State.settings.snapEnabled = (State.settings.snapEnabled ?? true);
      }

      function currentDesktop(){
        normalizeDesktops();
        return State.settings.currentDesktop;
      }

      function updateDesktopIndicator(){
        const el = $("#deskText");
        if(!el) return;
        el.textContent = `${t("desk")} ${currentDesktop()+1}`;
      }

      function applyDesktopVisibility(){
        const cur = currentDesktop();
        const maxDesk = (State.settings.desktopCount || 1) - 1;
        for(const w of windows.values()){
          if(w.desktop > maxDesk) w.desktop = maxDesk;
          if(w.desktop !== cur) w.el.classList.add("hiddenDesk");
          else w.el.classList.remove("hiddenDesk");
        }
        // ensure focused window is on this desktop
        if(activeId){
          const aw = windows.get(activeId);
          if(!aw || aw.desktop !== cur || aw.el.classList.contains("minimized")){
            activeId = null;
          }
        }
        if(!activeId){
          const top = listWindows({current:true, includeMinimized:false})[0];
          if(top) focus(top.id);
        }
        updateTaskButtons();
        updateDesktopIndicator();
      }

      function setDesktop(idx){
        normalizeDesktops();
        const next = clampInt(idx, 0, State.settings.desktopCount - 1);
        State.settings.currentDesktop = next;
        saveState();
        applyDesktopVisibility();
      }

      function nextDesktop(){
        const cur = currentDesktop();
        setDesktop((cur + 1) % State.settings.desktopCount);
      }
      function prevDesktop(){
        const cur = currentDesktop();
        setDesktop((cur - 1 + State.settings.desktopCount) % State.settings.desktopCount);
      }

      function listWindows({current=true, includeMinimized=true}={}){
        const cur = currentDesktop();
        const arr = Array.from(windows.values())
          .filter(w => !current || w.desktop === cur)
          .filter(w => includeMinimized || !w.el.classList.contains("minimized"));
        // sort by MRU, fallback to z
        arr.sort((a,b) => {
          const ai = mru.indexOf(a.id);
          const bi = mru.indexOf(b.id);
          if(ai !== -1 || bi !== -1){
            if(ai === -1) return 1;
            if(bi === -1) return -1;
            return ai - bi;
          }
          return (parseInt(b.el.style.zIndex||"0") - parseInt(a.el.style.zIndex||"0"));
        });
        return arr;
      }

      function rememberMRU(id){
        const i = mru.indexOf(id);
        if(i !== -1) mru.splice(i,1);
        mru.unshift(id);
      }

      function focus(id){
        const win = windows.get(id);
        if(!win) return;
        const cur = currentDesktop();
        if(win.desktop !== cur){
          setDesktop(win.desktop);
        }
        for(const w of windows.values()){
          w.el.classList.remove("activeWin");
        }
        win.el.style.zIndex = String(++z);
        win.el.classList.add("activeWin");
        activeId = id;
        rememberMRU(id);
        updateTaskButtons();
      }

      function updateTaskButtons(){
        taskIcons.innerHTML = "";
        const cur = currentDesktop();
        const pinned = new Set(State.pinnedApps || []);
        const allWins = Array.from(windows.values());
        // pinned apps first
        for(const appId of (State.pinnedApps || [])){
          const app = AppRegistry[appId];
          if(!app) continue;
          const btn = document.createElement("button");
          btn.className = "taskApp";
          btn.innerHTML = app.icon;
          btn.title = app.name();
          btn.addEventListener("click", () => {
            const wins = allWins.filter(w => w.appId === appId);
            if(wins.length){
              const target = wins.find(w => w.desktop === cur) || wins[0];
              if(target.desktop !== cur) setDesktop(target.desktop);
              if(target.el.classList.contains("minimized")) target.el.classList.remove("minimized");
              focus(target.id);
            }else{
              openApp(appId);
            }
          });
          // dot if running anywhere
          if(allWins.some(w => w.appId === appId)){
            const dot = document.createElement("div");
            dot.className = "dot";
            btn.appendChild(dot);
          }
          // active highlight if active on this desktop
          const activeWin = allWins.find(w => w.appId === appId && w.desktop === cur && w.el.classList.contains("activeWin"));
          if(activeWin) btn.classList.add("active");
          taskIcons.appendChild(btn);
        }

        // running windows on current desktop (non-pinned)
        for(const w of allWins.filter(w => w.desktop === cur && !pinned.has(w.appId))){
          const app = AppRegistry[w.appId];
          const btn = document.createElement("button");
          btn.className = "taskApp";
          btn.innerHTML = app?.icon || Icons.info;
          btn.title = w.title;
          btn.addEventListener("click", () => {
            if(w.el.classList.contains("minimized")){
              w.el.classList.remove("minimized");
            }
            focus(w.id);
          });
          const dot = document.createElement("div");
          dot.className = "dot";
          btn.appendChild(dot);
          if(w.el.classList.contains("activeWin")) btn.classList.add("active");
          taskIcons.appendChild(btn);
        }
      }

      function showSnapRect(rectAbs){
        if(!State.settings.snapEnabled) return;
        snapPreview.classList.remove("hidden");
        snapPreview.setAttribute("aria-hidden","false");
        snapPreview.style.left = rectAbs.left + "px";
        snapPreview.style.top = rectAbs.top + "px";
        snapPreview.style.width = rectAbs.width + "px";
        snapPreview.style.height = rectAbs.height + "px";
      }
      function hideSnapRect(){
        snapPreview.classList.add("hidden");
        snapPreview.setAttribute("aria-hidden","true");
      }

      function computeSnapTarget(clientX, clientY){
        if(!State.settings.snapEnabled) return null;
        const ws = wsEl.getBoundingClientRect();
        const edge = 34; // px
        const x = clientX - ws.left;
        const y = clientY - ws.top;
        const nearL = x <= edge;
        const nearR = x >= ws.width - edge;
        const nearT = y <= edge;
        const nearB = y >= ws.height - edge;

        const halfW = Math.round(ws.width/2);
        const halfH = Math.round(ws.height/2);

        const make = (lx, ty, w, h) => ({
          rel: {left: lx, top: ty, width: w, height: h},
          abs: {left: ws.left + lx, top: ws.top + ty, width: w, height: h}
        });

        if(nearT && nearL) return make(8, 8, halfW - 12, halfH - 12);
        if(nearT && nearR) return make(halfW + 4, 8, halfW - 12, halfH - 12);
        if(nearB && nearL) return make(8, halfH + 4, halfW - 12, halfH - 12);
        if(nearB && nearR) return make(halfW + 4, halfH + 4, halfW - 12, halfH - 12);

        if(nearL) return make(8, 8, halfW - 12, ws.height - 16);
        if(nearR) return make(halfW + 4, 8, halfW - 12, ws.height - 16);
        if(nearT) return make(8, 8, ws.width - 16, ws.height - 16);

        return null;
      }

      function applySnap(win, target){
        if(!target) return;
        const el = win.el;
        el.classList.remove("maximized");
        el.style.left = target.rel.left + "px";
        el.style.top = target.rel.top + "px";
        el.style.width = target.rel.width + "px";
        el.style.height = target.rel.height + "px";
      }

      function createWindow({appId, title, icon, width=760, height=520, minWidth=360, minHeight=240, contentHTML="", onInit}){
        normalizeDesktops();
        const id = uid();
        const el = document.createElement("div");
        el.className = "window";
        el.style.width = width + "px";
        el.style.height = height + "px";
        el.style.minWidth = minWidth + "px";
        el.style.minHeight = minHeight + "px";

        const pad = 12 + (cascade % 6) * 18;
        cascade++;
        const ws = wsEl.getBoundingClientRect();
        const x = clamp(pad, 10, Math.max(10, ws.width - width - 10));
        const y = clamp(pad, 10, Math.max(10, ws.height - height - 10));
        el.style.left = x + "px";
        el.style.top = y + "px";

        el.innerHTML = `
          <div class="titlebar">
            <div class="titleLeft">
              <span class="winIco">${icon||""}</span>
              <span class="winTitle">${safeText(title)}</span>
            </div>
            <div class="winControls">
              <button class="winBtn" data-act="min" title="${safeText(t("minimize"))}">${Icons.min}</button>
              <button class="winBtn" data-act="max" title="${safeText(t("maximize"))}">${Icons.max}</button>
              <button class="winBtn close" data-act="close" title="${safeText(t("close"))}">${Icons.close}</button>
            </div>
          </div>
          <div class="winBody">${contentHTML}</div>
          <div class="resizer" title="Resize"></div>
          <div class="rHandle n" data-dir="n"></div>
          <div class="rHandle s" data-dir="s"></div>
          <div class="rHandle e" data-dir="e"></div>
          <div class="rHandle w" data-dir="w"></div>
          <div class="rHandle nw" data-dir="nw"></div>
          <div class="rHandle ne" data-dir="ne"></div>
          <div class="rHandle sw" data-dir="sw"></div>
          <div class="rHandle se" data-dir="se"></div>
        `;
        wsEl.appendChild(el);

        const win = {
          id, appId,
          el,
          body: el.querySelector(".winBody"),
          title,
          desktop: currentDesktop(),
          setTitle(newTitle){
            this.title = newTitle;
            el.querySelector(".winTitle").textContent = newTitle;
            updateTaskButtons();
          },
          close(){
            windows.delete(id);
            const idx = mru.indexOf(id);
            if(idx !== -1) mru.splice(idx,1);
            el.remove();
            if(activeId === id) activeId = null;
            updateTaskButtons();
          },
          minimize(){
            el.classList.add("minimized");
            if(activeId === id) activeId = null;
            updateTaskButtons();
          },
          maximize(){
            el.classList.toggle("maximized");
            updateTaskButtons();
          },
          focus(){ focus(id); }
        };

        windows.set(id, win);
        attachWindowBehaviors(win);
        applyDesktopVisibility();
        focus(id);

        if(onInit) {
          try { onInit(win); } catch(e){ console.warn(e); }
        }
        return win;
      }

      function attachWindowBehaviors(win){
        const el = win.el;
        const titlebar = el.querySelector(".titlebar");
        const resizer = el.querySelector(".resizer");

        el.addEventListener("mousedown", () => focus(win.id));
        el.addEventListener("touchstart", () => focus(win.id), {passive:true});

        // buttons
        el.querySelectorAll(".winBtn").forEach(b => {
          b.addEventListener("click", (e) => {
            e.stopPropagation();
            const act = b.getAttribute("data-act");
            if(act === "close") win.close();
            if(act === "min") win.minimize();
            if(act === "max") win.maximize();
          });
        });

        // drag + snap preview
        let drag = null;
        const startDrag = (clientX, clientY) => {
          if(el.classList.contains("maximized")) return;
          const r = el.getBoundingClientRect();
          drag = {dx: clientX - r.left, dy: clientY - r.top, lastX: clientX, lastY: clientY, snap: null};
        };
        const doDrag = (clientX, clientY) => {
          if(!drag) return;
          drag.lastX = clientX; drag.lastY = clientY;
          const ws = wsEl.getBoundingClientRect();
          const newL = clamp(clientX - drag.dx - ws.left, 6, ws.width - el.offsetWidth - 6);
          const newT = clamp(clientY - drag.dy - ws.top, 6, ws.height - el.offsetHeight - 6);
          el.style.left = newL + "px";
          el.style.top = newT + "px";

          drag.snap = computeSnapTarget(clientX, clientY);
          if(drag.snap) showSnapRect(drag.snap.abs);
          else hideSnapRect();
        };
        const endDrag = () => {
          if(!drag) return;
          if(drag.snap) applySnap(win, drag.snap);
          hideSnapRect();
          drag = null;
        };

        titlebar.addEventListener("mousedown", (e) => {
          if(e.target.closest(".winControls")) return;
          startDrag(e.clientX, e.clientY);
        });
        window.addEventListener("mousemove", (e) => doDrag(e.clientX, e.clientY));
        window.addEventListener("mouseup", endDrag);

        // touch drag
        titlebar.addEventListener("touchstart", (e) => {
          if(e.target.closest(".winControls")) return;
          const t = e.touches[0];
          startDrag(t.clientX, t.clientY);
        }, {passive:true});
        window.addEventListener("touchmove", (e) => {
          if(!drag) return;
          const t = e.touches[0];
          doDrag(t.clientX, t.clientY);
        }, {passive:true});
        window.addEventListener("touchend", endDrag, {passive:true});

        // resize (8-way)
        let resize = null;
        const startResize = (clientX, clientY, dir) => {
          if(el.classList.contains("maximized")) return;
          const r = el.getBoundingClientRect();
          resize = {
            dir,
            sx: clientX, sy: clientY,
            left: parseFloat(el.style.left)||0,
            top: parseFloat(el.style.top)||0,
            w: r.width, h: r.height
          };
        };
        const doResize = (clientX, clientY) => {
          if(!resize) return;
          const ws = wsEl.getBoundingClientRect();
          const dx = clientX - resize.sx;
          const dy = clientY - resize.sy;

          let left = resize.left;
          let top = resize.top;
          let w = resize.w;
          let h = resize.h;

          const minW = parseInt(el.style.minWidth)||360;
          const minH = parseInt(el.style.minHeight)||240;

          const dir = resize.dir;

          if(dir.includes("e")){
            w = clamp(resize.w + dx, minW, ws.width - left - 6);
          }
          if(dir.includes("s")){
            h = clamp(resize.h + dy, minH, ws.height - top - 6);
          }
          if(dir.includes("w")){
            const newLeft = clamp(resize.left + dx, 6, resize.left + resize.w - minW);
            w = clamp(resize.w + (resize.left - newLeft), minW, ws.width - 6);
            left = newLeft;
          }
          if(dir.includes("n")){
            const newTop = clamp(resize.top + dy, 6, resize.top + resize.h - minH);
            h = clamp(resize.h + (resize.top - newTop), minH, ws.height - 6);
            top = newTop;
          }

          el.style.left = left + "px";
          el.style.top = top + "px";
          el.style.width = w + "px";
          el.style.height = h + "px";
        };
        const endResize = () => resize = null;

        // bottom-right legacy handle
        resizer.addEventListener("mousedown", (e) => { e.stopPropagation(); startResize(e.clientX, e.clientY, "se"); });
        window.addEventListener("mousemove", (e) => doResize(e.clientX, e.clientY));
        window.addEventListener("mouseup", endResize);

        resizer.addEventListener("touchstart", (e) => {
          e.stopPropagation();
          const t = e.touches[0];
          startResize(t.clientX, t.clientY, "se");
        }, {passive:true});
        window.addEventListener("touchmove", (e) => {
          if(!resize) return;
          const t = e.touches[0];
          doResize(t.clientX, t.clientY);
        }, {passive:true});
        window.addEventListener("touchend", endResize, {passive:true});

        // edge/corner handles
        el.querySelectorAll(".rHandle").forEach(h => {
          const dir = h.getAttribute("data-dir");
          h.addEventListener("mousedown", (e) => { e.stopPropagation(); startResize(e.clientX, e.clientY, dir); });
          h.addEventListener("touchstart", (e) => {
            e.stopPropagation();
            const t = e.touches[0];
            startResize(t.clientX, t.clientY, dir);
          }, {passive:true});
        });

        // double click titlebar => maximize
        titlebar.addEventListener("dblclick", (e) => {
          if(e.target.closest(".winControls")) return;
          win.maximize();
        });
      }

      function minimizeAll(){
        const cur = currentDesktop();
        for(const w of windows.values()){
          if(w.desktop === cur) w.el.classList.add("minimized");
        }
        activeId = null;
        updateTaskButtons();
      }

      function restoreAll(){
        const cur = currentDesktop();
        for(const w of windows.values()){
          if(w.desktop === cur) w.el.classList.remove("minimized");
        }
        updateTaskButtons();
      }

      function anyVisible(){
        const cur = currentDesktop();
        return Array.from(windows.values()).some(w => w.desktop === cur && !w.el.classList.contains("minimized"));
      }

      function getActive(){
        return activeId ? windows.get(activeId) : null;
      }

      // Keyboard snapping (Win+Arrows)
      function snapActive(direction){
        const win = getActive();
        if(!win) return;
        const ws = wsEl.getBoundingClientRect();
        const halfW = Math.round(ws.width/2);
        const halfH = Math.round(ws.height/2);
        const makeRel = (l,t,w,h) => ({rel:{left:l, top:t, width:w, height:h}, abs:{left:ws.left+l, top:ws.top+t, width:w, height:h}});
        let target = null;
        if(direction === "left") target = makeRel(8,8,halfW-12, ws.height-16);
        if(direction === "right") target = makeRel(halfW+4,8,halfW-12, ws.height-16);
        if(direction === "up") target = makeRel(8,8,ws.width-16, ws.height-16);
        if(direction === "down") {
          // restore-ish: do nothing for now
          return;
        }
        applySnap(win, target);
      }

      normalizeDesktops();
      updateDesktopIndicator();

      return {
        createWindow, focus, updateTaskButtons,
        minimizeAll, restoreAll, anyVisible,
        setDesktop, nextDesktop, prevDesktop,
        listWindows, getActive, snapActive,
        applyDesktopVisibility
      };
    })();

/* ---------- App Registry ---------- */
    const AppRegistry = {};
    function registerApp(app){
      AppRegistry[app.id] = {
        ...app,
        name: () => t(app.nameKey),
        desc: () => t(app.descKey || ""),
      };
    }

    // Helper: open file based on extension
    async function openFile(path){
      const node = await FS.get(path);
      if(!node){ toast(t("toast_error"), "File not found.", "bad"); return; }
      State.recentFiles = [path, ...State.recentFiles.filter(p => p !== path)].slice(0,8);
      saveState();
      renderStartMenu();
      const ext = (FS.name(path).split(".").pop() || "").toLowerCase();
      if(ext === "txt" || ext === "html" || ext === "htm" || ext === "md"){
        openApp("writer", {path});
        return;
      }
      if(ext === "csv"){
        openApp("sheets", {path});
        return;
      }
      if(ext === "zslides" || ext === "json"){
        openApp("slides", {path});
        return;
      }
      // image preview
      if((node.mime||"").startsWith("image/")){
        openApp("writer", {path, mode:"preview"});
        return;
      }
      // default: download
      downloadNode(node);
    }

    function bytes(n){
      if(n == null) return "";
      const u = ["B","KB","MB","GB"];
      let i=0;
      let v=n;
      while(v>=1024 && i<u.length-1){ v/=1024; i++; }
      return `${v.toFixed(i===0?0:1)} ${u[i]}`;
    }

    function formatDate(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString([], {year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      }catch{ return ""; }
    }

    function downloadNode(node){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(node.data);
      a.download = node.name;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 1000);
    }

    function installApp(appId){
      if(!State.installedApps.includes(appId)){
        State.installedApps.push(appId);
        saveState();
        toast(t("toast_installed"), AppRegistry[appId]?.name() || appId, "ok");
        renderDesktop();
        renderStartMenu();
      }
    }
    function uninstallApp(appId){
      if(["discover","settings","help"].includes(appId)){
        toast(t("toast_error"), "Core apps can't be removed.", "bad");
        return;
      }
      State.installedApps = State.installedApps.filter(a => a !== appId);
      State.desktopShortcuts = State.desktopShortcuts.filter(a => a !== appId);
      State.pinnedApps = State.pinnedApps.filter(a => a !== appId);
      saveState();
      toast(t("toast_removed"), AppRegistry[appId]?.name() || appId, "warn");
      WM.updateTaskButtons();
      renderDesktop();
      renderStartMenu();
    }

    /* ---------- Apps: Files ---------- */
    registerApp({
      id: "fileman",
      nameKey: "file_manager",
      descKey: "files_desc",
      icon: Icons.folder,
      category: "System",
      launch: (args={}) => {
        const startPath = args.path || "/home/user";
        const win = WM.createWindow({
          appId: "fileman",
          title: t("file_manager"),
          icon: Icons.folder,
          width: 920,
          height: 560,
          contentHTML: `<div class="fm">
            <div class="fmNav">
              <div class="sectionTitle">${t("desktop")}</div>
              <div class="miniList" id="fmQuick"></div>
              <div class="hr"></div>
              <div class="sectionTitle">${t("tips")}</div>
              <div class="hint">Double‑click a file to open. Use Upload to bring files from your device.</div>
              <div class="hint" style="margin-top:8px;">Terminal commands work on the same storage.</div>
            </div>
            <div class="fmMain">
              <div class="fmBar">
                <button class="btn" id="fmUp">${Icons.chevron} <span class="sr-only">Up</span></button>
                <span class="crumb" id="fmCrumb"></span>
                <span class="grow"></span>
                <button class="btn" id="fmNewFolder">${Icons.plus} ${t("create_folder")}</button>
                <button class="btn" id="fmNewFile">${Icons.doc} ${t("create_file")}</button>
                <button class="btn" id="fmUpload">${Icons.upload} ${t("upload")}</button>
              </div>
              <div class="fmList" id="fmList"></div>
            </div>
          </div>`
        });

        let cwd = FS.norm(startPath);

        async function refresh(){
          $("#fmCrumb", win.el).textContent = cwd;
          const items = (await FS.list(cwd)).sort((a,b) => {
            if(a.type !== b.type) return a.type === "dir" ? -1 : 1;
            return a.name.localeCompare(b.name);
          });

          const list = $("#fmList", win.el);
          if(items.length === 0){
            list.innerHTML = `<div class="hint">Empty folder.</div>`;
          } else {
            list.innerHTML = items.map(it => `
              <div class="fileRow" data-path="${safeText(it.path)}">
                <div class="left">
                  <span class="badge">${it.type==="dir" ? Icons.folder : fileIcon(it)}</span>
                  <div class="fname">${safeText(it.name)}</div>
                </div>
                <div class="meta">${it.type==="dir" ? "" : bytes(it.size)} • ${formatDate(it.mtime)}</div>
              </div>
            `).join("");
          }

          $$(".fileRow", win.el).forEach(row => {
            row.addEventListener("dblclick", async () => {
              const p = row.getAttribute("data-path");
              const node = await FS.get(p);
              if(!node) return;
              if(node.type === "dir"){ cwd = node.path; await refresh(); }
              else { openFile(node.path); }
            });
            row.addEventListener("click", async () => {
              // single-click shows actions
              const p = row.getAttribute("data-path");
              const node = await FS.get(p);
              if(!node) return;
              showItemActions(node
              );
            });
          });
        }

        function fileIcon(node){
          const ext = (node.name.split(".").pop()||"").toLowerCase();
          if(ext === "csv") return Icons.sheet;
          if(ext === "zslides") return Icons.slides;
          if(ext === "txt" || ext === "html" || ext === "md") return Icons.doc;
          if(node.mime?.startsWith("image/")) return "🖼️";
          return "📄";
        }

        function showItemActions(node){
          showModal({
            title: node.name,
            bodyHTML: `
              <div class="col">
                <div class="row wrap">
                  <span class="badge">${node.type === "dir" ? "DIR" : (node.mime || "file")}</span>
                  <span class="badge">${safeText(node.path)}</span>
                </div>
                <div class="row wrap">
                  <button class="btn primary" id="actOpen">${Icons.open} ${t("open")}</button>
                  ${node.type==="file" ? `<button class="btn" id="actDownload">${Icons.download} ${t("download")}</button>` : ""}
                  <button class="btn" id="actRename">${Icons.edit} ${t("rename")}</button>
                  <button class="btn danger" id="actDelete">${Icons.trash} ${t("delete")}</button>
                </div>
                <div class="hint">${node.type==="dir" ? "Open to enter folder." : "Open to view/edit. Download saves to your device."}</div>
              </div>
            `,
            actions: []
          });

          $("#actOpen")?.addEventListener("click", async () => {
            hideModal();
            if(node.type === "dir"){ cwd = node.path; await refresh(); }
            else openFile(node.path);
          });
          $("#actDownload")?.addEventListener("click", async () => {
            hideModal();
            const fresh = await FS.get(node.path);
            if(fresh?.type==="file") downloadNode(fresh);
          });
          $("#actRename")?.addEventListener("click", async () => {
            const newName = await promptText(t("rename"), t("name"), node.name, node.name);
            if(!newName){ return; }
            hideModal();
            const dst = FS.norm((FS.parent(node.path) || "/") + "/" + newName);
            try{
              await FS.move(node.path, dst);
              await refresh();
            }catch(e){
              toast(t("toast_error"), String(e.message || e), "bad");
            }
          });
          $("#actDelete")?.addEventListener("click", async () => {
            const ok = await confirmYesNo(t("delete"), `Delete "${node.name}"?`);
            if(!ok) return;
            hideModal();
            try{
              if(node.type === "dir"){
                const kids = await FS.list(node.path);
                if(kids.length){
                  toast(t("toast_error"), "Folder not empty.", "bad");
                  return;
                }
              }
              await FS.del(node.path);
              await refresh();
            }catch(e){
              toast(t("toast_error"), String(e.message || e), "bad");
            }
          });
        }

        $("#fmUp", win.el).addEventListener("click", async () => {
          const p = FS.parent(cwd);
          if(p){ cwd = p; await refresh(); }
        });
        $("#fmNewFolder", win.el).addEventListener("click", async () => {
          const name = await promptText(t("create_folder"), t("name"), "New folder", "New Folder");
          if(!name) return;
          const newPath = FS.norm(cwd + "/" + name);
          await FS.ensureDir(newPath);
          await refresh();
        });
        $("#fmNewFile", win.el).addEventListener("click", async () => {
          const name = await promptText(t("create_file"), t("name"), "New file.txt", "New file.txt");
          if(!name) return;
          const newPath = FS.norm(cwd + "/" + name);
          await FS.writeFile(newPath, new Blob([""], {type:"text/plain"}), "text/plain");
          await refresh();
        });
        $("#fmUpload", win.el).addEventListener("click", async () => {
          const input = document.createElement("input");
          input.type = "file";
          input.multiple = true;
          input.onchange = async () => {
            const files = Array.from(input.files || []);
            for(const f of files){
              await FS.writeFile(FS.norm(cwd + "/" + f.name), f, f.type || "application/octet-stream");
            }
            toast(t("toast_saved"), `${files.length} file(s) uploaded.`, "ok");
            await refresh();
          };
          input.click();
        });

        // Quick places
        const quick = $("#fmQuick", win.el);
        const places = [
          {name: t("home"), path:"/home/user"},
          {name: t("documents"), path:"/home/user/Documents"},
          {name: t("downloads"), path:"/home/user/Downloads"},
          {name: t("pictures"), path:"/home/user/Pictures"},
        ];
        quick.innerHTML = places.map(p => `
          <div class="miniItem" data-path="${safeText(p.path)}">
            <div class="left">
              <span class="badge">${Icons.folder}</span>
              <div>
                <div class="title">${safeText(p.name)}</div>
                <div class="sub">${safeText(p.path)}</div>
              </div>
            </div>
            <span class="muted2">${Icons.chevron}</span>
          </div>
        `).join("");
        $$(".miniItem", quick).forEach(el => {
          el.addEventListener("click", async () => {
            cwd = el.getAttribute("data-path");
            await refresh();
          });
        });

        refresh();
      }
    });

    /* ---------- Apps: Terminal ---------- */
    registerApp({
      id: "terminal",
      nameKey: "terminal",
      descKey: "terminal_desc",
      icon: Icons.terminal,
      category: "System",
      launch: (args={}) => {
        const win = WM.createWindow({
          appId: "terminal",
          title: t("terminal"),
          icon: Icons.terminal,
          width: 860,
          height: 520,
          contentHTML: `
            <div class="term">
              <div class="termOut" id="termOut"></div>
              <div class="termIn">
                <span class="prompt" id="termPrompt">user@webos:~$</span>
                <input id="termInput" autocomplete="off" spellcheck="false" />
              </div>
            </div>
          `
        });

        let cwd = "/home/user";
        const out = $("#termOut", win.el);
        const input = $("#termInput", win.el);
        const prompt = $("#termPrompt", win.el);

        function updatePrompt(){
          const short = cwd.replace("/home/user", "~");
          prompt.textContent = `user@webos:${short}$`;
        }
        updatePrompt();

        function print(line=""){
          out.textContent += line + "\n";
          out.scrollTop = out.scrollHeight;
        }
        function printBlock(lines){
          out.textContent += lines.join("\n") + "\n";
          out.scrollTop = out.scrollHeight;
        }

        print(`WebOS Terminal — type "help"`);
        print("");

        async function cmd_help(){
          printBlock([
            "Commands:",
            "  help                 Show this help",
            "  ls [dir]              List directory",
            "  cd <dir>              Change directory",
            "  pwd                   Print working directory",
            "  cat <file>            Print text file",
            "  touch <file>          Create empty file",
            "  mkdir <dir>           Create directory",
            "  rm <file|dir>         Delete file (dir must be empty)",
            "  open <path>           Open file/folder in UI",
            "  apps                  List installed apps",
            "  install <appId>       Install a built-in app (same as Discover)",
            "  pacman -S <appId>     Alias for install",
            "  flatpak info          Explain Flatpak limitation",
            "  neofetch              System info (simulated)",
            "  theme <dark|light>    Change theme",
            "  lang <en|pl>          Change language",
            "  clear                 Clear screen",
            "",
            "Tip: Paths are stored in your browser (IndexedDB)."
          ]);
        }

        async function run(line){
          const raw = line.trim();
          if(!raw) return;
          const parts = raw.split(/\s+/);
          const cmd = parts[0];
          const args = parts.slice(1);

          const resolvePath = (p) => {
            if(!p) return cwd;
            if(p.startsWith("/")) return FS.norm(p);
            if(p === "~") return "/home/user";
            return FS.norm(cwd + "/" + p);
          };

          try{
            switch(cmd){
              case "help": await cmd_help(); break;
              case "clear": out.textContent = ""; break;
              case "pwd": print(cwd); break;
              case "ls": {
                const dir = resolvePath(args[0] || cwd);
                const items = await FS.list(dir);
                const names = items.map(n => n.type === "dir" ? (n.name + "/") : n.name).sort();
                print(names.join("  "));
                break;
              }
              case "cd": {
                const dir = resolvePath(args[0] || "/home/user");
                const node = await FS.get(dir);
                if(node && node.type === "dir"){ cwd = dir; updatePrompt(); }
                else print(`cd: not a directory: ${dir}`);
                break;
              }
              case "cat": {
                const p = resolvePath(args[0]);
                const node = await FS.get(p);
                if(!node || node.type !== "file"){ print(`cat: not a file: ${p}`); break; }
                const txt = await node.data.text();
                print(txt);
                break;
              }
              case "touch": {
                const p = resolvePath(args[0]);
                await FS.writeFile(p, new Blob([""],{type:"text/plain"}), "text/plain");
                print(`created: ${p}`);
                break;
              }
              case "mkdir": {
                const p = resolvePath(args[0]);
                await FS.ensureDir(p);
                print(`dir: ${p}`);
                break;
              }
              case "rm": {
                const p = resolvePath(args[0]);
                const node = await FS.get(p);
                if(!node){ print(`rm: not found: ${p}`); break; }
                if(node.type === "dir"){
                  const kids = await FS.list(p);
                  if(kids.length){ print("rm: dir not empty"); break; }
                }
                await FS.del(p);
                print(`deleted: ${p}`);
                break;
              }
              case "open": {
                const p = resolvePath(args[0]);
                const node = await FS.get(p);
                if(!node){ print(`open: not found: ${p}`); break; }
                if(node.type === "dir") openApp("fileman", {path:p});
                else openFile(p);
                break;
              }
              case "apps": {
                print("Installed apps:");
                for(const a of State.installedApps){
                  const app = AppRegistry[a];
                  if(app) print(`  ${a}  —  ${app.name()}`);
                }
                break;
              }
              case "install": {
                const id = args[0];
                if(!id){ print("install: missing appId"); break; }
                if(!AppRegistry[id]){ print("install: unknown appId"); break; }
                installApp(id);
                print(`installed: ${id}`);
                break;
              }
              case "pacman": {
                if(args[0] === "-S"){
                  const id = args[1];
                  if(!id){ print("pacman -S: missing package"); break; }
                  if(!AppRegistry[id]){ print("pacman: package not found"); break; }
                  installApp(id);
                  print(`:: installed ${id} (simulated)`);
                } else {
                  print("pacman: supported: pacman -S <appId> (simulated)");
                }
                break;
              }
              case "flatpak": {
                const sub = args[0] || "";
                if(!sub || sub === "help"){
                  print("flatpak commands:");
                  print("  flatpak search <query>      (online Flathub search)");
                  print("  flatpak install <appId>     (runs via Host Agent or shows copy command)");
                  print("  flatpak run <appId>");
                  print("  flatpak uninstall <appId>");
                  print("  flatpak list                (uses Agent if configured)");
                  break;
                }
                if(sub === "search"){
                  const q = args.slice(1).join(" ").trim();
                  if(!q){ print("flatpak search: missing query"); break; }
                  print(`Searching Flathub: ${q} ...`);
                  const results = await flatpakSearchOnline(q);
                  if(!results.length){ print("No results."); break; }
                  results.slice(0,10).forEach(r => print(`  ${r.id}  —  ${r.name}`));
                  break;
                }
                if(sub === "list"){
                  const installed = await flatpakListInstalled();
                  if(!installed.length){ print("(no installed flatpaks found / cached)"); break; }
                  installed.forEach(id => print("  " + id));
                  break;
                }
                if(sub === "install"){
                  const id = args[1];
                  if(!id){ print("flatpak install: missing appId"); break; }
                  const cmd = flatpakInstallCommand(id);
                  await runHostOrShow(cmd, `Flatpak install: ${id}`);
                  if(!agentBase()){
                    State.flatpakInstalled = Array.isArray(State.flatpakInstalled) ? State.flatpakInstalled : [];
                    if(!State.flatpakInstalled.includes(id)) State.flatpakInstalled.push(id);
                    saveState();
                  }else{
                    await flatpakListInstalled();
                  }
                  break;
                }
                if(sub === "uninstall"){
                  const id = args[1];
                  if(!id){ print("flatpak uninstall: missing appId"); break; }
                  const ok = await confirmYesNo(t("uninstall"), id);
                  if(!ok){ print("Canceled."); break; }
                  const cmd = flatpakUninstallCommand(id);
                  await runHostOrShow(cmd, `Flatpak uninstall: ${id}`);
                  if(!agentBase()){
                    State.flatpakInstalled = (State.flatpakInstalled||[]).filter(x => x !== id);
                    saveState();
                  }else{
                    await flatpakListInstalled();
                  }
                  break;
                }
                if(sub === "run"){
                  const id = args[1];
                  if(!id){ print("flatpak run: missing appId"); break; }
                  const cmd = flatpakRunCommand(id);
                  await runHostOrShow(cmd, `Flatpak run: ${id}`);
                  break;
                }
                // fallback: treat the rest as raw flatpak command
                const cmd = "flatpak " + args.join(" ");
                await runHostOrShow(cmd, "flatpak");
                break;
              }
              case "distrobox": {
                const sub = args[0] || "";
                if(!sub || sub === "help"){
                  print("distrobox commands:");
                  print("  distrobox list");
                  print("  distrobox create <name> <image>");
                  print("  distrobox rm <name>");
                  print("  distrobox enter <name>   (copies command)");
                  break;
                }
                if(sub === "list"){
                  await runHostOrShow("distrobox list", "distrobox list");
                  break;
                }
                if(sub === "create"){
                  const n = args[1];
                  const i = args[2];
                  if(!n || !i){ print("distrobox create: name + image required"); break; }
                  await runHostOrShow(`distrobox create --name ${n} --image ${i} --yes`, "distrobox create");
                  break;
                }
                if(sub === "rm"){
                  const n = args[1];
                  if(!n){ print("distrobox rm: missing name"); break; }
                  const ok = await confirmYesNo(t("remove"), n);
                  if(!ok){ print("Canceled."); break; }
                  await runHostOrShow(`distrobox rm ${n} --force`, "distrobox rm");
                  break;
                }
                if(sub === "enter"){
                  const n = args[1];
                  if(!n){ print("distrobox enter: missing name"); break; }
                  const cmd = `distrobox enter ${n}`;
                  print(cmd);
                  await copyToClipboard(cmd);
                  print("(" + t("copied") + ")");
                  break;
                }
                const cmd = "distrobox " + args.join(" ");
                await runHostOrShow(cmd, "distrobox");
                break;
              }
              case "host": {
                const cmd = args.join(" ").trim();
                if(!cmd){ print("host: missing command"); break; }
                await runHostOrShow(cmd, "Host command");
                break;
              }
              case "neofetch": {
                printBlock([
                  "       /\\",
                  "      /  \\     WebOS Desktop (browser UI)",
                  "     /\\   \\    Host: " + navigator.platform,
                  "    /      \\   Browser: " + navigator.userAgent.split(")")[0] + ")",
                  "   /   ,,   \\  Theme: " + State.settings.theme,
                  "  /   |  |  -\\ Accent: " + (State.settings.accent || "#4a8cff"),
                  " /_-''    ''-_\\ Storage: IndexedDB + LocalStorage",
                ]);
                break;
              }
              case "theme": {
                const v = (args[0]||"").toLowerCase();
                if(!["dark","light"].includes(v)){ print("theme: dark|light"); break; }
                State.settings.theme = v;
                applyTheme();
                saveState();
                print(`theme: ${v}`);
                renderDesktop(); renderStartMenu(); WM.updateTaskButtons(); refreshShellLabels(); WM.applyDesktopVisibility();
                break;
              }
              case "lang": {
                const v = (args[0]||"").toLowerCase();
                if(!["en","pl"].includes(v)){ print("lang: en|pl"); break; }
                State.settings.language = v;
                applyTheme();
                saveState();
                print(`lang: ${v}`);
                renderDesktop(); renderStartMenu(); WM.updateTaskButtons();
                break;
              }
              default:
                print(`command not found: ${cmd}`);
            }
          }catch(e){
            print(`error: ${e.message || e}`);
          }
        }

        input.addEventListener("keydown", async (e) => {
          if(e.key === "Enter"){
            const line = input.value;
            input.value = "";
            print(`${prompt.textContent} ${line}`);
            await run(line);
          }
        });

        setTimeout(() => input.focus(), 50);
      }
    });

    /* ---------- Apps: Writer ---------- */
    registerApp({
      id: "writer",
      nameKey: "writer",
      descKey: "writer_desc",
      icon: Icons.doc,
      category: "Productivity",
      launch: async (args={}) => {
        const win = WM.createWindow({
          appId: "writer",
          title: t("writer"),
          icon: Icons.doc,
          width: 980,
          height: 640,
          contentHTML: `
            <div class="writerBar">
              <button class="btn" id="wNew">${Icons.plus} ${t("new")}</button>
              <button class="btn" id="wOpen">${Icons.open} ${t("open")}</button>
              <button class="btn primary" id="wSave">${Icons.save} ${t("save")}</button>
              <button class="btn" id="wSaveAs">${Icons.save} ${t("save_as")}</button>
              <span class="badge" id="wPathBadge"></span>
              <span class="grow"></span>
              <button class="btn" data-cmd="bold"><b>B</b></button>
              <button class="btn" data-cmd="italic"><i>I</i></button>
              <button class="btn" data-cmd="underline"><u>U</u></button>
              <button class="btn" data-cmd="insertUnorderedList">• List</button>
              <button class="btn" data-cmd="formatBlock" data-arg="h2">H2</button>
              <button class="btn" data-cmd="formatBlock" data-arg="p">P</button>
            </div>
            <div class="writerEditor">
              <div class="writerPaper" id="wPaper" contenteditable="true" spellcheck="true"></div>
            </div>
          `
        });

        let currentPath = args.path ? FS.norm(args.path) : null;
        const paper = $("#wPaper", win.el);
        const badge = $("#wPathBadge", win.el);

        function setBadge(){
          badge.textContent = currentPath ? currentPath : "(unsaved)";
        }

        async function loadPath(path){
          const node = await FS.get(path);
          if(!node || node.type !== "file"){
            toast(t("toast_error"), "File not found.", "bad");
            return;
          }
          const ext = (FS.name(path).split(".").pop()||"").toLowerCase();
          if(node.mime?.startsWith("image/")){
            // image preview mode
            const url = URL.createObjectURL(node.data);
            paper.innerHTML = `<h2>${safeText(node.name)}</h2><p class="muted">${safeText(node.mime)} • ${bytes(node.size)}</p><p><img src="${url}" style="max-width:100%; border-radius:12px; border:1px solid var(--border);" /></p>`;
            paper.setAttribute("contenteditable", "false");
            currentPath = path;
            win.setTitle(`${t("writer")} — ${node.name}`);
            setBadge();
            return;
          }

          const text = await node.data.text();
          if(ext === "html" || ext === "htm" || node.mime === "text/html"){
            paper.innerHTML = text;
          } else {
            paper.textContent = text;
          }
          paper.setAttribute("contenteditable", "true");
          currentPath = path;
          win.setTitle(`${t("writer")} — ${node.name}`);
          setBadge();
        }

        async function pickFile(){
          const files = await FS.list("/home/user/Documents");
          const fileChoices = files.filter(f => f.type === "file").map(f => f.path);
          const html = `
            <div class="col">
              <div class="hint">Pick a file from <span class="kbd">/home/user/Documents</span> (quick picker).</div>
              <select id="wPick" class="input">
                ${fileChoices.map(p => `<option value="${safeText(p)}">${safeText(FS.name(p))}</option>`).join("")}
              </select>
            </div>
          `;
          return new Promise((resolve) => {
            showModal({
              title: t("open"),
              bodyHTML: html,
              actions: [
                {label: t("cancel"), onClick: () => resolve(null)},
                {label: t("open"), kind:"primary", onClick: () => resolve($("#wPick").value)}
              ]
            });
          });
        }

        async function save(toPath=null){
          const html = paper.innerHTML;
          const plain = paper.innerText || "";
          let path = toPath || currentPath;
          if(!path){
            path = await promptText(t("save_as"), t("path"), "/home/user/Documents/MyDoc.html", "/home/user/Documents/MyDoc.html");
            if(!path) return;
          }
          path = FS.norm(path);
          const ext = (FS.name(path).split(".").pop()||"").toLowerCase();
          if(ext === "txt" || ext === "md"){
            await FS.writeFile(path, new Blob([plain], {type:"text/plain"}), "text/plain");
          } else {
            await FS.writeFile(path, new Blob([html], {type:"text/html"}), "text/html");
          }
          currentPath = path;
          setBadge();
          win.setTitle(`${t("writer")} — ${FS.name(path)}`);
          toast(t("toast_saved"), FS.name(path), "ok");
          State.recentFiles = [path, ...State.recentFiles.filter(p => p !== path)].slice(0,8);
          saveState();
          renderStartMenu();
        }

        $("#wNew", win.el).addEventListener("click", () => {
          currentPath = null;
          paper.innerHTML = `<h1>New document</h1><p>Write here…</p>`;
          paper.setAttribute("contenteditable", "true");
          win.setTitle(t("writer"));
          setBadge();
        });
        $("#wOpen", win.el).addEventListener("click", async () => {
          const p = await pickFile();
          if(p) await loadPath(p);
        });
        $("#wSave", win.el).addEventListener("click", async () => save());
        $("#wSaveAs", win.el).addEventListener("click", async () => save(null));

        // formatting buttons
        $$("button[data-cmd]", win.el).forEach(btn => {
          btn.addEventListener("click", () => {
            const cmd = btn.getAttribute("data-cmd");
            const arg = btn.getAttribute("data-arg");
            // execCommand is deprecated but still widely supported and perfect for a single-file demo
            if(cmd === "formatBlock"){
              document.execCommand(cmd, false, `<${arg}>`);
            } else {
              document.execCommand(cmd, false, null);
            }
            paper.focus();
          });
        });

        // load initial
        if(currentPath) await loadPath(currentPath);
        else paper.innerHTML = `<h1>Welcome</h1><p>This is <b>Writer</b> — a lightweight offline editor.</p><ul><li>Save to <span class="kbd">/home/user/Documents</span></li><li>Open files from the same folder quickly</li></ul>`;

        setBadge();
        setTimeout(() => paper.focus(), 50);
      }
    });

    /* ---------- Apps: Sheets ---------- */
    registerApp({
      id: "sheets",
      nameKey: "sheets",
      descKey: "sheets_desc",
      icon: Icons.sheet,
      category: "Productivity",
      launch: async (args={}) => {
        const win = WM.createWindow({
          appId: "sheets",
          title: t("sheets"),
          icon: Icons.sheet,
          width: 980,
          height: 640,
          contentHTML: `
            <div class="sheetBar">
              <button class="btn" id="sNew">${Icons.plus} ${t("new")}</button>
              <button class="btn" id="sOpen">${Icons.open} ${t("open")}</button>
              <button class="btn primary" id="sSave">${Icons.save} ${t("save")}</button>
              <button class="btn" id="sSaveAs">${Icons.save} ${t("save_as")}</button>
              <button class="btn" id="sExport">${Icons.download} CSV ${t("export")}</button>
              <span class="badge" id="sPathBadge"></span>
              <span class="grow"></span>
              <span class="hint">Formulas: <span class="kbd">=A1+B2</span>, <span class="kbd">=SUM(A1:A5)</span></span>
            </div>
            <div class="sheetWrap" id="sheetWrap"></div>
          `
        });

        const ROWS = 40;
        const COLS = 12; // A-L
        const COLNAMES = Array.from({length: COLS}, (_,i)=>String.fromCharCode(65+i));

        let grid = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => ""));
        let currentPath = args.path ? FS.norm(args.path) : null;

        const wrap = $("#sheetWrap", win.el);
        const badge = $("#sPathBadge", win.el);

        function setBadge(){ badge.textContent = currentPath ? currentPath : "(unsaved)"; }

        function refToCoord(ref){
          const m = /^([A-Z]+)(\d+)$/.exec(ref.toUpperCase());
          if(!m) return null;
          const col = m[1].charCodeAt(0) - 65;
          const row = parseInt(m[2],10) - 1;
          if(row<0||row>=ROWS||col<0||col>=COLS) return null;
          return {row,col};
        }

        function cellValue(row,col, visited=new Set()){
          const key = `${row},${col}`;
          if(visited.has(key)) return 0;
          visited.add(key);
          const v = grid[row][col] ?? "";
          if(typeof v === "string" && v.trim().startsWith("=")){
            return evalFormula(v.trim().slice(1), visited);
          }
          const num = Number(v);
          return Number.isFinite(num) ? num : 0;
        }

        function parseRange(rng){
          const m = /^([A-Z]+\d+):([A-Z]+\d+)$/.exec(rng.toUpperCase());
          if(!m) return null;
          const a = refToCoord(m[1]);
          const b = refToCoord(m[2]);
          if(!a||!b) return null;
          const r0 = Math.min(a.row,b.row), r1 = Math.max(a.row,b.row);
          const c0 = Math.min(a.col,b.col), c1 = Math.max(a.col,b.col);
          const coords = [];
          for(let r=r0;r<=r1;r++){
            for(let c=c0;c<=c1;c++){
              coords.push([r,c]);
            }
          }
          return coords;
        }

        function evalFormula(expr, visited){
          // functions: SUM, AVG, MIN, MAX over ranges
          const funcRe = /(SUM|AVG|MIN|MAX)\(([A-Z]+\d+:[A-Z]+\d+)\)/gi;
          expr = expr.replace(funcRe, (_,fn, range) => {
            const coords = parseRange(range);
            if(!coords) return "0";
            const vals = coords.map(([r,c]) => cellValue(r,c, visited));
            if(fn.toUpperCase()==="SUM") return String(vals.reduce((a,b)=>a+b,0));
            if(fn.toUpperCase()==="AVG") return String(vals.reduce((a,b)=>a+b,0) / (vals.length||1));
            if(fn.toUpperCase()==="MIN") return String(Math.min(...vals,0));
            if(fn.toUpperCase()==="MAX") return String(Math.max(...vals,0));
            return "0";
          });

          // substitute cell refs
          expr = expr.replace(/\b([A-Z]+\d+)\b/g, (m) => {
            const c = refToCoord(m);
            if(!c) return "0";
            return String(cellValue(c.row,c.col, visited));
          });

          // sanitize: allow digits, operators, whitespace, parentheses, dot, comma
          if(!/^[0-9+\-*/().,\s%]+$/.test(expr)) return NaN;
          try{
            // eslint-disable-next-line no-new-func
            const val = Function(`"use strict"; return (${expr});`)();
            return Number(val);
          }catch{
            return NaN;
          }
        }

        function displayValue(row,col){
          const v = grid[row][col] ?? "";
          if(typeof v === "string" && v.trim().startsWith("=")){
            const x = evalFormula(v.trim().slice(1), new Set());
            return Number.isFinite(x) ? String(x) : "#ERR";
          }
          return v;
        }

        function render(){
          const table = document.createElement("table");
          table.className = "sheet";
          const thead = document.createElement("thead");
          const trh = document.createElement("tr");
          const th0 = document.createElement("th");
          th0.className = "first";
          th0.textContent = "#";
          trh.appendChild(th0);
          for(const c of COLNAMES){
            const th = document.createElement("th");
            th.textContent = c;
            trh.appendChild(th);
          }
          thead.appendChild(trh);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");
          for(let r=0;r<ROWS;r++){
            const tr = document.createElement("tr");
            const head = document.createElement("td");
            head.className = "rowHead";
            head.textContent = String(r+1);
            tr.appendChild(head);

            for(let c=0;c<COLS;c++){
              const td = document.createElement("td");
              td.className = "cell";
              td.tabIndex = 0;
              td.dataset.r = String(r);
              td.dataset.c = String(c);
              const v = grid[r][c] ?? "";
              td.innerHTML = safeText(displayValue(r,c));
              if(typeof v === "string" && v.trim().startsWith("=")){
                td.classList.add("cellFormula");
              }
              td.addEventListener("focus", () => {
                // show raw value on focus
                td.textContent = String(grid[r][c] ?? "");
              });
              td.addEventListener("blur", () => {
                // on blur, show computed display
                td.textContent = displayValue(r,c);
              });
              td.addEventListener("keydown", (e) => {
                if(e.key === "Enter"){
                  e.preventDefault();
                  td.blur();
                }
              });
              td.addEventListener("input", () => {});
              td.addEventListener("paste", (e) => {
                // allow paste plain text
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData("text");
                document.execCommand("insertText", false, text);
              });
              td.contentEditable = "true";
              td.addEventListener("blur", () => {
                grid[r][c] = td.textContent;
                // update computed cells simply by rerender
                renderInto();
              });

              tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
          table.appendChild(tbody);
          return table;
        }

        function renderInto(){
          wrap.innerHTML = "";
          wrap.appendChild(render());
        }

        async function pickCSV(){
          const files = await FS.list("/home/user/Documents");
          const choices = files.filter(f => f.type==="file" && (f.name.toLowerCase().endsWith(".csv") || f.name.toLowerCase().endsWith(".json"))).map(f => f.path);
          const html = `
            <div class="col">
              <div class="hint">Pick a .csv or .json from <span class="kbd">/home/user/Documents</span>.</div>
              <select id="sPick" class="input">
                ${choices.map(p => `<option value="${safeText(p)}">${safeText(FS.name(p))}</option>`).join("")}
              </select>
            </div>
          `;
          return new Promise((resolve) => {
            showModal({
              title: t("open"),
              bodyHTML: html,
              actions: [
                {label: t("cancel"), onClick: () => resolve(null)},
                {label: t("open"), kind:"primary", onClick: () => resolve($("#sPick").value)}
              ]
            });
          });
        }

        function toCSV(){
          const lines = [];
          for(let r=0;r<ROWS;r++){
            const row = [];
            for(let c=0;c<COLS;c++){
              const v = grid[r][c] ?? "";
              const s = String(v).replace(/"/g,'""');
              row.push(/[,\"\n]/.test(s) ? `"${s}"` : s);
            }
            lines.push(row.join(","));
          }
          return lines.join("\n");
        }
        function fromCSV(text){
          const rows = [];
          let cur = "", inQ=false;
          let row = [];
          for(let i=0;i<text.length;i++){
            const ch = text[i];
            const next = text[i+1];
            if(inQ){
              if(ch === '"' && next === '"'){ cur += '"'; i++; }
              else if(ch === '"'){ inQ=false; }
              else cur += ch;
            } else {
              if(ch === '"'){ inQ=true; }
              else if(ch === ","){ row.push(cur); cur=""; }
              else if(ch === "\n"){ row.push(cur); rows.push(row); row=[]; cur=""; }
              else if(ch === "\r"){ /* ignore */ }
              else cur += ch;
            }
          }
          row.push(cur);
          rows.push(row);
          // fill grid
          grid = Array.from({length: ROWS}, (_,r) => Array.from({length: COLS}, (_,c) => (rows[r] && rows[r][c] != null) ? rows[r][c] : ""));
        }

        async function loadPath(path){
          const node = await FS.get(path);
          if(!node || node.type!=="file"){ toast(t("toast_error"), "File not found.", "bad"); return; }
          const ext = node.name.toLowerCase().split(".").pop();
          const text = await node.data.text();
          if(ext === "json"){
            try{
              const obj = JSON.parse(text);
              if(Array.isArray(obj.grid)){
                grid = obj.grid;
              } else {
                fromCSV(text);
              }
            }catch{ fromCSV(text); }
          } else {
            fromCSV(text);
          }
          currentPath = path;
          win.setTitle(`${t("sheets")} — ${node.name}`);
          setBadge();
          renderInto();
        }

        async function save(path=null){
          let p = path || currentPath;
          if(!p){
            p = await promptText(t("save_as"), t("path"), "/home/user/Documents/Sheet.csv", "/home/user/Documents/Sheet.csv");
            if(!p) return;
          }
          p = FS.norm(p);
          const ext = (FS.name(p).split(".").pop()||"").toLowerCase();
          if(ext === "json"){
            await FS.writeFile(p, new Blob([JSON.stringify({grid}, null, 2)], {type:"application/json"}), "application/json");
          } else {
            await FS.writeFile(p, new Blob([toCSV()], {type:"text/csv"}), "text/csv");
          }
          currentPath = p;
          win.setTitle(`${t("sheets")} — ${FS.name(p)}`);
          setBadge();
          toast(t("toast_saved"), FS.name(p), "ok");
          State.recentFiles = [p, ...State.recentFiles.filter(x => x !== p)].slice(0,8);
          saveState();
          renderStartMenu();
        }

        $("#sNew", win.el).addEventListener("click", () => {
          currentPath = null;
          grid = Array.from({length: ROWS}, () => Array.from({length: COLS}, () => ""));
          win.setTitle(t("sheets"));
          setBadge();
          renderInto();
        });
        $("#sOpen", win.el).addEventListener("click", async () => {
          const p = await pickCSV();
          if(p) await loadPath(p);
        });
        $("#sSave", win.el).addEventListener("click", async () => save());
        $("#sSaveAs", win.el).addEventListener("click", async () => save(null));
        $("#sExport", win.el).addEventListener("click", async () => {
          const csv = toCSV();
          const blob = new Blob([csv], {type:"text/csv"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "Sheet.csv";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 1000);
        });

        setBadge();
        renderInto();
        if(currentPath) await loadPath(currentPath);
      }
    });

    /* ---------- Apps: Slides ---------- */
    registerApp({
      id: "slides",
      nameKey: "slides",
      descKey: "slides_desc",
      icon: Icons.slides,
      category: "Productivity",
      launch: async (args={}) => {
        const win = WM.createWindow({
          appId: "slides",
          title: t("slides"),
          icon: Icons.slides,
          width: 1020,
          height: 640,
          contentHTML: `
            <div class="slides">
              <div class="slidesNav">
                <div class="row wrap">
                  <button class="btn" id="slAdd">${Icons.plus} ${t("new")}</button>
                  <button class="btn" id="slOpen">${Icons.open} ${t("open")}</button>
                  <button class="btn primary" id="slSave">${Icons.save} ${t("save")}</button>
                  <button class="btn" id="slSaveAs">${Icons.save} ${t("save_as")}</button>
                </div>
                <div class="hr"></div>
                <div id="slList"></div>
              </div>
              <div class="slidesMain">
                <div class="slidesBar">
                  <button class="btn" id="slPrev">${t("prev")}</button>
                  <button class="btn" id="slNext">${t("next")}</button>
                  <button class="btn primary" id="slPresent">${Icons.play} ${t("present")}</button>
                  <span class="badge" id="slPathBadge"></span>
                  <span class="grow"></span>
                  <span class="hint">Slides are simple (title + bullets). Export/backup in Settings.</span>
                </div>
                <div class="slideCanvasWrap">
                  <div class="slideCanvas" id="slCanvas"></div>
                </div>
              </div>
            </div>
          `
        });

        let deck = [
          {title: "Welcome", bullets:["This is Slides (offline).", "Add slides on the left.", "Present with arrow keys."]},
          {title: "Limits", bullets:["Single HTML file cannot run real .exe/Flatpak.", "Use VM Hub for remote VMs."]},
        ];
        let idx = 0;
        let currentPath = args.path ? FS.norm(args.path) : null;

        const listEl = $("#slList", win.el);
        const canvas = $("#slCanvas", win.el);
        const badge = $("#slPathBadge", win.el);

        function setBadge(){ badge.textContent = currentPath ? currentPath : "(unsaved)"; }

        function renderList(){
          listEl.innerHTML = deck.map((s,i)=>`
            <div class="slideThumb ${i===idx?'active':''}" data-i="${i}">
              <div class="t">${safeText(s.title || "Untitled")}</div>
              <div class="b">${safeText((s.bullets||[]).join(" • "))}</div>
            </div>
          `).join("");
          $$(".slideThumb", listEl).forEach(el => {
            el.addEventListener("click", () => {
              idx = parseInt(el.dataset.i,10);
              renderAll();
            });
          });
        }

        function renderCanvas(){
          const s = deck[idx] || {title:"", bullets:[]};
          canvas.innerHTML = `
            <div class="field">
              <div class="muted">Title</div>
              <input class="input" id="slTitle" value="${safeText(s.title)}" />
            </div>
            <div class="field" style="margin-top:10px;">
              <div class="muted">Bullets (one per line)</div>
              <textarea class="input" id="slBullets">${safeText((s.bullets||[]).join("\n"))}</textarea>
            </div>
            <div class="row wrap" style="margin-top:12px;">
              <button class="btn" id="slDel">${Icons.trash} ${t("delete")}</button>
            </div>
          `;
          $("#slTitle", win.el).addEventListener("input", (e) => {
            deck[idx].title = e.target.value;
            renderList();
          });
          $("#slBullets", win.el).addEventListener("input", (e) => {
            deck[idx].bullets = e.target.value.split("\n").map(x=>x.trim()).filter(Boolean);
            renderList();
          });
          $("#slDel", win.el).addEventListener("click", async () => {
            if(deck.length <= 1){ toast(t("toast_error"), "Can't delete last slide.", "bad"); return; }
            const ok = await confirmYesNo(t("delete"), "Delete this slide?");
            if(!ok) return;
            deck.splice(idx,1);
            idx = clamp(idx, 0, deck.length-1);
            renderAll();
          });
        }

        function renderAll(){
          renderList();
          renderCanvas();
        }

        function present(){
          const overlay = $("#presentOverlay");
          const hint = $("#presentHint");
          overlay.classList.add("active");
          overlay.setAttribute("aria-hidden","false");
          hint.style.display = "block";

          function renderSlide(i){
            const s = deck[i] || {title:"", bullets:[]};
            overlay.innerHTML = `
              <div class="presentSlide">
                <h1>${safeText(s.title || "Untitled")}</h1>
                <ul>${(s.bullets||[]).map(b=>`<li>${safeText(b)}</li>`).join("")}</ul>
              </div>
            `;
          }
          renderSlide(idx);

          const onKey = (e) => {
            if(e.key === "Escape"){
              exit();
            } else if(e.key === "ArrowRight" || e.key === "PageDown"){
              idx = clamp(idx+1, 0, deck.length-1);
              renderSlide(idx);
              renderList();
            } else if(e.key === "ArrowLeft" || e.key === "PageUp"){
              idx = clamp(idx-1, 0, deck.length-1);
              renderSlide(idx);
              renderList();
            }
          };
          function exit(){
            overlay.classList.remove("active");
            overlay.setAttribute("aria-hidden","true");
            overlay.innerHTML = "";
            hint.style.display = "none";
            window.removeEventListener("keydown", onKey);
          }
          overlay.addEventListener("click", exit, {once:true});
          window.addEventListener("keydown", onKey);
        }

        async function pickDeck(){
          const files = await FS.list("/home/user/Documents");
          const choices = files.filter(f => f.type==="file" && f.name.toLowerCase().endsWith(".zslides")).map(f => f.path);
          const html = `
            <div class="col">
              <div class="hint">Pick a <span class="kbd">.zslides</span> from <span class="kbd">/home/user/Documents</span>.</div>
              <select id="slPick" class="input">
                ${choices.map(p => `<option value="${safeText(p)}">${safeText(FS.name(p))}</option>`).join("")}
              </select>
            </div>
          `;
          return new Promise((resolve) => {
            showModal({
              title: t("open"),
              bodyHTML: html,
              actions: [
                {label: t("cancel"), onClick: () => resolve(null)},
                {label: t("open"), kind:"primary", onClick: () => resolve($("#slPick").value)}
              ]
            });
          });
        }

        async function loadPath(path){
          const node = await FS.get(path);
          if(!node || node.type!=="file"){ toast(t("toast_error"), "File not found.", "bad"); return; }
          const text = await node.data.text();
          try{
            const obj = JSON.parse(text);
            if(Array.isArray(obj.deck)) deck = obj.deck;
            else if(Array.isArray(obj)) deck = obj;
          }catch(e){
            toast(t("toast_error"), "Invalid slides file.", "bad");
            return;
          }
          idx = 0;
          currentPath = path;
          win.setTitle(`${t("slides")} — ${node.name}`);
          setBadge();
          renderAll();
        }

        async function save(path=null){
          let p = path || currentPath;
          if(!p){
            p = await promptText(t("save_as"), t("path"), "/home/user/Documents/Deck.zslides", "/home/user/Documents/Deck.zslides");
            if(!p) return;
          }
          p = FS.norm(p);
          if(!p.toLowerCase().endsWith(".zslides")) p += ".zslides";
          await FS.writeFile(p, new Blob([JSON.stringify({deck}, null, 2)], {type:"application/json"}), "application/json");
          currentPath = p;
          win.setTitle(`${t("slides")} — ${FS.name(p)}`);
          setBadge();
          toast(t("toast_saved"), FS.name(p), "ok");
          State.recentFiles = [p, ...State.recentFiles.filter(x => x !== p)].slice(0,8);
          saveState();
          renderStartMenu();
        }

        $("#slAdd", win.el).addEventListener("click", () => {
          deck.push({title:"New slide", bullets:["Point 1","Point 2"]});
          idx = deck.length-1;
          renderAll();
        });
        $("#slPrev", win.el).addEventListener("click", () => { idx = clamp(idx-1, 0, deck.length-1); renderAll(); });
        $("#slNext", win.el).addEventListener("click", () => { idx = clamp(idx+1, 0, deck.length-1); renderAll(); });
        $("#slPresent", win.el).addEventListener("click", present);
        $("#slOpen", win.el).addEventListener("click", async () => {
          const p = await pickDeck();
          if(p) await loadPath(p);
        });
        $("#slSave", win.el).addEventListener("click", async () => save());
        $("#slSaveAs", win.el).addEventListener("click", async () => save(null));

        setBadge();
        renderAll();
        if(currentPath) await loadPath(currentPath);
      }
    });

    /* ---------- Apps: VM Hub ---------- */
    registerApp({
      id: "vmhub",
      nameKey: "vm_hub",
      descKey: "vm_desc",
      icon: Icons.vm,
      category: "System",
      launch: () => {
        const win = WM.createWindow({
          appId: "vmhub",
          title: t("vm_hub"),
          icon: Icons.vm,
          width: 900,
          height: 560,
          contentHTML: `<div class="appPad">
            <div class="row wrap">
              <button class="btn primary" id="vmAdd">${Icons.plus} ${t("vm_add")}</button>
              <span class="badge warn">${Icons.info} ${t("about_limits")}</span>
            </div>
            <div class="card" style="margin-top:12px;">
              <div class="cardTitle">${t("about_limits")}</div>
              <div class="hint">${safeText(t("limits_msg"))}</div>
            </div>
            <div class="hr"></div>
            <div class="sectionTitle">VM Shortcuts</div>
            <div id="vmList" class="miniList"></div>
            <div class="hr"></div>
            <div class="sectionTitle">Pro tips</div>
            <div class="hint">
              • If you have a server running a VM with <span class="kbd">noVNC</span>, paste the full URL here.<br>
              • If your browser blocks iframes from <span class="kbd">file://</span>, choose <b>New tab</b> mode or host this HTML via a local web server.
            </div>
          </div>`
        });

    /* ---------- Apps: Arch Desktop (noVNC) ---------- */
    registerApp({
      id: "archdesk",
      nameKey: "archdesk",
      descKey: "archdesk_desc",
      icon: Icons.desk,
      category: "System",
      launch: () => {
        const win = WM.createWindow({
          appId: "archdesk",
          title: t("archdesk"),
          icon: Icons.desk,
          width: 980,
          height: 640,
          contentHTML: `
            <div class="appPad">
              <div class="sectionTitle">${t("archdesk")}</div>
              <div class="card">
                <div class="field">
                  <div class="muted">${t("archdesk_url")}</div>
                  <input class="input" id="adUrl" placeholder="http://localhost:3000/" />
                  <div class="hint">${t("archdesk_hint")}</div>
                </div>
                <div class="row wrap" style="margin-top:10px;">
                  <button class="btn primary" id="adOpenWin">${Icons.vm} ${t("open_in_window")}</button>
                  <button class="btn" id="adOpenTab">${Icons.open} ${t("open_in_tab")}</button>
                  <span class="grow"></span>
                  <button class="btn" id="adToVM">${Icons.vm} ${t("vm_hub")}</button>
                </div>
              </div>

              <div class="hr"></div>
              <div class="sectionTitle">${t("tips")}</div>
              <div class="hint">
                ${t("archdesk_tip1")}<br/>
                ${t("archdesk_tip2")}
              </div>
            </div>
          `
        });

        const inp = $("#adUrl", win.el);
        inp.value = State.settings.archDesktopUrl || "http://localhost:3000/";
        inp.addEventListener("change", () => {
          State.settings.archDesktopUrl = inp.value.trim();
          saveState();
        });

        $("#adOpenTab", win.el).addEventListener("click", () => {
          const url = (inp.value||"").trim();
          if(!url) return;
          window.open(url, "_blank", "noopener,noreferrer");
        });

        $("#adOpenWin", win.el).addEventListener("click", () => {
          const url = (inp.value||"").trim();
          if(!url) return;
          WM.createWindow({
            appId: "archdesk",
            title: `${t("archdesk")} — ${safeText(url)}`,
            icon: Icons.desk,
            width: 1180,
            height: 720,
            minWidth: 520,
            minHeight: 360,
            contentHTML: `
              <div class="col" style="height:100%;">
                <div class="row" style="padding:10px; gap:10px;">
                  <button class="btn" id="adOpenTab2">${Icons.open} ${t("open_in_tab")}</button>
                  <div class="badge" style="max-width: calc(100% - 160px); overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                    ${safeText(url)}
                  </div>
                </div>
                <div style="flex:1; overflow:hidden;">
                  <iframe src="${safeText(url)}" style="border:0; width:100%; height:100%; background:#000;" referrerpolicy="no-referrer"></iframe>
                </div>
              </div>
            `,
            onInit: (w) => {
              $("#adOpenTab2", w.el).addEventListener("click", () => window.open(url, "_blank", "noopener,noreferrer"));
            }
          });
        });

        $("#adToVM", win.el).addEventListener("click", () => openApp("vmhub"));
      }
    });

    /* ---------- Apps: Office Pro ---------- */
    registerApp({
      id: "officepro",
      nameKey: "officepro",
      descKey: "officepro_desc",
      icon: Icons.doc,
      category: "Productivity",
      launch: () => {
        const win = WM.createWindow({
          appId: "officepro",
          title: t("officepro"),
          icon: Icons.doc,
          width: 980,
          height: 640,
          contentHTML: `
            <div class="appPad">
              <div class="sectionTitle">${t("officepro")}</div>
              <div class="card">
                <div class="hint">${t("officepro_hint")}</div>
                <div class="row wrap" style="margin-top:10px;">
                  <button class="btn primary" data-open="writer">${Icons.doc} ${t("writer")}</button>
                  <button class="btn primary" data-open="sheets">${Icons.sheet} ${t("sheets")}</button>
                  <button class="btn primary" data-open="slides">${Icons.slides} ${t("slides")}</button>
                </div>
              </div>

              <div class="hr"></div>
              <div class="sectionTitle">${t("office_full")}</div>
              <div class="card">
                <div class="hint">${t("office_full_hint")}</div>
                <div class="row wrap" style="margin-top:10px;">
                  <button class="btn" id="opOpenLibre">${Icons.vm} ${t("open_libreoffice")}</button>
                  <button class="btn" id="opOpenArchDesk">${Icons.desk} ${t("archdesk")}</button>
                </div>
                <div class="hr"></div>
                <div class="muted" style="font-weight:700; margin-bottom:6px;">${t("arch_commands")}</div>
                <pre class="code" style="white-space:pre-wrap;">sudo pacman -S libreoffice-fresh libreoffice-fresh-pl hunspell-pl mythes-pl</pre>
                <div class="hint">${t("office_pl_hint")}</div>
              </div>
            </div>
          `
        });

        $$('button[data-open]', win.el).forEach(b => {
          b.addEventListener("click", () => openApp(b.getAttribute("data-open")));
        });

        $("#opOpenArchDesk", win.el).addEventListener("click", () => openApp("archdesk"));

        $("#opOpenLibre", win.el).addEventListener("click", () => {
          // Prefer the default template if present
          const office = (State.vmShortcuts||[]).find(v => v.id === "tmpl_office");
          if(office) {
            window.open(office.url, "_blank", "noopener,noreferrer");
          } else {
            openApp("archdesk");
          }
        });
      }
    });

    /* ---------- Apps: EXE + Flatpak helper ---------- */
    registerApp({
      id: "exeapps",
      nameKey: "exeapps",
      descKey: "exeapps_desc",
      icon: Icons.info,
      category: "System",
      launch: () => {
        const win = WM.createWindow({
          appId: "exeapps",
          title: t("exeapps"),
          icon: Icons.info,
          width: 980,
          height: 620,
          contentHTML: `
            <div class="appPad">
              <div class="sectionTitle">${t("exeapps")}</div>
              <div class="card">
                <div class="hint">${t("exeapps_hint")}</div>
                <div class="row wrap" style="margin-top:10px;">
                  <button class="btn primary" id="exOpenVM">${Icons.vm} ${t("vm_hub")}</button>
                  <button class="btn" id="exOpenArch">${Icons.desk} ${t("archdesk")}</button>
                </div>
              </div>

              <div class="hr"></div>
              <div class="sectionTitle">${t("exe_run_options")}</div>
              <div class="card">
                <div class="miniList">
                  <div class="miniItem">
                    <div class="left">
                      <span class="badge">${Icons.vm}</span>
                      <div style="min-width:0;">
                        <div class="title">${t("opt_windows_vm")}</div>
                        <div class="sub">${t("opt_windows_vm_desc")}</div>
                      </div>
                    </div>
                  </div>
                  <div class="miniItem">
                    <div class="left">
                      <span class="badge">${Icons.desk}</span>
                      <div style="min-width:0;">
                        <div class="title">${t("opt_wine")}</div>
                        <div class="sub">${t("opt_wine_desc")}</div>
                      </div>
                    </div>
                  </div>
                  <div class="miniItem">
                    <div class="left">
                      <span class="badge">${Icons.store}</span>
                      <div style="min-width:0;">
                        <div class="title">${t("opt_flatpak")}</div>
                        <div class="sub">${t("opt_flatpak_desc")}</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="hr"></div>
                <pre class="code" style="white-space:pre-wrap;">sudo pacman -S flatpak
flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo</pre>
              </div>
            </div>
          `
        });

        $("#exOpenVM", win.el).addEventListener("click", () => openApp("vmhub"));
        $("#exOpenArch", win.el).addEventListener("click", () => openApp("archdesk"));
      }
    });


        function render(){
          const list = $("#vmList", win.el);
          const vms = State.vmShortcuts || [];
          if(vms.length === 0){
            list.innerHTML = `<div class="hint">No VM shortcuts yet. Click <b>${t("vm_add")}</b>.</div>`;
            return;
          }
          list.innerHTML = vms.map(vm => `
            <div class="miniItem" data-id="${safeText(vm.id)}">
              <div class="left">
                <span class="badge">${Icons.vm}</span>
                <div style="min-width:0;">
                  <div class="title">${safeText(vm.name)}</div>
                  <div class="sub">${safeText(vm.url)}</div>
                </div>
              </div>
              <div class="row">
                <button class="btn" data-act="launch">${t("vm_launch")}</button>
                <button class="btn danger" data-act="remove">${t("vm_remove")}</button>
              </div>
            </div>
          `).join("");

          $$(".miniItem", list).forEach(el => {
            const id = el.dataset.id;
            el.querySelector('[data-act="launch"]').addEventListener("click", () => launch(id));
            el.querySelector('[data-act="remove"]').addEventListener("click", () => remove(id));
          });
        }

        function launch(id){
          const vm = (State.vmShortcuts||[]).find(v => v.id === id);
          if(!vm) return;
          if(vm.mode === "tab"){
            window.open(vm.url, "_blank", "noopener,noreferrer");
            return;
          }
          // iframe window
          WM.createWindow({
            appId: "vmhub",
            title: `${t("vm_hub")} — ${vm.name}`,
            icon: Icons.vm,
            width: 1020,
            height: 640,
            contentHTML: `
              <div style="height:100%; display:flex; flex-direction:column;">
                <div class="fmBar" style="border-bottom:1px solid var(--border);">
                  <span class="badge">${safeText(vm.name)}</span>
                  <span class="badge">${safeText(vm.url)}</span>
                  <span class="grow"></span>
                  <button class="btn" id="openTab">${Icons.open} ${t("vm_tab")}</button>
                </div>
                <div style="flex:1; overflow:hidden;">
                  <iframe src="${safeText(vm.url)}" style="border:0; width:100%; height:100%; background:#000;" referrerpolicy="no-referrer"></iframe>
                </div>
              </div>
            `,
            onInit: (w) => {
              $("#openTab", w.el).addEventListener("click", () => window.open(vm.url, "_blank", "noopener,noreferrer"));
            }
          });
        }

        async function remove(id){
          const vm = (State.vmShortcuts||[]).find(v => v.id === id);
          if(!vm) return;
          const ok = await confirmYesNo(t("vm_remove"), `Remove "${vm.name}"?`);
          if(!ok) return;
          State.vmShortcuts = (State.vmShortcuts||[]).filter(v => v.id !== id);
          saveState();
          render();
        }

        $("#vmAdd", win.el).addEventListener("click", async () => {
          const name = await promptText(t("vm_add"), t("vm_name"), "My VM", "My VM");
          if(!name) return;
          const url = await promptText(t("vm_add"), t("vm_url"), "https://your-vm.example/noVNC/", "https://");
          if(!url) return;
          showModal({
            title: t("vm_add"),
            bodyHTML: `
              <div class="field">
                <div class="muted">${t("vm_mode")}</div>
                <select id="vmMode" class="input">
                  <option value="iframe">${t("vm_iframe")}</option>
                  <option value="tab">${t("vm_tab")}</option>
                </select>
              </div>
            `,
            actions: [
              {label: t("cancel"), onClick: () => {}},
              {label: t("ok"), kind:"primary", onClick: () => {
                const mode = $("#vmMode").value;
                State.vmShortcuts = State.vmShortcuts || [];
                State.vmShortcuts.push({id: uid(), name, url, mode});
                saveState();
                render();
              }}
            ]
          });
        });

        render();
      }
    });

    
    /* ---------- Apps: Flatpak Store ---------- */
    registerApp({
      id: "flatpakstore",
      nameKey: "flatpak_store",
      descKey: "flatpak_store_desc",
      icon: Icons.package,
      category: "System",
      keywords: "flatpak flathub steam apps store",
      launch: async () => {
        const win = WM.createWindow({
          appId: "flatpakstore",
          title: t("flatpak_store"),
          icon: Icons.package,
          width: 1040,
          height: 680,
          contentHTML: `
            <div class="appPad">
              <div class="row wrap">
                <div class="searchBox" style="flex:1; min-width:240px;">
                  <span aria-hidden="true">${Icons.search}</span>
                  <input id="fpSearch" placeholder="${safeText(t("flatpak_search"))}" />
                </div>
                <button class="btn" id="fpCuratedBtn">${t("curated_list")}</button>
                <button class="btn primary" id="fpOnlineBtn">${t("online_search")}</button>
                <button class="btn" id="fpSyncBtn">${Icons.refresh} ${t("sync_installed")}</button>
                <button class="btn" id="fpSettingsBtn">${Icons.settings} ${t("settings")}</button>
              </div>

              <div class="card" style="margin-top:12px;">
                <div class="row wrap" style="justify-content:space-between; align-items:center;">
                  <div style="min-width:240px;">
                    <div class="cardTitle">${t("flatpak_store")}</div>
                    <div class="hint">${safeText(t("flatpak_store_desc"))}</div>
                  </div>
                  <div style="text-align:right; min-width:240px;">
                    <div class="hint">${t("agent")}: <span id="fpAgentBadge" class="badge">${t("off")}</span></div>
                    <div class="hint">${t("flathub")}</div>
                  </div>
                </div>
              </div>

              <div class="hr"></div>
              <div class="row wrap" style="justify-content:space-between; align-items:flex-end;">
                <div>
                  <div class="sectionTitle">${t("flatpak_apps")}</div>
                  <div class="hint">${safeText(t("no_agent_hint"))}</div>
                </div>
                <div class="row">
                  <button class="btn" id="fpOpenGaming">${Icons.gamepad} ${t("gaming_hub")}</button>
                </div>
              </div>

              <div id="fpStatus" class="hint" style="margin-top:8px;"></div>
              <div id="fpList" class="miniList" style="margin-top:10px;"></div>
            </div>
          `
        });

        const el = win.el;
        const search = $("#fpSearch", el);
        const list = $("#fpList", el);
        const status = $("#fpStatus", el);
        const badge = $("#fpAgentBadge", el);

        let mode = "curated";
        let items = FLATPAK_CURATED.slice();
        let installed = new Set(await flatpakListInstalled());

        function setBadge(ok){
          badge.className = "badge " + (ok ? "ok" : "bad");
          badge.textContent = ok ? t("on") : t("off");
        }
        agentPing().then(r => setBadge(!!r.ok));

        function isInstalled(id){ return installed.has(id); }

        function render(){
          const q = (search.value || "").trim().toLowerCase();
          const filtered = (items || []).filter(a => {
            if(!q) return true;
            return (a.name||"").toLowerCase().includes(q)
              || (a.id||"").toLowerCase().includes(q)
              || (a.summary||"").toLowerCase().includes(q)
              || (a.tags||"").toLowerCase().includes(q);
          });

          status.textContent = mode === "online"
            ? `${t("online_search")}: ${filtered.length}`
            : `${t("curated_list")}: ${filtered.length}`;

          list.innerHTML = filtered.length ? filtered.map(a => {
            const inst = isInstalled(a.id);
            const iconUrl = flatpakIconUrl(a.id);
            const badgeHtml = iconUrl
              ? `<span class="badge" style="width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;">
                   <img src="${safeText(iconUrl)}" style="width:34px;height:34px;object-fit:contain;" onerror="this.style.display='none';" />
                 </span>`
              : `<span class="badge">${Icons.package}</span>`;

            const btns = inst
              ? `<button class="btn primary" data-act="run">${t("run")}</button>
                 <button class="btn danger" data-act="uninstall">${t("uninstall")}</button>`
              : `<button class="btn primary" data-act="install">${t("install")}</button>`;

            return `
              <div class="miniItem" data-id="${safeText(a.id)}">
                <div class="left">
                  ${badgeHtml}
                  <div style="min-width:0;">
                    <div class="title">${safeText(a.name || a.id)} <span class="muted2">(${safeText(a.id)})</span></div>
                    <div class="sub">${safeText(a.summary || "")}</div>
                  </div>
                </div>
                <div class="row">
                  ${btns}
                  <button class="btn" data-act="copy">${Icons.copy} ${t("copy")}</button>
                </div>
              </div>
            `;
          }).join("") : `<div class="hint">${safeText("No results.")}</div>`;
        }

        async function syncInstalled(){
          installed = new Set(await flatpakListInstalled());
          toast(t("sync_installed"), `${installed.size}`, "ok");
        }

        // Search / buttons
        $("#fpCuratedBtn", el).addEventListener("click", async () => {
          mode = "curated";
          items = FLATPAK_CURATED.slice();
          await syncInstalled();
          render();
        });

        $("#fpOnlineBtn", el).addEventListener("click", async () => {
          mode = "online";
          const q = (search.value || "").trim();
          if(!q){ toast(t("search_apps"), t("flatpak_search"), ""); return; }
          status.textContent = `${t("online_search")}…`;
          items = await flatpakSearchOnline(q);
          await syncInstalled();
          render();
        });

        $("#fpSyncBtn", el).addEventListener("click", async () => {
          await syncInstalled();
          render();
        });

        $("#fpSettingsBtn", el).addEventListener("click", () => openApp("settings"));
        $("#fpOpenGaming", el).addEventListener("click", () => openApp("gaminghub"));

        search.addEventListener("input", () => render());

        // Actions
        list.addEventListener("click", async (e) => {
          const btn = e.target.closest("button[data-act]");
          if(!btn) return;
          const item = e.target.closest(".miniItem");
          const id = item?.getAttribute("data-id");
          if(!id) return;
          const act = btn.getAttribute("data-act");

          if(act === "copy"){
            await copyToClipboard(flatpakInstallCommand(id));
            return;
          }
          if(act === "install"){
            const cmd = flatpakInstallCommand(id);
            await runHostOrShow(cmd, `Flatpak: ${t("install")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = Array.isArray(State.flatpakInstalled) ? State.flatpakInstalled : [];
              if(!State.flatpakInstalled.includes(id)) State.flatpakInstalled.push(id);
              saveState();
            }
            await syncInstalled();
            render();
            return;
          }
          if(act === "uninstall"){
            const ok = await confirmYesNo(t("uninstall"), `${id}?`);
            if(!ok) return;
            const cmd = flatpakUninstallCommand(id);
            await runHostOrShow(cmd, `Flatpak: ${t("uninstall")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = (State.flatpakInstalled||[]).filter(x => x !== id);
              saveState();
            }
            await syncInstalled();
            render();
            return;
          }
          if(act === "run"){
            const cmd = flatpakRunCommand(id);
            await runHostOrShow(cmd, `Flatpak: ${t("run")} ${id}`);
            return;
          }
        });

        // Initial
        await syncInstalled();
        render();
      }
    });

    /* ---------- Apps: Distrobox ---------- */
    registerApp({
      id: "distrobox",
      nameKey: "distrobox",
      descKey: "distrobox_desc",
      icon: Icons.box,
      category: "System",
      keywords: "distrobox containers podman docker toolbox",
      launch: () => {
        const win = WM.createWindow({
          appId: "distrobox",
          title: t("distrobox"),
          icon: Icons.box,
          width: 980,
          height: 640,
          contentHTML: `
            <div class="appPad">
              <div class="card">
                <div class="cardTitle">${t("distrobox")}</div>
                <div class="hint">${safeText(t("distrobox_desc"))}</div>
              </div>

              <div class="hr"></div>

              <div class="row wrap">
                <div class="field" style="min-width:240px; flex:1;">
                  <div class="muted">${t("container_name")}</div>
                  <input class="input" id="dbName" placeholder="ubuntu-dev" />
                </div>
                <div class="field" style="min-width:240px; flex:1;">
                  <div class="muted">${t("image")}</div>
                  <input class="input" id="dbImage" placeholder="ubuntu:24.04" />
                </div>
              </div>

              <div class="row wrap" style="margin-top:12px;">
                <button class="btn" id="dbList">${t("list")}</button>
                <button class="btn primary" id="dbCreate">${t("create")}</button>
                <button class="btn" id="dbEnter">${t("enter")}</button>
                <button class="btn danger" id="dbRemove">${t("remove")}</button>
                <span class="hint" style="margin-left:auto;">${safeText(t("no_agent_hint"))}</span>
              </div>

              <div class="hr"></div>

              <div class="sectionTitle">${t("command_output")}</div>
              <pre id="dbOut" style="white-space:pre-wrap; word-break:break-word; background:rgba(0,0,0,.2); border:1px solid var(--border); border-radius:10px; padding:10px; max-height: 340px; overflow:auto;"></pre>

              <div class="hr"></div>
              <div class="sectionTitle">Templates</div>
              <div class="miniList" id="dbTpl"></div>
            </div>
          `
        });

        const el = win.el;
        const out = $("#dbOut", el);
        const name = $("#dbName", el);
        const image = $("#dbImage", el);
        const tpl = $("#dbTpl", el);

        function setOut(text){ out.textContent = text || ""; }
        function cmdTitle(cmd){ return `Distrobox: ${cmd}`; }

        function showCmdCopy(cmd, title){
          showModal({
            title,
            bodyHTML: `
              <div class="hint">${safeText(t("install_cmd"))}</div>
              <div style="display:flex; gap:8px; align-items:flex-start; margin-top:8px;">
                <textarea class="input" style="flex:1; min-height:92px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace;">${safeText(cmd)}</textarea>
                <button class="btn" id="copyDbCmd">${Icons.copy} ${t("copy")}</button>
              </div>
            `,
            actions: [
              {label: t("open_settings"), kind:"primary", onClick: () => openApp("settings")},
              {label: t("close"), onClick: () => {}}
            ]
          });
          setTimeout(()=>$("#copyDbCmd")?.addEventListener("click", ()=>copyToClipboard(cmd)), 50);
        }

        const templates = [
          {name:"Ubuntu 24.04", n:"ubuntu-dev", i:"ubuntu:24.04"},
          {name:"Fedora 40", n:"fedora-dev", i:"fedora:40"},
          {name:"Debian 12", n:"debian-dev", i:"debian:12"},
          {name:"Arch Linux", n:"arch-dev", i:"archlinux:latest"},
          {name:"Alpine", n:"alpine-dev", i:"alpine:latest"}
        ];
        tpl.innerHTML = templates.map(tpl => `
          <div class="miniItem" data-n="${safeText(tpl.n)}" data-i="${safeText(tpl.i)}">
            <div class="left">
              <span class="badge">${Icons.box}</span>
              <div style="min-width:0;">
                <div class="title">${safeText(tpl.name)}</div>
                <div class="sub">${safeText(tpl.i)}</div>
              </div>
            </div>
            <div class="row">
              <button class="btn" data-act="use">${t("use")}</button>
            </div>
          </div>
        `).join("");

        tpl.addEventListener("click", (e) => {
          const btn = e.target.closest("button[data-act='use']");
          if(!btn) return;
          const item = e.target.closest(".miniItem");
          if(!item) return;
          name.value = item.getAttribute("data-n") || "";
          image.value = item.getAttribute("data-i") || "";
          toast("Template", `${name.value}`, "ok");
        });

        $("#dbList", el).addEventListener("click", async () => {
          const cmd = "distrobox list";
          setOut("$ " + cmd + "\n");
          const r = await runHostOrShow(cmd, cmdTitle("list"));
          if(r?.ok){
            const txt = String(r.out?.stdout || r.out?.output || "") + (r.out?.stderr ? ("\n" + r.out.stderr) : "");
            setOut("$ " + cmd + "\n\n" + (txt || "(no output)"));
          }
        });

        $("#dbCreate", el).addEventListener("click", async () => {
          const n = (name.value || "").trim();
          const i = (image.value || "").trim();
          if(!n || !i){ toast("Distrobox", "Set name + image", "bad"); return; }
          const cmd = `distrobox create --name ${n} --image ${i} --yes`;
          setOut("$ " + cmd + "\n");
          const r = await runHostOrShow(cmd, cmdTitle("create"));
          if(r?.ok){
            const txt = String(r.out?.stdout || r.out?.output || "") + (r.out?.stderr ? ("\n" + r.out.stderr) : "");
            setOut("$ " + cmd + "\n\n" + (txt || "(no output)"));
          }
        });

        $("#dbRemove", el).addEventListener("click", async () => {
          const n = (name.value || "").trim();
          if(!n){ toast("Distrobox", "Set container name", "bad"); return; }
          const ok = await confirmYesNo(t("remove"), `${n}?`);
          if(!ok) return;
          const cmd = `distrobox rm ${n} --force`;
          setOut("$ " + cmd + "\n");
          const r = await runHostOrShow(cmd, cmdTitle("rm"));
          if(r?.ok){
            const txt = String(r.out?.stdout || r.out?.output || "") + (r.out?.stderr ? ("\n" + r.out.stderr) : "");
            setOut("$ " + cmd + "\n\n" + (txt || "(no output)"));
          }
        });

        $("#dbEnter", el).addEventListener("click", () => {
          const n = (name.value || "").trim();
          if(!n){ toast("Distrobox", "Set container name", "bad"); return; }
          const cmd = `distrobox enter ${n}`;
          showCmdCopy(cmd, cmdTitle("enter"));
        });

        setOut("Tip: Create a box, then enter it from your real terminal / Arch Desktop.\n");
      }
    });

    /* ---------- Apps: Gaming Hub ---------- */
    registerApp({
      id: "gaminghub",
      nameKey: "gaming_hub",
      descKey: "gaming_hub_desc",
      icon: Icons.gamepad,
      category: "Gaming",
      keywords: "games steam lutris heroic bottles proton",
      launch: async () => {
        const win = WM.createWindow({
          appId: "gaminghub",
          title: t("gaming_hub"),
          icon: Icons.gamepad,
          width: 1020,
          height: 680,
          contentHTML: `
            <div class="appPad">
              <div class="card">
                <div class="row wrap" style="justify-content:space-between; align-items:center;">
                  <div>
                    <div class="cardTitle">${t("gaming_hub")}</div>
                    <div class="hint">${safeText(t("gaming_hub_desc"))}</div>
                  </div>
                  <div class="row">
                    <button class="btn" id="ghOpenStore">${Icons.package} ${t("open_flatpak_store")}</button>
                    <button class="btn" id="ghSettings">${Icons.settings} ${t("settings")}</button>
                  </div>
                </div>
              </div>

              <div class="hr"></div>
              <div class="sectionTitle">${t("recommended_stack")}</div>
              <div class="hint">${safeText(t("no_agent_hint"))}</div>

              <div id="ghList" class="miniList" style="margin-top:10px;"></div>

              <div class="hr"></div>
              <div class="sectionTitle">${t("tips")}</div>
              <div class="hint">
                • Use <span class="kbd">ProtonUp-Qt</span> to install Proton-GE and extra compatibility tools.<br/>
                • If you prefer a Windows VM for anti-cheat titles, add a noVNC/RDP shortcut in <span class="kbd">VM Hub</span>.<br/>
                • For Wine-based apps, see <span class="kbd">EXE Apps</span> options (Wine/Proton vs VM).<br/>
              </div>
            </div>
          `
        });

        const el = win.el;
        const list = $("#ghList", el);

        const gamingApps = FLATPAK_CURATED.filter(a => (a.tags||"").includes("gaming") || a.id === "com.valvesoftware.Steam");

        let installed = new Set(await flatpakListInstalled());

        function render(){
          list.innerHTML = gamingApps.map(a => {
            const inst = installed.has(a.id);
            const iconUrl = flatpakIconUrl(a.id);
            const badgeHtml = iconUrl
              ? `<span class="badge" style="width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;">
                   <img src="${safeText(iconUrl)}" style="width:34px;height:34px;object-fit:contain;" onerror="this.style.display='none';" />
                 </span>`
              : `<span class="badge">${Icons.gamepad}</span>`;

            const primaryLabel = inst ? t("run") : t("install");
            const primaryAct = inst ? "run" : "install";

            return `
              <div class="miniItem" data-id="${safeText(a.id)}">
                <div class="left">
                  ${badgeHtml}
                  <div style="min-width:0;">
                    <div class="title">${safeText(a.name)} <span class="muted2">(${safeText(a.id)})</span></div>
                    <div class="sub">${safeText(a.summary || "")}</div>
                  </div>
                </div>
                <div class="row">
                  <button class="btn primary" data-act="${primaryAct}">${primaryLabel}</button>
                  ${inst ? `<button class="btn danger" data-act="uninstall">${t("uninstall")}</button>` : ``}
                  <button class="btn" data-act="copy">${Icons.copy} ${t("copy")}</button>
                </div>
              </div>
            `;
          }).join("");
        }

        async function syncInstalled(){
          installed = new Set(await flatpakListInstalled());
        }

        list.addEventListener("click", async (e) => {
          const btn = e.target.closest("button[data-act]");
          if(!btn) return;
          const item = e.target.closest(".miniItem");
          const id = item?.getAttribute("data-id");
          if(!id) return;
          const act = btn.getAttribute("data-act");

          if(act === "copy"){
            await copyToClipboard(flatpakInstallCommand(id));
            return;
          }
          if(act === "install"){
            await runHostOrShow(flatpakInstallCommand(id), `Flatpak: ${t("install")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = Array.isArray(State.flatpakInstalled) ? State.flatpakInstalled : [];
              if(!State.flatpakInstalled.includes(id)) State.flatpakInstalled.push(id);
              saveState();
            }
            await syncInstalled();
            render();
            return;
          }
          if(act === "uninstall"){
            const ok = await confirmYesNo(t("uninstall"), `${id}?`);
            if(!ok) return;
            await runHostOrShow(flatpakUninstallCommand(id), `Flatpak: ${t("uninstall")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = (State.flatpakInstalled||[]).filter(x => x !== id);
              saveState();
            }
            await syncInstalled();
            render();
            return;
          }
          if(act === "run"){
            await runHostOrShow(flatpakRunCommand(id), `Flatpak: ${t("run")} ${id}`);
            return;
          }
        });

        $("#ghOpenStore", el).addEventListener("click", () => openApp("flatpakstore"));
        $("#ghSettings", el).addEventListener("click", () => openApp("settings"));

        await syncInstalled();
        render();
      }
    });

/* ---------- Apps: Discover ---------- */
    registerApp({
      id: "discover",
      nameKey: "discover",
      descKey: "discover_desc",
      icon: Icons.store,
      category: "System",
      launch: () => {
        const win = WM.createWindow({
          appId: "discover",
          title: t("discover"),
          icon: Icons.store,
          width: 980,
          height: 620,
          contentHTML: `<div class="appPad">
            <div class="row wrap">
              <div class="searchBox" style="flex:1;">
                <span aria-hidden="true">${Icons.search}</span>
                <input id="dSearch" placeholder="${safeText(t("search_apps"))}" />
              </div>
              <button class="btn" id="dOpenSettings">${Icons.settings} ${t("settings")}</button>
            </div>

            <div class="card" style="margin-top:12px;">
              <div class="cardTitle">${t("discover")}</div>
              <div class="hint">${safeText(t("discover_desc"))}</div>
            </div>

            <div class="hr"></div>

            <div class="row wrap" style="justify-content:space-between;">
              <div class="sectionTitle">${t("installed_apps")}</div>
              <span class="hint">Tip: Use Terminal <span class="kbd">install &lt;appId&gt;</span></span>
            </div>
            <div id="dList" class="miniList"></div>

            <div class="hr"></div>

            <div class="row wrap" style="justify-content:space-between; align-items:flex-end;">
              <div>
                <div class="sectionTitle">${t("flatpak_apps")}</div>
                <div class="hint">${safeText(t("opt_flatpak_desc"))}</div>
              </div>
              <div class="row">
                <button class="btn" id="dOpenFlatpak">${Icons.package} ${t("open_flatpak_store")}</button>
              </div>
            </div>

            <div class="card" style="margin-top:10px;">
              <div class="row wrap">
                <div class="searchBox" style="flex:1; min-width:240px;">
                  <span aria-hidden="true">${Icons.search}</span>
                  <input id="dFpSearch" placeholder="${safeText(t("flatpak_search"))}" />
                </div>
                <button class="btn" id="dFpCurated">${t("curated_list")}</button>
                <button class="btn primary" id="dFpOnline">${t("online_search")}</button>
              </div>
              <div class="hint" style="margin-top:8px;">${safeText(t("no_agent_hint"))}</div>
              <div id="dFpList" class="miniList" style="margin-top:10px;"></div>
            </div>

            <div class="hr"></div>
            <div class="sectionTitle">${t("about_limits")}</div>
            <div class="hint">${safeText(t("limits_msg"))}</div>
          </div>`
        });

        const search = $("#dSearch", win.el);
        const list = $("#dList", win.el);

        const fpSearch = $("#dFpSearch", win.el);
        const fpList = $("#dFpList", win.el);
        const fpOpen = $("#dOpenFlatpak", win.el);
        const fpCurated = $("#dFpCurated", win.el);
        const fpOnline = $("#dFpOnline", win.el);

        let fpMode = "curated";
        let fpItems = FLATPAK_CURATED.slice();
        let fpInstalled = new Set();

        function render(){
          const q = (search.value || "").trim().toLowerCase();
          const apps = Object.values(AppRegistry)
            .filter(a => a.id !== "discover" ? true : true)
            .filter(a => !q || a.name().toLowerCase().includes(q) || a.id.includes(q) || (a.keywords||"").includes(q))
            .sort((a,b) => a.name().localeCompare(b.name()));

          list.innerHTML = apps.map(app => {
            const installed = State.installedApps.includes(app.id);
            const canRemove = installed && !["discover","settings","help"].includes(app.id);
            const actionBtn = installed
              ? `<button class="btn ${canRemove?'danger':''}" data-act="${canRemove?'uninstall':'open'}">
                    ${canRemove ? t("uninstall") : t("open")}
                 </button>`
              : `<button class="btn primary" data-act="install">${t("install")}</button>`;
            return `
              <div class="miniItem" data-id="${safeText(app.id)}">
                <div class="left">
                  <span class="badge">${app.icon}</span>
                  <div style="min-width:0;">
                    <div class="title">${safeText(app.name())} <span class="muted2">(${safeText(app.id)})</span></div>
                    <div class="sub">${safeText(app.desc())}</div>
                  </div>
                </div>
                <div class="row">${actionBtn}</div>
              </div>
            `;
          }).join("");

          $$(".miniItem", list).forEach(el => {
            const id = el.dataset.id;
            const btn = el.querySelector("button[data-act]");
            const act = btn.getAttribute("data-act");
            btn.addEventListener("click", () => {
              if(act === "install") installApp(id);
              else if(act === "uninstall") uninstallApp(id);
              else if(act === "open") openApp(id);
              render();
            });
          });
        }

        // --- Flatpak mini-store (Steam, Flathub apps) ---
        async function fpSync(){
          fpInstalled = new Set(await flatpakListInstalled());
        }
        function fpIsInstalled(id){ return fpInstalled.has(id); }

        function fpRender(){
          const q = (fpSearch.value || "").trim().toLowerCase();
          const filtered = (fpItems || []).filter(a => {
            if(!q) return true;
            return (a.name||"").toLowerCase().includes(q)
              || (a.id||"").toLowerCase().includes(q)
              || (a.summary||"").toLowerCase().includes(q)
              || (a.tags||"").toLowerCase().includes(q);
          }).slice(0, 12);

          fpList.innerHTML = filtered.length ? filtered.map(a => {
            const inst = fpIsInstalled(a.id);
            const iconUrl = flatpakIconUrl(a.id);
            const badgeHtml = iconUrl
              ? `<span class="badge" style="width:34px;height:34px;display:inline-flex;align-items:center;justify-content:center;overflow:hidden;">
                   <img src="${safeText(iconUrl)}" style="width:34px;height:34px;object-fit:contain;" onerror="this.style.display='none';" />
                 </span>`
              : `<span class="badge">${Icons.package}</span>`;

            const primary = inst
              ? `<button class="btn primary" data-act="run">${t("run")}</button>`
              : `<button class="btn primary" data-act="install">${t("install")}</button>`;

            const extra = inst
              ? `<button class="btn danger" data-act="uninstall">${t("uninstall")}</button>`
              : ``;

            return `
              <div class="miniItem" data-id="${safeText(a.id)}">
                <div class="left">
                  ${badgeHtml}
                  <div style="min-width:0;">
                    <div class="title">${safeText(a.name || a.id)} <span class="muted2">(${safeText(a.id)})</span></div>
                    <div class="sub">${safeText(a.summary || "")}</div>
                  </div>
                </div>
                <div class="row">
                  ${primary}
                  ${extra}
                  <button class="btn" data-act="copy">${Icons.copy} ${t("copy")}</button>
                </div>
              </div>
            `;
          }).join("") : `<div class="hint">${safeText("No results.")}</div>`;
        }

        async function fpSearchOnline(){
          fpMode = "online";
          const q = (fpSearch.value || "").trim();
          if(!q){ toast(t("search_apps"), t("flatpak_search"), ""); return; }
          fpList.innerHTML = `<div class="hint">${safeText(t("online_search"))}…</div>`;
          fpItems = await flatpakSearchOnline(q);
          await fpSync();
          fpRender();
        }

        fpCurated.addEventListener("click", async () => {
          fpMode = "curated";
          fpItems = FLATPAK_CURATED.slice();
          await fpSync();
          fpRender();
        });
        fpOnline.addEventListener("click", fpSearchOnline);
        fpSearch.addEventListener("input", () => fpRender());
        fpOpen.addEventListener("click", () => openApp("flatpakstore"));

        fpList.addEventListener("click", async (e) => {
          const btn = e.target.closest("button[data-act]");
          if(!btn) return;
          const item = e.target.closest(".miniItem");
          const id = item?.getAttribute("data-id");
          if(!id) return;
          const act = btn.getAttribute("data-act");

          if(act === "copy"){
            await copyToClipboard(flatpakInstallCommand(id));
            return;
          }
          if(act === "install"){
            await runHostOrShow(flatpakInstallCommand(id), `Flatpak: ${t("install")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = Array.isArray(State.flatpakInstalled) ? State.flatpakInstalled : [];
              if(!State.flatpakInstalled.includes(id)) State.flatpakInstalled.push(id);
              saveState();
            }
            await fpSync();
            fpRender();
            return;
          }
          if(act === "uninstall"){
            const ok = await confirmYesNo(t("uninstall"), `${id}?`);
            if(!ok) return;
            await runHostOrShow(flatpakUninstallCommand(id), `Flatpak: ${t("uninstall")} ${id}`);
            if(!agentBase()){
              State.flatpakInstalled = (State.flatpakInstalled||[]).filter(x => x !== id);
              saveState();
            }
            await fpSync();
            fpRender();
            return;
          }
          if(act === "run"){
            await runHostOrShow(flatpakRunCommand(id), `Flatpak: ${t("run")} ${id}`);
            return;
          }
        });

        search.addEventListener("input", render);
        $("#dOpenSettings", win.el).addEventListener("click", () => openApp("settings"));
        render();
        fpSync().then(fpRender);

      }
    });

    /* ---------- Apps: Settings ---------- */
    registerApp({
      id: "settings",
      nameKey: "settings",
      icon: Icons.settings,
      category: "System",
      launch: () => {
        const win = WM.createWindow({
          appId: "settings",
          title: t("settings"),
          icon: Icons.settings,
          width: 920,
          height: 600,
          contentHTML: `<div class="appPad">
            <div class="sectionTitle">${t("settings")}</div>
            <div class="card">
              <div class="row wrap">
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("theme")}</div>
                  <select class="input" id="setTheme">
                    <option value="dark">${t("dark")}</option>
                    <option value="light">${t("light")}</option>
                  </select>
                </div>
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("accent")}</div>
                  <input class="input" id="setAccent" type="color" />
                </div>
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("language")}</div>
                  <select class="input" id="setLang">
                    <option value="en">English</option>
                    <option value="pl">Polski</option>
                  </select>
                </div>
              </div>

              <div class="hr"></div>

              <div class="field">
                <div class="muted">${t("wallpaper")}</div>
                <div class="row wrap">
                  <button class="btn" data-wp="zorin">Zorin</button>
                  <button class="btn" data-wp="arch">Arch</button>
                  <button class="btn" data-wp="sunrise">Sunrise</button>
                  <button class="btn" data-wp="lightblue">Light Blue</button>
                </div>
                <div class="hint">Wallpapers are pure CSS (fully embedded).</div>
              </div>
            </div>

            <div class="hr"></div>

            
            <div class="hr"></div>

            <div class="sectionTitle">${t("virtual_desktops")}</div>
            <div class="card">
              <div class="row wrap">
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("desktop_count")}</div>
                  <select class="input" id="setDeskCount">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                  </select>
                </div>
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("snap_windows")}</div>
                  <select class="input" id="setSnap">
                    <option value="on">${t("on")}</option>
                    <option value="off">${t("off")}</option>
                  </select>
                </div>
              </div>
              <div class="hint" style="margin-top:8px;">${safeText(t("desk_shortcuts_hint"))}</div>
            </div>

            <div class="hr"></div>

            <div class="sectionTitle">${t("remote_desktop")}</div>
            <div class="card">
              <div class="field">
                <div class="muted">${t("archdesk_url")}</div>
                <input class="input" id="setArchUrl" placeholder="http://localhost:3000/" />
                <div class="hint">${t("archdesk_hint")}</div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="sectionTitle">${t("agent")}</div>
            <div class="card">
              <div class="row wrap">
                <div class="field" style="min-width:260px; flex:1;">
                  <div class="muted">${t("agent_url")}</div>
                  <input class="input" id="setAgentUrl" placeholder="http://localhost:7777" />
                </div>
                <div class="field" style="min-width:220px; flex:1;">
                  <div class="muted">${t("agent_token")}</div>
                  <input class="input" id="setAgentToken" placeholder="(optional)" />
                </div>
              </div>
              <div class="row wrap" style="margin-top:10px;">
                <button class="btn" id="testAgent">${Icons.plug} ${t("test_connection")}</button>
                <button class="btn" id="openFlatpak">${Icons.package} ${t("open_flatpak_store")}</button>
              </div>
              <div class="hint" style="margin-top:8px;">${safeText(t("no_agent_hint"))}</div>
            </div>


<div class="sectionTitle">${t("backup_restore")}</div>
            <div class="card">
              <div class="row wrap">
                <button class="btn primary" id="exportBackup">${Icons.download} ${t("export_backup")}</button>
                <button class="btn" id="importBackup">${Icons.upload} ${t("import_backup")}</button>
                <button class="btn danger" id="factoryReset">${t("reset")}</button>
              </div>
              <div class="hint" style="margin-top:8px;">
                Export creates a JSON file containing settings, installed apps, VM shortcuts, and your IndexedDB files.
                Import restores it on this device/browser.
              </div>
            </div>

            <div class="hr"></div>
            <div class="sectionTitle">${t("about_limits")}</div>
            <div class="hint">${safeText(t("limits_msg"))}</div>
          </div>`
        });

        const setTheme = $("#setTheme", win.el);
        const setAccent = $("#setAccent", win.el);
        const setLang = $("#setLang", win.el);

        setTheme.value = State.settings.theme;
        setAccent.value = State.settings.accent || "#4a8cff";
        setLang.value = State.settings.language || "en";

        setTheme.addEventListener("change", () => {
          State.settings.theme = setTheme.value;
          applyTheme(); saveState();
          renderDesktop(); renderStartMenu(); WM.updateTaskButtons();
        });
        setAccent.addEventListener("input", () => {
          State.settings.accent = setAccent.value;
          applyTheme(); saveState();
        });
        setLang.addEventListener("change", () => {
          State.settings.language = setLang.value;
          applyTheme(); saveState();
          renderDesktop(); renderStartMenu(); WM.updateTaskButtons();
        });

        const setDeskCount = $("#setDeskCount", win.el);
        const setSnap = $("#setSnap", win.el);
        const setArchUrl = $("#setArchUrl", win.el);
        const setAgentUrl = $("#setAgentUrl", win.el);
        const setAgentToken = $("#setAgentToken", win.el);

        // Defaults for new features
        setDeskCount.value = String(State.settings.desktopCount ?? 4);
        setSnap.value = (State.settings.snapEnabled ?? true) ? "on" : "off";
        setArchUrl.value = State.settings.archDesktopUrl || "http://localhost:3000/";
        setAgentUrl.value = State.settings.agentUrl || "";
        setAgentToken.value = State.settings.agentToken || "";

        setDeskCount.addEventListener("change", () => {
          State.settings.desktopCount = clamp(parseInt(setDeskCount.value)||4, 1, 6);
          if((State.settings.currentDesktop ?? 0) >= State.settings.desktopCount){
            State.settings.currentDesktop = State.settings.desktopCount - 1;
          }
          saveState();
          WM.applyDesktopVisibility();
          $("#deskText").textContent = `${t("desk")} ${(State.settings.currentDesktop ?? 0)+1}`;
        });

        setSnap.addEventListener("change", () => {
          State.settings.snapEnabled = (setSnap.value === "on");
          saveState();
        });

        setArchUrl.addEventListener("change", () => {
          State.settings.archDesktopUrl = setArchUrl.value.trim();
          saveState();
        });

        setAgentUrl.addEventListener("change", () => {
          State.settings.agentUrl = setAgentUrl.value.trim();
          saveState();
        });
        setAgentToken.addEventListener("change", () => {
          State.settings.agentToken = setAgentToken.value.trim();
          saveState();
        });

        $("#testAgent", win.el).addEventListener("click", async () => {
          const r = await agentPing();
          if(r.ok) toast(t("agent_ok"), "", "ok");
          else toast(t("agent_fail"), String(r.error || ""), "bad");
        });

        $("#openFlatpak", win.el).addEventListener("click", () => openApp("flatpakstore"));


        $$("button[data-wp]", win.el).forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-wp");
            State.settings.wallpaper = id;
            applyTheme();
            saveState();
          });
        });

        $("#factoryReset", win.el).addEventListener("click", async () => {
          const ok = await confirmYesNo(t("reset"), "This will wipe settings + files for this desktop on this device. Continue?");
          if(!ok) return;
          localStorage.removeItem(STORAGE_KEY);
          // wipe indexeddb
          try{
            indexedDB.deleteDatabase(DB_NAME);
          }catch{}
          location.reload();
        });

        $("#exportBackup", win.el).addEventListener("click", async () => {
          toast("Backup", "Preparing export…", "warn");
          const nodes = await FS.all();
          const exportNodes = [];
          for(const n of nodes){
            if(n.type === "file"){
              const b64 = await blobToBase64(n.data);
              exportNodes.push({
                ...n,
                data: b64
              });
            } else {
              exportNodes.push(n);
            }
          }
          const payload = {
            exportedAt: new Date().toISOString(),
            state: State,
            nodes: exportNodes
          };
          const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "webos-backup.json";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 1000);
          toast(t("toast_saved"), "Backup exported.", "ok");
        });

        $("#importBackup", win.el).addEventListener("click", async () => {
          const input = document.createElement("input");
          input.type = "file";
          input.accept = "application/json,.json";
          input.onchange = async () => {
            const f = input.files?.[0];
            if(!f) return;
            const text = await f.text();
            let payload;
            try{ payload = JSON.parse(text); } catch { toast(t("toast_error"), "Invalid JSON.", "bad"); return; }
            const ok = await confirmYesNo("Import backup", "This will overwrite your current WebOS state and files on this device. Continue?");
            if(!ok) return;

            // restore state
            if(payload.state){
              localStorage.setItem(STORAGE_KEY, JSON.stringify(payload.state));
            }

            // restore files
            try{
              // wipe and recreate DB
              indexedDB.deleteDatabase(DB_NAME);
              DB = null;
              await openDB();
              for(const n of (payload.nodes || [])){
                if(n.type === "file"){
                  const blob = base64ToBlob(n.data, n.mime || "application/octet-stream");
                  await FS.writeFile(n.path, blob, n.mime || "application/octet-stream");
                } else if(n.type === "dir"){
                  await FS.ensureDir(n.path);
                }
              }
            }catch(e){
              toast(t("toast_error"), "Failed restoring files: " + (e.message||e), "bad");
              return;
            }
            toast(t("toast_ready"), "Imported. Reloading…", "ok");
            setTimeout(() => location.reload(), 400);
          };
          input.click();
        });

        async function blobToBase64(blob){
          return new Promise((resolve) => {
            const r = new FileReader();
            r.onload = () => resolve(String(r.result).split(",")[1] || "");
            r.readAsDataURL(blob);
          });
        }
        function base64ToBlob(b64, mime){
          const bin = atob(b64 || "");
          const bytes = new Uint8Array(bin.length);
          for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
          return new Blob([bytes], {type:mime});
        }
      }
    });

    /* ---------- Apps: Help ---------- */
    registerApp({
      id: "help",
      nameKey: "help",
      descKey: "help_desc",
      icon: Icons.help,
      category: "System",
      launch: () => {
        WM.createWindow({
          appId: "help",
          title: t("help"),
          icon: Icons.help,
          width: 920,
          height: 620,
          contentHTML: `<div class="appPad">
            <div class="card">
              <div class="cardTitle">What this is</div>
              <div class="hint">
                This file is a <b>single‑page web desktop</b> that imitates a Windows/Zorin‑style environment.
                It’s fully embedded (no external libraries) and stores your files locally using <b>IndexedDB</b>.
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="cardTitle">Office suite (offline)</div>
              <div class="hint">
                • <b>Writer</b>: rich text editor (save as HTML/TXT).<br>
                • <b>Sheets</b>: mini spreadsheet (CSV import/export, basic formulas).<br>
                • <b>Slides</b>: simple slide decks (save as .zslides + presentation mode).<br>
                All files live in <span class="kbd">/home/user/Documents</span>.
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="cardTitle">Virtual machines</div>
              <div class="hint">
                A real VM needs CPU emulation (very heavy) or a remote VM session.
                <b>VM Hub</b> supports <b>remote VM URLs</b> (noVNC / Apache Guacamole / web VDI).<br><br>
                If you want “Arch Linux inside this UI”, the realistic path is:
                <ol style="margin:8px 0 0 18px;">
                  <li>Run Arch in a VM (KVM/VirtualBox/Proxmox) on a PC/server.</li>
                  <li>Expose it via noVNC/Guacamole.</li>
                  <li>Add the URL in VM Hub.</li>
                </ol>
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="cardTitle">.EXE + Flatpak</div>
              <div class="hint">
                Browsers cannot directly execute native <b>.EXE</b> or <b>Flatpak</b> apps for security reasons.
                To run Windows apps:
                <ul style="margin:8px 0 0 18px;">
                  <li><b>Linux</b>: Wine / Bottles / Proton (Steam).</li>
                  <li><b>Windows</b>: run them normally.</li>
                  <li><b>macOS</b>: use a VM or CrossOver (paid).</li>
                  <li>Or run Windows in a VM and open it through VM Hub.</li>
                </ul>
                For Flatpak, you need a Linux host environment.
              </div>
            </div>

            <div class="hr"></div>

            <div class="card">
              <div class="cardTitle">RustPy‑Arch integration (recommended)</div>
              <div class="hint">
                This single file is the <b>UI layer</b>. To run real Arch / LibreOffice / Flatpak / .exe you still need a backend:
                <ul>
                  <li>Run a Linux desktop container/VM with noVNC (or Guacamole/RDP).</li>
                  <li>Set <b>Settings → Remote Desktop → Arch Desktop URL</b> to your endpoint (example: <span class="kbd">http://localhost:3000/</span>).</li>
                  <li>Use <b>Arch Desktop</b> and <b>VM Hub</b> to jump into your real environments.</li>
                </ul>
              </div>
            </div>

            <div class="hr"></div>

            <div class="hint">
              Tip: Open <b>Settings → Backup</b> to export everything.
            </div>
          </div>`
        });
      }
    });

    /* ---------- Desktop + Start Menu rendering ---------- */
    function renderDesktop(){
      const icons = $("#desktopIcons");
      icons.innerHTML = "";
      for(const appId of State.desktopShortcuts){
        if(!State.installedApps.includes(appId)) continue;
        const app = AppRegistry[appId];
        if(!app) continue;
        const el = document.createElement("div");
        el.className = "deskIcon";
        el.innerHTML = `<div class="ico">${app.icon}</div><div class="label">${safeText(app.name())}</div>`;
        // click / double click
        let lastTap = 0;
        el.addEventListener("click", () => {
          const now = Date.now();
          if(now - lastTap < 340){
            openApp(appId);
          }
          lastTap = now;
        });
        el.addEventListener("dblclick", () => openApp(appId));
        icons.appendChild(el);
      }
    }

    function renderStartMenu(){
      const body = $("#startBody");
      const installed = State.installedApps.map(id => AppRegistry[id]).filter(Boolean);
      const recent = (State.recentFiles || []).slice(0,6);

      const appsHTML = `
        <div>
          <div class="sectionTitle">${t("installed_apps")}</div>
          <div class="appGrid">
            ${installed.slice(0,9).map(app => `
              <div class="appTile" data-app="${safeText(app.id)}">
                <div class="ico">${app.icon}</div>
                <div class="name">${safeText(app.name())}</div>
              </div>
            `).join("")}
          </div>
          <div class="hint" style="margin-top:10px;">Open Discover to see all apps.</div>
        </div>
      `;

      const recentHTML = `
        <div>
          <div class="sectionTitle">${t("recent")}</div>
          <div class="miniList">
            ${recent.length ? recent.map(p => `
              <div class="miniItem" data-file="${safeText(p)}">
                <div class="left">
                  <span class="badge">${Icons.doc}</span>
                  <div style="min-width:0;">
                    <div class="title">${safeText(FS.name(p))}</div>
                    <div class="sub">${safeText(p)}</div>
                  </div>
                </div>
                <span class="muted2">${Icons.chevron}</span>
              </div>
            `).join("") : `<div class="hint">No recent files yet.</div>`}
          </div>
        </div>
      `;

      const tipsHTML = `
        <div>
          <div class="sectionTitle">${t("tips")}</div>
          <div class="card">
            <div class="hint">
              • On mobile, windows open maximized automatically.<br>
              • Use <b>Files → Upload</b> to add files.<br>
              • Use <b>Settings → Backup</b> to export everything.<br>
              • VM Hub can open remote VM URLs.
            </div>
          </div>
        </div>
      `;

      body.innerHTML = appsHTML + recentHTML + tipsHTML;

      $$(".appTile", body).forEach(tile => {
        tile.addEventListener("click", () => {
          const id = tile.getAttribute("data-app");
          toggleStartMenu(false);
          openApp(id);
        });
      });
      $$(".miniItem[data-file]", body).forEach(item => {
        item.addEventListener("click", () => {
          const p = item.getAttribute("data-file");
          toggleStartMenu(false);
          openFile(p);
        });
      });
    }

    function toggleStartMenu(force=null){
      const menu = $("#startMenu");
      const visible = !menu.classList.contains("hidden");
      const next = force === null ? !visible : force;
      menu.classList.toggle("hidden", !next);
      if(next){
        $("#startSearch").value = "";
        renderStartMenu();
        setTimeout(() => $("#startSearch")?.focus(), 40);
      }
    }

    function openApp(id, args={}){
      if(!State.installedApps.includes(id)){
        toast(t("toast_error"), "App not installed. Install from Discover.", "bad");
        return;
      }
      const app = AppRegistry[id];
      if(!app){
        toast(t("toast_error"), "App not found.", "bad");
        return;
      }
      app.launch(args);
    }

    /* ---------- Search in Start menu ---------- */
    function bindStartSearch(){
      const input = $("#startSearch");
      input.placeholder = t("search_apps");
      input.addEventListener("input", () => {
        const q = input.value.trim().toLowerCase();
        const installed = State.installedApps.map(id => AppRegistry[id]).filter(Boolean);
        const match = installed.filter(a => !q || a.name().toLowerCase().includes(q) || a.id.includes(q));
        const body = $("#startBody");
        body.innerHTML = `
          <div>
            <div class="sectionTitle">${t("installed_apps")}</div>
            <div class="appGrid">
              ${match.map(app => `
                <div class="appTile" data-app="${safeText(app.id)}">
                  <div class="ico">${app.icon}</div>
                  <div class="name">${safeText(app.name())}</div>
                </div>
              `).join("")}
            </div>
            ${q ? `<div class="hint" style="margin-top:10px;">${match.length} result(s)</div>` : ""}
          </div>
        `;
        $$(".appTile", body).forEach(tile => {
          tile.addEventListener("click", () => {
            const id = tile.getAttribute("data-app");
            toggleStartMenu(false);
            openApp(id);
          });
        });
      });
    }

    /* ---------- Clock ---------- */
    function startClock(){
      const el = $("#clockText");
      const tick = () => {
        const d = new Date();
        el.textContent = d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
      };
      tick();
      setInterval(tick, 10000);
    }

    /* ---------- Taskbar binds ---------- */
    function bindTaskbar(){
      $("#startBtnIco").innerHTML = Icons.start;
      $("#showDeskIco").innerHTML = Icons.desk;
      $("#deskIco").innerHTML = Icons.desk;
      $("#searchIco").innerHTML = Icons.search;
      $("#spotIco").innerHTML = Icons.search;
      $("#userIco").innerHTML = Icons.user;
      $("#langIco").innerHTML = Icons.lang;
      $("#settingsIco2").innerHTML = Icons.settings;

      $("#startBtnText").textContent = t("start");
      $("#settingsQuickText").textContent = t("settings");
      $("#netPill").textContent = t("web_desktop");

      // Desktop label
      $("#deskText").textContent = `${t("desk")} ${(State.settings.currentDesktop ?? 0)+1}`;
      $("#desktopBtn").title = t("desktops");
      $("#showDesktopBtn").title = t("show_desktop");

      $("#startBtn").addEventListener("click", () => toggleStartMenu());

      $("#showDesktopBtn").addEventListener("click", () => {
        if(WM.anyVisible()) WM.minimizeAll();
        else WM.restoreAll();
      });

      // Desktop switcher:
      // - Click: next desktop
      // - Shift+Click (or right click): picker
      const deskBtn = $("#desktopBtn");
      deskBtn.addEventListener("click", (e) => {
        if(e.shiftKey) showDesktopPicker();
        else WM.nextDesktop();
      });
      deskBtn.addEventListener("contextmenu", (e) => {
        e.preventDefault();
        showDesktopPicker();
      });
      // Touch long-press => picker
      let pressTimer = null;
      deskBtn.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => showDesktopPicker(), 550);
      }, {passive:true});
      deskBtn.addEventListener("touchend", () => {
        if(pressTimer){ clearTimeout(pressTimer); pressTimer = null; }
      }, {passive:true});

      // Close start menu when clicking away
      document.addEventListener("mousedown", (e) => {
        const menu = $("#startMenu");
        if(menu.classList.contains("hidden")) return;
        const within = e.target.closest("#startMenu") || e.target.closest("#startBtn");
        if(!within) toggleStartMenu(false);
      }, {passive:true});
      document.addEventListener("touchstart", (e) => {
        const menu = $("#startMenu");
        if(menu.classList.contains("hidden")) return;
        const within = e.target.closest("#startMenu") || e.target.closest("#startBtn");
        if(!within) toggleStartMenu(false);
      }, {passive:true});

      $("#powerBtn").addEventListener("click", async () => {
        const ok = await confirmYesNo(t("reset"), t("reload_now"));
        if(ok) location.reload();
      });

      $("#settingsQuickBtn").addEventListener("click", () => {
        toggleStartMenu(false);
        openApp("settings");
      });
    }

    function showDesktopPicker(){
      // Ensure defaults
      State.settings.desktopCount = State.settings.desktopCount ?? 4;
      State.settings.currentDesktop = State.settings.currentDesktop ?? 0;

      const count = clamp(parseInt(State.settings.desktopCount)||4, 1, 6);
      const cur = clamp(parseInt(State.settings.currentDesktop)||0, 0, count-1);

      const buttons = Array.from({length: count}, (_,i) => `
        <button class="btn ${i===cur?'primary':''}" data-desk="${i}">
          ${t("desk")} ${i+1}
        </button>
      `).join("");

      showModal({
        title: t("desktops"),
        bodyHTML: `
          <div class="row wrap" id="deskPick">${buttons}</div>
          <div class="hint" style="margin-top:10px;">
            ${safeText(t("desk_shortcuts_hint"))}
          </div>
        `,
        actions: [{label: t("close"), onClick: () => {}}]
      });

      $$("#deskPick button").forEach(b => {
        b.addEventListener("click", () => {
          const d = parseInt(b.getAttribute("data-desk"));
          WM.setDesktop(d);
          $("#deskText").textContent = `${t("desk")} ${(State.settings.currentDesktop ?? 0)+1}`;
          hideModal();
        });
      });
    }


    function refreshShellLabels(){
      $("#startBtnText").textContent = t("start");
      $("#settingsQuickText").textContent = t("settings");
      $("#netPill").textContent = t("web_desktop");
      $("#deskText").textContent = `${t("desk")} ${(State.settings.currentDesktop ?? 0)+1}`;
      $("#desktopBtn").title = t("desktops");
      $("#showDesktopBtn").title = t("show_desktop");
      $("#spotInput").placeholder = t("search_apps");
    }

/* ---------- Boot sequence ---------- */
    async function boot(){
      applyTheme();
      $("#bootTitle").textContent = "NovaOS UltraPlus";
      $("#bootSub").textContent = "Single‑file desktop (Zorin/Windows‑like): Office + Discover + VM + Arch Desktop • PL-ready.";
      $("#bootHint").textContent = "Loading local storage + file system…";

      const bar = $("#bootBar");
      const setProg = (p) => {
        bar.style.width = p + "%";
        $("#boot .progress").setAttribute("aria-valuenow", String(p));
      };

      setProg(12);
      await sleep(120);

      await openDB();
      setProg(35);
      await sleep(120);

      await seedFSIfEmpty();
      setProg(60);
      await sleep(140);

      // Apply translations after state is ready
      $("#startBtnText").textContent = t("start");
      $("#startSearch").placeholder = t("search_apps");
      $("#settingsQuickText").textContent = t("settings");
      $("#showDesktopBtn").title = t("show_desktop");
      $("#netPill").textContent = t("web_desktop");

      renderDesktop();
      renderStartMenu();
      WM.updateTaskButtons();

      setProg(92);
      await sleep(220);

      $("#boot").style.display = "none";
      $("#os").hidden = false;

      startClock();
      toast(t("toast_ready"), "Open Start to launch apps.", "ok");
    }

    /* ---------- App installation sanity ---------- */
    function ensureCoreAppsInstalled(){
      for(const core of ["discover","settings","help","fileman","terminal"]){
        if(!State.installedApps.includes(core)) State.installedApps.push(core);
      }
      saveState();
    }

    /* ---------- Kickstart ---------- */
    ensureCoreAppsInstalled();
    bindTaskbar();
    bindStartSearch();
    boot();

    // ---------- Shell extras: Spotlight, Task Switcher, Context Menu ----------
    const isTypingTarget = (el) => {
      if(!el) return false;
      const tag = (el.tagName||"").toLowerCase();
      return tag === "input" || tag === "textarea" || tag === "select" || el.isContentEditable;
    };

    // Spotlight (Ctrl+K)
    const Spotlight = (() => {
      const overlay = $("#spotlightOverlay");
      const input = $("#spotInput");
      const results = $("#spotResults");
      let items = [];
      let active = 0;

      const close = () => {
        overlay.classList.add("hidden");
        overlay.setAttribute("aria-hidden","true");
      };

      const open = (prefill="") => {
        overlay.classList.remove("hidden");
        overlay.setAttribute("aria-hidden","false");
        input.value = prefill;
        active = 0;
        render();
        setTimeout(() => input.focus(), 0);
      };

      const isOpen = () => !overlay.classList.contains("hidden");

      const getCandidates = () => {
        const installed = new Set(State.installedApps || []);
        return Object.values(AppRegistry).filter(a => installed.has(a.id));
      };

      const render = () => {
        const q = (input.value || "").trim().toLowerCase();
        const apps = getCandidates()
          .filter(a => !q || a.name().toLowerCase().includes(q) || a.id.includes(q))
          .slice(0, 12);

        items = apps.map(a => ({type:"app", id:a.id, label:a.name(), icon:a.icon}));

        if(items.length === 0){
          results.innerHTML = `<div class="hint">${safeText(t("no_results"))}</div>`;
          return;
        }

        results.innerHTML = `
          <div class="miniList">
            ${items.map((it,i)=>`
              <div class="miniItem" data-i="${i}" style="${i===active?'background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.16);':''}">
                <div class="left">
                  <span class="badge">${it.icon}</span>
                  <div style="min-width:0;">
                    <div class="title">${safeText(it.label)}</div>
                    <div class="sub">${safeText(it.id)}</div>
                  </div>
                </div>
              </div>
            `).join("")}
          </div>
        `;

        $$("#spotResults .miniItem").forEach(row => {
          row.addEventListener("click", () => {
            const i = parseInt(row.getAttribute("data-i"));
            activate(i);
          });
        });
      };

      const activate = (i) => {
        const it = items[i];
        if(!it) return;
        close();
        if(it.type === "app") openApp(it.id);
      };

      input.addEventListener("input", render);
      input.addEventListener("keydown", (e) => {
        if(e.key === "Escape"){
          e.stopPropagation();
          close();
        }
        if(e.key === "ArrowDown"){
          e.preventDefault();
          active = Math.min(items.length-1, active+1);
          render();
        }
        if(e.key === "ArrowUp"){
          e.preventDefault();
          active = Math.max(0, active-1);
          render();
        }
        if(e.key === "Enter"){
          e.preventDefault();
          activate(active);
        }
      });

      overlay.addEventListener("mousedown", (e) => {
        if(e.target === overlay) close();
      });

      return { open, close, isOpen };
    })();

    // Task switcher (Ctrl+`), browser-safe
    const TaskSwitcher = (() => {
      const overlay = $("#altTabOverlay");
      let list = [];
      let index = 0;
      let timer = null;

      const hide = (focusSelected=true) => {
        overlay.classList.add("hidden");
        overlay.setAttribute("aria-hidden","true");
        if(timer){ clearTimeout(timer); timer = null; }

        if(focusSelected && list.length){
          const w = list[index];
          if(w && w.el.classList.contains("minimized")) w.el.classList.remove("minimized");
          if(w) WM.focus(w.id);
        }
      };

      const show = (dir=1) => {
        list = WM.listWindows({current:true, includeMinimized:true});
        if(list.length === 0){
          toast(t("no_windows"), "bad");
          return;
        }
        index = (index + dir + list.length) % list.length;
        overlay.classList.remove("hidden");
        overlay.setAttribute("aria-hidden","false");
        overlay.innerHTML = `
          <div class="altTabStrip">
            ${list.map((w,i)=>`
              <div class="altItem ${i===index?'active':''}">
                <div class="top">
                  <span class="badge">${(AppRegistry[w.appId]?.icon)||Icons.info}</span>
                  <div class="name">${safeText(w.title)}</div>
                </div>
                <div class="sub">${safeText(AppRegistry[w.appId]?.name() || w.appId)}</div>
              </div>
            `).join("")}
          </div>
        `;
        // auto hide shortly after last press
        if(timer) clearTimeout(timer);
        timer = setTimeout(() => hide(true), 900);
      };

      return { show, hide };
    })();

    // Screenshot (downloads PNG). Works on browsers that support getDisplayMedia.
    async function takeScreenshot(){
      try{
        if(!navigator.mediaDevices?.getDisplayMedia){
          toast(t("screenshot_fail"), "bad");
          return;
        }
        const stream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:false});
        const video = document.createElement("video");
        video.srcObject = stream;
        await video.play();

        await new Promise(r => setTimeout(r, 150));
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth || 1280;
        canvas.height = video.videoHeight || 720;
        canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);

        stream.getTracks().forEach(t => t.stop());

        const ts = new Date();
        const pad2 = (n) => String(n).padStart(2,"0");
        const name = `Screenshot_${ts.getFullYear()}-${pad2(ts.getMonth()+1)}-${pad2(ts.getDate())}_${pad2(ts.getHours())}-${pad2(ts.getMinutes())}-${pad2(ts.getSeconds())}.png`;

        canvas.toBlob((blob) => {
          if(!blob){ toast(t("screenshot_fail"), "bad"); return; }
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = name;
          document.body.appendChild(a);
          a.click();
          a.remove();
          setTimeout(() => URL.revokeObjectURL(url), 2000);
          toast(t("screenshot_ok"), "good");
        }, "image/png");
      }catch(e){
        console.warn(e);
        toast(t("screenshot_fail"), "bad");
      }
    }

    // Desktop context menu
    const CtxMenu = (() => {
      const menu = $("#ctxMenu");
      const hide = () => {
        menu.classList.add("hidden");
        menu.setAttribute("aria-hidden","true");
      };
      const show = (x,y,items) => {
        const maxW = 260;
        menu.innerHTML = items.map(it => {
          if(it === null) return `<div class="ctxSep"></div>`;
          return `<button class="ctxItem" data-id="${it.id}">
            <span class="badge">${it.icon||""}</span>
            <span>${safeText(it.label)}</span>
          </button>`;
        }).join("");
        menu.style.left = Math.min(window.innerWidth - maxW - 10, x) + "px";
        menu.style.top = Math.min(window.innerHeight - 10, y) + "px";
        menu.classList.remove("hidden");
        menu.setAttribute("aria-hidden","false");

        $$("#ctxMenu .ctxItem").forEach(btn => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            const it = items.find(x => x && x.id === id);
            hide();
            if(it?.onClick) it.onClick();
          });
        });
      };
      document.addEventListener("mousedown", (e) => {
        if(!menu.classList.contains("hidden") && !e.target.closest("#ctxMenu")) hide();
      }, {passive:true});
      document.addEventListener("contextmenu", (e) => {
        // allow our custom menu on workspace; otherwise hide when user right-clicks elsewhere
        if(!e.target.closest("#workspace")) hide();
      });
      return { show, hide };
    })();

    $("#workspace").addEventListener("contextmenu", (e) => {
      e.preventDefault();
      CtxMenu.show(e.clientX, e.clientY, [
        {id:"files", label: t("file_manager"), icon: Icons.folder, onClick: () => openApp("fileman")},
        {id:"term", label: t("terminal"), icon: Icons.term, onClick: () => openApp("terminal")},
        {id:"office", label: t("officepro"), icon: Icons.doc, onClick: () => openApp("officepro")},
        null,
        {id:"switch", label: t("task_switcher"), icon: Icons.apps, onClick: () => TaskSwitcher.show(1)},
        {id:"desk", label: t("desktops"), icon: Icons.desk, onClick: () => showDesktopPicker()},
        null,
        {id:"shot", label: t("screenshot"), icon: Icons.camera, onClick: () => takeScreenshot()},
        {id:"sett", label: t("settings"), icon: Icons.settings, onClick: () => openApp("settings")},
        null,
        {id:"reload", label: t("reset"), icon: Icons.power, onClick: () => location.reload()}
      ]);
    });

    // Keyboard shortcuts
    window.addEventListener("keydown", (e) => {
      // Esc closes overlays
      if(e.key === "Escape"){
        if(Spotlight.isOpen()) Spotlight.close();
        CtxMenu.hide();
        const menu = $("#startMenu");
        if(!menu.classList.contains("hidden")) toggleStartMenu(false);
        return;
      }

      const typing = isTypingTarget(e.target);

      // Search / Spotlight
      if(!typing && e.ctrlKey && !e.shiftKey && !e.altKey && e.key.toLowerCase() === "k"){
        e.preventDefault();
        toggleStartMenu(false);
        Spotlight.open("");
        return;
      }

      // Desktop switching
      if(!typing && e.ctrlKey && e.altKey && (e.key === "ArrowRight" || e.key === "ArrowLeft")){
        e.preventDefault();
        if(e.key === "ArrowRight") WM.nextDesktop();
        else WM.prevDesktop();
        return;
      }

      // Keyboard snapping (Ctrl+Shift+Arrows)
      if(!typing && e.ctrlKey && e.shiftKey && (e.key === "ArrowLeft" || e.key === "ArrowRight" || e.key === "ArrowUp")){
        e.preventDefault();
        if(e.key === "ArrowLeft") WM.snapActive("left");
        if(e.key === "ArrowRight") WM.snapActive("right");
        if(e.key === "ArrowUp") WM.snapActive("up");
        return;
      }

      // Task switcher (Ctrl+`)
      if(!typing && e.ctrlKey && e.code === "Backquote"){
        e.preventDefault();
        TaskSwitcher.show(e.shiftKey ? -1 : 1);
        return;
      }
    });

    // Keep things tidy on resize
    window.addEventListener("resize", () => {
      toggleStartMenu(false);
      if(Spotlight.isOpen()) Spotlight.close();
      CtxMenu.hide();
    });


  })();
  </script>
</body>
</html>
